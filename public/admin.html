<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AskOzzy â€” Super Admin Portal</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#0f1117" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#f5f3ef" media="(prefers-color-scheme: light)" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="AskOzzy" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/admin.css" />
  <link rel="icon" href="/icons/icon.svg" type="image/svg+xml" />
</head>
<body>
  <div class="flag-stripe" style="position:fixed;top:0;left:0;right:0;z-index:999;"></div>

  <!-- Loading screen (shown until auth verified) -->
  <div id="admin-loading" class="admin-loading">
    <div class="spinner" style="width:32px;height:32px;border-width:3px;"></div>
    <p>Verifying admin access...</p>
  </div>

  <!-- Main admin app (hidden until verified) -->
  <div id="admin-app" class="admin-app hidden">

    <!-- Header -->
    <header class="admin-header">
      <div class="admin-header-left">
        <div class="admin-logo-icon"></div>
        <div>
          <h1>AskOzzy <span>Super Admin</span></h1>
        </div>
      </div>
      <div class="admin-header-right">
        <span class="admin-user-name" id="admin-user-name"></span>
        <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
          <div class="theme-toggle-track">
            <span class="theme-toggle-icon-dark">&#x1F319;</span>
            <span class="theme-toggle-icon-light">&#x2600;&#xFE0F;</span>
            <div class="theme-toggle-thumb"></div>
          </div>
        </button>
        <a href="/" class="admin-back-link">Back to App</a>
        <button class="btn-admin-logout" onclick="adminLogout()">Sign Out</button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="admin-tabs" id="admin-tabs">
      <button class="admin-tab active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="admin-tab" data-tab="users" onclick="switchTab('users')">Users</button>
      <button class="admin-tab" data-tab="conversations" onclick="switchTab('conversations')">Conversations</button>
      <button class="admin-tab" data-tab="analytics" onclick="switchTab('analytics')">Analytics</button>
      <button class="admin-tab" data-tab="referrals" onclick="switchTab('referrals')">Referrals</button>
      <button class="admin-tab" data-tab="system" onclick="switchTab('system')">System</button>
      <button class="admin-tab" data-tab="announcements" onclick="switchTab('announcements')">Announcements</button>
      <button class="admin-tab" data-tab="moderation" onclick="switchTab('moderation')">Moderation</button>
      <button class="admin-tab" data-tab="audit-log" onclick="switchTab('audit-log')">Audit Log</button>
      <button class="admin-tab" data-tab="knowledge" onclick="switchTab('knowledge')">Knowledge Base</button>
      <button class="admin-tab" data-tab="bulk-import" onclick="switchTab('bulk-import')">Bulk Import</button>
      <button class="admin-tab" data-tab="document-training" onclick="switchTab('document-training')">Document Training</button>
      <button class="admin-tab" data-tab="agents" onclick="switchTab('agents')">AI Agents</button>
      <button class="admin-tab" data-tab="productivity" onclick="switchTab('productivity')">Productivity</button>
      <button class="admin-tab" data-tab="ussd" onclick="switchTab('ussd')">USSD</button>
      <button class="admin-tab" data-tab="messaging" onclick="switchTab('messaging')">Messaging</button>
    </nav>

    <!-- Tab Panels -->
    <div class="admin-content">

      <!-- Dashboard -->
      <div class="admin-tab-panel active" id="panel-dashboard">
        <div id="dashboard-content"><div class="admin-loader"><div class="spinner"></div></div></div>
      </div>

      <!-- Users -->
      <div class="admin-tab-panel" id="panel-users">
        <div class="admin-toolbar">
          <input type="text" id="user-search" class="admin-search" placeholder="Search by name or email..." oninput="debouncedUserSearch()" />
          <span class="admin-count" id="user-count"></span>
        </div>
        <div id="users-content"><div class="admin-loader"><div class="spinner"></div></div></div>
        <div id="users-pagination" class="pagination"></div>
      </div>

      <!-- Conversations -->
      <div class="admin-tab-panel" id="panel-conversations">
        <div id="conversations-content"><div class="admin-loader"><div class="spinner"></div></div></div>
        <div id="conversations-pagination" class="pagination"></div>
      </div>

      <!-- Analytics -->
      <div class="admin-tab-panel" id="panel-analytics">
        <div id="analytics-content"><div class="admin-loader"><div class="spinner"></div></div></div>
      </div>

      <!-- Referrals -->
      <div class="admin-tab-panel" id="panel-referrals">
        <div id="referrals-content"><div class="admin-loader"><div class="spinner"></div></div></div>
      </div>

      <!-- System -->
      <div class="admin-tab-panel" id="panel-system">
        <div id="system-content">
          <div class="admin-row">
            <div class="admin-card">
              <h3>Platform Configuration</h3>
              <table class="admin-table">
                <tbody>
                  <tr><td>Platform</td><td>AskOzzy</td></tr>
                  <tr><td>Backend</td><td>Cloudflare Workers (Hono)</td></tr>
                  <tr><td>AI Provider</td><td>Cloudflare Workers AI</td></tr>
                  <tr><td>Database</td><td>Cloudflare D1 (SQLite)</td></tr>
                  <tr><td>Sessions</td><td>Cloudflare KV</td></tr>
                  <tr><td>Pricing Tiers</td><td>Free, Starter (GHS 30), Professional (GHS 60), Enterprise (GHS 100)</td></tr>
                  <tr><td>AI Models</td><td>10 models (3 free, 7 premium)</td></tr>
                </tbody>
              </table>
            </div>
            <div class="admin-card">
              <h3>Quick Actions</h3>
              <div style="margin-bottom:16px;">
                <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px;">Promote User to Super Admin</label>
                <div style="display:flex;gap:8px;">
                  <input type="email" id="promote-email" placeholder="user@email.com" style="flex:1;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:14px;outline:none;" />
                  <button class="btn-action" onclick="promoteUser()">Promote</button>
                </div>
                <div id="promote-result" style="margin-top:8px;font-size:12px;"></div>
              </div>
            </div>
          </div>
          <div class="admin-row">
            <div class="admin-card">
              <h3>Data Export</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn-action export-btn" onclick="exportCSV('users')">Export Users CSV</button>
                <button class="btn-action export-btn" onclick="exportCSV('analytics')">Export Analytics CSV</button>
              </div>
            </div>
            <div class="admin-card">
              <h3>Rate Limiting</h3>
              <div id="rate-limits-content"><div class="admin-loader"><div class="spinner"></div></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Announcements -->
      <div class="admin-tab-panel" id="panel-announcements">
        <div class="admin-card announcement-form" style="margin-bottom:24px;">
          <h3>Create Announcement</h3>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <input type="text" id="announce-title" placeholder="Announcement title" class="admin-search" style="max-width:100%;" />
            <textarea id="announce-content" placeholder="Announcement content..." rows="3" style="padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;font-family:inherit;resize:vertical;outline:none;"></textarea>
            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
              <select id="announce-type" class="inline-select" style="padding:8px 12px;">
                <option value="info">Info</option>
                <option value="warning">Warning</option>
                <option value="success">Success</option>
                <option value="maintenance">Maintenance</option>
              </select>
              <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text-secondary);cursor:pointer;">
                <input type="checkbox" id="announce-dismissible" checked /> Dismissible
              </label>
              <label style="font-size:12px;color:var(--text-muted);">Expires:
                <input type="date" id="announce-expires" style="padding:6px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:12px;font-family:inherit;outline:none;margin-left:4px;" />
              </label>
              <button class="btn-action primary" onclick="createAnnouncement()">Publish</button>
            </div>
            <div id="announce-result" style="font-size:12px;"></div>
          </div>
        </div>
        <div id="announcements-content"><div class="admin-loader"><div class="spinner"></div></div></div>
      </div>

      <!-- Moderation -->
      <div class="admin-tab-panel" id="panel-moderation">
        <div id="moderation-stats" style="margin-bottom:24px;"></div>
        <div class="moderation-status-tabs" id="moderation-status-tabs">
          <button class="mod-tab active" data-status="pending" onclick="switchModerationStatus('pending')">Pending</button>
          <button class="mod-tab" data-status="reviewed" onclick="switchModerationStatus('reviewed')">Reviewed</button>
          <button class="mod-tab" data-status="dismissed" onclick="switchModerationStatus('dismissed')">Dismissed</button>
        </div>
        <div id="moderation-content"><div class="admin-loader"><div class="spinner"></div></div></div>
      </div>

      <!-- Audit Log -->
      <div class="admin-tab-panel" id="panel-audit-log">
        <!-- Stats Cards -->
        <div id="audit-stats" style="margin-bottom:20px;"><div class="admin-loader"><div class="spinner"></div></div></div>

        <!-- Filter Bar -->
        <div class="admin-toolbar" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px;">
          <input type="date" id="audit-date-from" class="admin-search" style="max-width:160px;padding:8px 10px;font-size:12px;" title="From date" />
          <input type="date" id="audit-date-to" class="admin-search" style="max-width:160px;padding:8px 10px;font-size:12px;" title="To date" />
          <select id="audit-action-filter" class="inline-select" style="padding:8px 12px;font-size:12px;" onchange="loadAuditLog(1)">
            <option value="">All Actions</option>
            <option value="chat">Chat</option>
            <option value="research">Research</option>
            <option value="analyze">Analyze</option>
            <option value="vision">Vision</option>
            <option value="workflow_step">Workflow</option>
            <option value="meeting_transcribe">Meeting</option>
          </select>
          <input type="text" id="audit-search" class="admin-search" placeholder="Search email, query, department..." style="flex:1;min-width:180px;" oninput="debouncedAuditSearch()" />
          <button class="btn-action" onclick="loadAuditLog(1)">Filter</button>
          <button class="btn-action" onclick="exportAuditCSV()">Export CSV</button>
        </div>

        <!-- Table -->
        <div id="audit-log-content"><div class="admin-loader"><div class="spinner"></div></div></div>
        <div id="audit-log-pagination" class="pagination"></div>
      </div>

      <!-- Knowledge Base -->
      <div class="admin-tab-panel" id="panel-knowledge">
        <!-- Stats Cards -->
        <div id="kb-stats"><div class="admin-loader"><div class="spinner"></div></div></div>

        <!-- Sub-tabs: Documents / FAQ -->
        <div class="moderation-status-tabs" id="kb-sub-tabs" style="margin-bottom:20px;">
          <button class="mod-tab active" data-kbtab="documents" onclick="switchKbTab('documents')">Documents</button>
          <button class="mod-tab" data-kbtab="faq" onclick="switchKbTab('faq')">FAQ Entries</button>
        </div>

        <!-- Documents Sub-panel -->
        <div id="kb-documents-panel">
          <div class="admin-card" style="margin-bottom:24px;">
            <h3>Upload Document</h3>
            <div style="display:flex;flex-direction:column;gap:12px;">
              <input type="text" id="doc-title" placeholder="Document title (e.g., Public Procurement Act Summary)" class="admin-search" style="max-width:100%;" />
              <input type="text" id="doc-source" placeholder="Source (e.g., PPA, Ministry of Finance)" class="admin-search" style="max-width:100%;" />
              <select id="doc-category" class="inline-select" style="padding:8px 12px;width:fit-content;">
                <option value="general">General</option>
                <option value="procurement">Procurement</option>
                <option value="finance">Finance & Budget</option>
                <option value="hr">Human Resources</option>
                <option value="legal">Legal & Regulations</option>
                <option value="ict">ICT & Digital</option>
                <option value="health">Health</option>
                <option value="education">Education</option>
                <option value="governance">Governance</option>
              </select>
              <div style="position:relative;">
                <textarea id="doc-content" placeholder="Paste the full document content here..." rows="8" style="width:100%;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;font-family:inherit;resize:vertical;outline:none;box-sizing:border-box;" oninput="updateDocCharCount()"></textarea>
                <span id="doc-char-count" style="position:absolute;bottom:8px;right:12px;font-size:10px;color:var(--text-muted);">0 / 100,000</span>
              </div>
              <div style="display:flex;gap:12px;align-items:center;">
                <button class="btn-action primary" onclick="uploadDocument()">Upload & Process</button>
                <span id="doc-upload-result" style="font-size:12px;"></span>
              </div>
            </div>
          </div>
          <div id="documents-content"><div class="admin-loader"><div class="spinner"></div></div></div>
          <div id="documents-pagination" class="pagination"></div>
        </div>

        <!-- FAQ Sub-panel -->
        <div id="kb-faq-panel" style="display:none;">
          <div class="admin-card" style="margin-bottom:24px;">
            <h3>Create FAQ Entry</h3>
            <div style="display:flex;flex-direction:column;gap:12px;">
              <select id="faq-category" class="inline-select" style="padding:8px 12px;width:fit-content;">
                <option value="general">General</option>
                <option value="procurement">Procurement</option>
                <option value="finance">Finance & Budget</option>
                <option value="hr">Human Resources</option>
                <option value="legal">Legal & Regulations</option>
                <option value="ict">ICT & Digital</option>
                <option value="health">Health</option>
                <option value="education">Education</option>
                <option value="governance">Governance</option>
              </select>
              <input type="text" id="faq-question" placeholder="Question (e.g., What is the procurement threshold for goods?)" class="admin-search" style="max-width:100%;" />
              <textarea id="faq-answer" placeholder="Answer..." rows="4" style="width:100%;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;font-family:inherit;resize:vertical;outline:none;box-sizing:border-box;"></textarea>
              <input type="text" id="faq-keywords" placeholder="Keywords (comma-separated, e.g., procurement, threshold, goods, tender)" class="admin-search" style="max-width:100%;" />
              <div style="display:flex;gap:12px;align-items:center;">
                <label style="font-size:12px;color:var(--text-secondary);">Priority:
                  <input type="number" id="faq-priority" value="0" min="0" max="100" style="width:60px;padding:6px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:12px;font-family:inherit;outline:none;margin-left:4px;" />
                </label>
                <button class="btn-action primary" onclick="createFaqEntry()">Create FAQ</button>
                <span id="faq-create-result" style="font-size:12px;"></span>
              </div>
            </div>
          </div>
          <div id="faq-content"><div class="admin-loader"><div class="spinner"></div></div></div>
          <div id="faq-pagination" class="pagination"></div>
        </div>
      </div>

      <!-- Bulk Import & Department Onboarding -->
      <div class="admin-tab-panel" id="panel-bulk-import">

        <!-- Department Stats Dashboard -->
        <div id="dept-stats-section" style="margin-bottom:24px;">
          <div id="dept-stats-content"><div class="admin-loader"><div class="spinner"></div></div></div>
        </div>

        <!-- Bulk Import Card -->
        <div class="admin-card" style="margin-bottom:24px;">
          <h3>Bulk Import Users</h3>
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Upload a CSV file or paste user data to create multiple accounts at once. Maximum 500 users per batch.</p>

          <!-- CSV Format Guide -->
          <div style="background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:16px;">
            <div style="font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.3px;margin-bottom:8px;">CSV Format Guide</div>
            <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
              <div>Required columns: <code style="background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--gold);">full_name</code>, <code style="background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--gold);">email</code></div>
              <div>Optional columns: <code style="background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary);">department</code>, <code style="background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary);">tier</code> (free/starter/professional/enterprise)</div>
              <div style="margin-top:6px;font-family:monospace;font-size:11px;background:var(--bg-primary);padding:8px 10px;border-radius:4px;overflow-x:auto;">
                full_name,email,department,tier<br>
                Kwame Asante,kwame@gov.gh,Ministry of Finance,free<br>
                Ama Mensah,ama@gov.gh,Ministry of Health,starter
              </div>
            </div>
          </div>

          <!-- Drag & Drop Upload Area -->
          <div style="display:flex;gap:16px;margin-bottom:16px;">
            <div style="flex:1;">
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px;">Upload CSV File</label>
              <div id="bulk-drop-zone" style="border:2px dashed var(--border-color);border-radius:var(--radius-sm);padding:24px;text-align:center;cursor:pointer;transition:border-color 0.2s, background 0.2s;background:var(--bg-tertiary);" onclick="document.getElementById('bulk-csv-file').click()" ondragover="event.preventDefault();this.style.borderColor='var(--gold)';this.style.background='var(--bg-primary)';" ondragleave="this.style.borderColor='var(--border-color)';this.style.background='var(--bg-tertiary)';" ondrop="event.preventDefault();this.style.borderColor='var(--border-color)';this.style.background='var(--bg-tertiary)';handleBulkFileDrop(event);">
                <div style="font-size:28px;margin-bottom:8px;opacity:0.5;">&#128196;</div>
                <div style="font-size:13px;color:var(--text-secondary);font-weight:500;">Drag & drop a CSV file here</div>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">or click to browse</div>
                <div id="bulk-file-name" style="font-size:12px;color:var(--gold);margin-top:8px;font-weight:600;display:none;"></div>
              </div>
              <input type="file" id="bulk-csv-file" accept=".csv" onchange="parseBulkCSV()" style="display:none;" />
            </div>
            <div style="flex:1;">
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px;">Default Tier</label>
              <select id="bulk-tier" class="inline-select" style="padding:8px 12px;">
                <option value="free">Free</option>
                <option value="starter">Starter</option>
                <option value="professional">Professional</option>
                <option value="enterprise">Enterprise</option>
              </select>
              <div style="font-size:10px;color:var(--text-muted);margin-top:8px;">If the CSV has a <code>tier</code> column, individual rows override this default.</div>
            </div>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px;">Or Paste User Data (one per line: email, full_name, department)</label>
            <textarea id="bulk-paste" rows="6" placeholder="kwame@gov.gh, Kwame Asante, Ministry of Finance&#10;ama@gov.gh, Ama Mensah, Ministry of Health" style="width:100%;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;font-family:monospace;resize:vertical;outline:none;box-sizing:border-box;"></textarea>
          </div>

          <div id="bulk-preview" style="margin-bottom:16px;display:none;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px;">Preview (<span id="bulk-count">0</span> users)</label>
            <div id="bulk-preview-table" style="max-height:200px;overflow-y:auto;"></div>
          </div>

          <div style="display:flex;gap:12px;align-items:center;">
            <button class="btn-action primary" id="btn-bulk-import" onclick="executeBulkImport()" disabled>Import Users</button>
            <button class="btn-action" id="btn-bulk-csv-import" onclick="executeBulkCSVImport()" style="display:none;">Upload CSV to Server</button>
            <span id="bulk-result" style="font-size:12px;"></span>
          </div>
        </div>

        <div id="bulk-results-content" style="display:none;">
          <div class="admin-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h3>Import Results</h3>
              <button class="btn-action" id="btn-download-codes" onclick="downloadAccessCodesCSV()" style="display:none;">Download Access Codes CSV</button>
            </div>
            <div id="bulk-results-summary" style="margin-bottom:12px;"></div>
            <div id="bulk-results-table"></div>
          </div>
        </div>
      </div>

      <!-- Document Training (Enhanced) -->
      <div class="admin-tab-panel" id="panel-document-training">

        <!-- Stats Dashboard -->
        <div id="dt-stats-dashboard" style="margin-bottom:24px;">
          <div class="admin-loader"><div class="spinner"></div></div>
        </div>

        <!-- GoG Document Library -->
        <div class="admin-card" style="margin-bottom:24px;">
          <h3>GoG Document Library</h3>
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Recommended Government of Ghana documents to upload for comprehensive AI training. This checklist helps ensure Ozzy has access to all key regulatory documents.</p>
          <div id="gog-library-content"><div class="admin-loader"><div class="spinner"></div></div></div>
        </div>

        <!-- Bulk Upload Section -->
        <div class="admin-card" style="margin-bottom:24px;">
          <h3>Bulk Document Upload</h3>
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Drag and drop or select multiple files at once. Categories are auto-detected from filenames but can be overridden. Supports: .txt, .csv, .md, .docx, .pptx, .doc, .json, .html</p>

          <div id="bulk-drop-zone" style="border:2px dashed var(--border-color);border-radius:var(--radius-md);padding:40px 20px;text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:16px;background:var(--bg-tertiary);"
               ondragover="event.preventDefault();this.style.borderColor='var(--gold)';this.style.background='rgba(218,165,32,0.05)';"
               ondragleave="this.style.borderColor='var(--border-color)';this.style.background='var(--bg-tertiary)';"
               ondrop="handleBulkDrop(event)"
               onclick="document.getElementById('bulk-file-input').click()">
            <div style="font-size:36px;margin-bottom:8px;opacity:0.5;">+</div>
            <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:4px;">Drop files here or click to browse</div>
            <div style="font-size:11px;color:var(--text-muted);">Select multiple files â€” up to 50 files per batch</div>
          </div>
          <input type="file" id="bulk-file-input" multiple style="display:none;" onchange="handleBulkFileSelect(this.files)" />

          <!-- File list preview with category overrides -->
          <div id="bulk-file-list" style="display:none;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <span style="font-size:13px;font-weight:600;color:var(--text-primary);">Files to Upload</span>
              <button class="btn-action" onclick="clearBulkFiles()" style="font-size:11px;padding:4px 10px;">Clear All</button>
            </div>
            <div id="bulk-file-table-wrapper" style="max-height:300px;overflow-y:auto;">
            </div>
          </div>

          <div style="display:flex;gap:12px;align-items:center;">
            <button class="btn-action primary" id="btn-bulk-upload" onclick="executeBulkUpload()" style="display:none;">Upload All Files</button>
            <span id="bulk-upload-result" style="font-size:12px;"></span>
          </div>
          <div id="bulk-upload-detail" style="margin-top:12px;"></div>
        </div>

        <!-- Single Document Upload -->
        <div class="admin-card" style="margin-bottom:24px;">
          <h3>Train AI on Government Documents</h3>
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Upload individual documents or paste content directly.</p>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Document Title</label>
              <input type="text" id="train-doc-title" placeholder="e.g., Public Procurement Act 2003 Summary" class="admin-search" style="max-width:100%;" />
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Source / Author</label>
              <input type="text" id="train-doc-source" placeholder="e.g., PPA, Ministry of Finance" class="admin-search" style="max-width:100%;" />
            </div>
          </div>

          <div style="display:flex;gap:16px;margin-bottom:16px;">
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Category</label>
              <select id="train-doc-category" class="inline-select" style="padding:8px 12px;">
                <option value="general">General</option>
                <option value="procurement">Procurement</option>
                <option value="procurement_law">Procurement Law</option>
                <option value="finance">Finance & Budget</option>
                <option value="financial_admin">Financial Administration</option>
                <option value="hr">Human Resources</option>
                <option value="legal">Legal & Regulations</option>
                <option value="civil_service">Civil Service</option>
                <option value="budget_policy">Budget Policy</option>
                <option value="gog_forms">GoG Forms</option>
                <option value="general_regulation">General Regulation</option>
                <option value="ict">ICT & Digital</option>
                <option value="health">Health</option>
                <option value="education">Education</option>
                <option value="governance">Governance</option>
              </select>
            </div>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Upload File(s)</label>
            <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
              <div>
                <input type="file" id="train-doc-file" multiple style="padding:8px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;" />
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Select one or more files (text-based formats)</div>
              </div>
              <div style="text-align:center;color:var(--text-muted);font-size:11px;font-weight:600;">OR</div>
              <div>
                <input type="file" id="train-doc-folder" webkitdirectory directory multiple style="padding:8px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;" />
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Upload an entire folder of documents</div>
              </div>
            </div>
            <div id="train-file-preview" style="margin-top:8px;font-size:11px;color:var(--text-secondary);"></div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">Or paste content directly below (for single documents)</div>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Or Paste Document Content</label>
            <textarea id="train-doc-content" placeholder="Paste the full document content here..." rows="10" style="width:100%;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;font-family:inherit;resize:vertical;outline:none;box-sizing:border-box;" oninput="updateTrainCharCount()"></textarea>
            <span id="train-char-count" style="font-size:10px;color:var(--text-muted);">0 / 200,000</span>
          </div>

          <div style="display:flex;gap:12px;align-items:center;">
            <button class="btn-action primary" onclick="trainDocument()">Upload &amp; Train AI</button>
            <span id="train-result" style="font-size:12px;"></span>
          </div>
        </div>

        <!-- URL Scraping Card -->
        <div class="admin-card" style="margin-bottom:24px;">
          <h3>Train from Website URLs</h3>
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Scrape content from government websites, policy pages, or any public URL. The AI will extract the text and use it for training.</p>

          <div style="margin-bottom:16px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Website URL(s) â€” one per line</label>
            <textarea id="scrape-urls" placeholder="https://mofep.gov.gh/publications/budget-statement&#10;https://ppaghana.org/about&#10;https://example.gov.gh/policy-document" rows="4" style="width:100%;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;font-family:inherit;resize:vertical;outline:none;box-sizing:border-box;"></textarea>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Enter up to 20 URLs. Each page will be scraped and trained as a separate document.</div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Title (optional â€” auto-detected from page)</label>
              <input type="text" id="scrape-title" placeholder="Leave blank to use page title" class="admin-search" style="max-width:100%;" />
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Source / Author</label>
              <input type="text" id="scrape-source" placeholder="e.g., Ministry of Finance" class="admin-search" style="max-width:100%;" />
            </div>
          </div>

          <div style="display:flex;gap:16px;align-items:center;margin-bottom:16px;">
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Category</label>
              <select id="scrape-category" class="inline-select" style="padding:8px 12px;">
                <option value="general">General</option>
                <option value="procurement">Procurement</option>
                <option value="finance">Finance & Budget</option>
                <option value="hr">Human Resources</option>
                <option value="legal">Legal & Regulations</option>
                <option value="ict">ICT & Digital</option>
                <option value="health">Health</option>
                <option value="education">Education</option>
                <option value="governance">Governance</option>
              </select>
            </div>
            <div style="display:flex;align-items:center;gap:6px;margin-top:18px;">
              <input type="checkbox" id="scrape-follow-links" style="accent-color:var(--gold);" />
              <label for="scrape-follow-links" style="font-size:12px;color:var(--text-secondary);cursor:pointer;">Follow links on page (scrape linked pages on same domain, max 10)</label>
            </div>
          </div>

          <div style="display:flex;gap:12px;align-items:center;">
            <button class="btn-action primary" onclick="trainFromURLs()">Scrape &amp; Train AI</button>
            <span id="scrape-result" style="font-size:12px;"></span>
          </div>
          <div id="scrape-results-detail" style="margin-top:12px;"></div>
        </div>

        <!-- Enhanced Training Status with search/filter -->
        <div class="admin-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3>Trained Documents</h3>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="text" id="dt-search" placeholder="Search by title..." class="admin-search" style="max-width:200px;padding:6px 10px;font-size:12px;" oninput="debouncedDtSearch()" />
              <select id="dt-category-filter" class="inline-select" style="padding:6px 10px;font-size:12px;" onchange="loadEnhancedTrainingStatus()">
                <option value="">All Categories</option>
                <option value="general">General</option>
                <option value="procurement">Procurement</option>
                <option value="procurement_law">Procurement Law</option>
                <option value="finance">Finance & Budget</option>
                <option value="financial_admin">Financial Admin</option>
                <option value="hr">Human Resources</option>
                <option value="legal">Legal & Regulations</option>
                <option value="civil_service">Civil Service</option>
                <option value="budget_policy">Budget Policy</option>
                <option value="gog_forms">GoG Forms</option>
                <option value="general_regulation">General Regulation</option>
                <option value="ict">ICT & Digital</option>
                <option value="health">Health</option>
                <option value="education">Education</option>
                <option value="governance">Governance</option>
              </select>
            </div>
          </div>
          <div id="training-status-content"><div class="admin-loader"><div class="spinner"></div></div></div>
          <div id="dt-pagination" class="pagination"></div>
        </div>
      </div>

      <div class="admin-tab-panel" id="panel-agents">
        <div class="admin-card" style="margin-bottom:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div>
              <h3>Custom AI Agents</h3>
              <p style="font-size:12px;color:var(--text-muted);margin:4px 0 0;">Create specialized AI assistants for different departments and tasks</p>
            </div>
            <button class="btn-action primary" onclick="openAgentForm()">+ New Agent</button>
          </div>
          <div id="agents-list-content"><div class="admin-loader"><div class="spinner"></div></div></div>
        </div>

        <!-- Agent Form (hidden by default) -->
        <div class="admin-card" id="agent-form-card" style="display:none;">
          <h3 id="agent-form-title">Create New Agent</h3>
          <input type="hidden" id="agent-form-id" />

          <div style="display:grid;grid-template-columns:auto 1fr;gap:16px;margin-bottom:16px;align-items:start;">
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Icon</label>
              <input type="text" id="agent-icon" value="ðŸ¤–" style="width:60px;text-align:center;font-size:24px;padding:8px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);" />
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Agent Name</label>
              <input type="text" id="agent-name" placeholder="e.g., Procurement Agent" class="admin-search" style="max-width:100%;" />
            </div>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Description (shown to users)</label>
            <input type="text" id="agent-description" placeholder="e.g., Specialist in public procurement procedures and regulations" class="admin-search" style="max-width:100%;" />
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Department / MDA</label>
              <input type="text" id="agent-department" placeholder="e.g., Public Procurement Authority" class="admin-search" style="max-width:100%;" />
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Knowledge Category (optional)</label>
              <select id="agent-knowledge-cat" class="inline-select" style="padding:8px 12px;width:100%;">
                <option value="">All categories</option>
                <option value="procurement">Procurement</option>
                <option value="finance">Finance & Budget</option>
                <option value="hr">Human Resources</option>
                <option value="legal">Legal & Regulations</option>
                <option value="ict">ICT & Digital</option>
                <option value="health">Health</option>
                <option value="education">Education</option>
                <option value="governance">Governance</option>
                <option value="general">General</option>
              </select>
            </div>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">System Prompt (instructions for the AI)</label>
            <textarea id="agent-system-prompt" rows="8" placeholder="You are a specialist procurement assistant for the Government of Ghana. You help civil servants with procurement procedures, tender processes, contract management, and compliance with the Public Procurement Act 2003 (Act 663) as amended. Always cite specific sections of the Act when relevant..." style="width:100%;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;font-family:inherit;resize:vertical;outline:none;box-sizing:border-box;"></textarea>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">This prompt defines the agent's personality, expertise, and behavior. Be specific about the domain knowledge and response style.</div>
          </div>

          <div style="display:flex;gap:12px;">
            <button class="btn-action primary" onclick="saveAgent()">Save Agent</button>
            <button class="btn-action" onclick="cancelAgentForm()">Cancel</button>
            <span id="agent-form-result" style="font-size:12px;align-self:center;"></span>
          </div>
        </div>
      </div>

      <!-- Productivity -->
      <div class="admin-tab-panel" id="panel-productivity">
        <div id="productivity-content"><div class="admin-loader"><div class="spinner"></div></div></div>
      </div>

      <!-- USSD -->
      <div class="admin-tab-panel" id="panel-ussd">
        <div id="ussd-content"><div class="admin-loader"><div class="spinner"></div></div></div>
      </div>

      <!-- Messaging (WhatsApp / SMS) -->
      <div class="admin-tab-panel" id="panel-messaging">

        <!-- Config Section -->
        <div class="admin-card" style="margin-bottom:24px;">
          <h3>WhatsApp / SMS Configuration</h3>
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Configure Africa's Talking integration for WhatsApp and SMS messaging. Enable the channels below and paste your API credentials.</p>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <div>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-primary);cursor:pointer;margin-bottom:12px;">
                <input type="checkbox" id="msg-whatsapp-enabled" style="accent-color:var(--gold);width:16px;height:16px;" />
                Enable WhatsApp
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-primary);cursor:pointer;">
                <input type="checkbox" id="msg-sms-enabled" style="accent-color:var(--gold);width:16px;height:16px;" />
                Enable SMS
              </label>
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px;">Sender ID</label>
              <input type="text" id="msg-sender-id" placeholder="AskOzzy" class="admin-search" style="max-width:100%;" />
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px;">API Key (Africa's Talking)</label>
              <input type="password" id="msg-api-key" placeholder="Enter API key..." class="admin-search" style="max-width:100%;" />
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px;">API Username</label>
              <input type="text" id="msg-api-username" placeholder="sandbox or your username" class="admin-search" style="max-width:100%;" />
            </div>
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px;">Webhook Secret</label>
            <input type="text" id="msg-webhook-secret" placeholder="Shared secret for webhook validation (optional)" class="admin-search" style="max-width:100%;" />
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">If set, incoming webhooks must include this value in the X-Webhook-Secret or X-AT-Signature header.</div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);padding:12px 16px;">
            <div>
              <label style="display:block;font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.3px;">WhatsApp Webhook URL</label>
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="text" id="msg-wa-webhook-url" readonly class="admin-search" style="max-width:100%;font-size:11px;font-family:monospace;background:var(--bg-primary);" />
                <button class="btn-action" onclick="copyToClipboard(document.getElementById('msg-wa-webhook-url').value)" style="white-space:nowrap;padding:6px 10px;font-size:11px;">Copy</button>
              </div>
            </div>
            <div>
              <label style="display:block;font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.3px;">SMS Webhook URL</label>
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="text" id="msg-sms-webhook-url" readonly class="admin-search" style="max-width:100%;font-size:11px;font-family:monospace;background:var(--bg-primary);" />
                <button class="btn-action" onclick="copyToClipboard(document.getElementById('msg-sms-webhook-url').value)" style="white-space:nowrap;padding:6px 10px;font-size:11px;">Copy</button>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:12px;align-items:center;">
            <button class="btn-action primary" onclick="saveMessagingConfig()">Save Configuration</button>
            <span id="msg-config-result" style="font-size:12px;"></span>
          </div>
        </div>

        <!-- Stats Section -->
        <div id="messaging-stats" style="margin-bottom:24px;">
          <div class="stats-grid" id="messaging-stats-grid">
            <div class="stat-card"><div class="stat-value" id="msg-stat-sessions">--</div><div class="stat-label">Total Sessions</div></div>
            <div class="stat-card green"><div class="stat-value" id="msg-stat-today">--</div><div class="stat-label">Messages Today</div></div>
            <div class="stat-card"><div class="stat-value" id="msg-stat-week">--</div><div class="stat-label">This Week</div></div>
            <div class="stat-card green"><div class="stat-value" id="msg-stat-active">--</div><div class="stat-label">Active (24h)</div></div>
          </div>
        </div>

        <!-- Webhook Test -->
        <div class="admin-card" style="margin-bottom:24px;">
          <h3>Webhook Test</h3>
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Simulate an inbound message to verify the pipeline works end-to-end. Uses a test phone number (+233000000000).</p>
          <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Test Message</label>
              <input type="text" id="msg-test-input" placeholder="What is the procurement threshold for goods?" class="admin-search" style="max-width:100%;" />
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Channel</label>
              <select id="msg-test-channel" class="inline-select" style="padding:8px 12px;">
                <option value="whatsapp">WhatsApp</option>
                <option value="sms">SMS</option>
              </select>
            </div>
            <button class="btn-action primary" id="btn-msg-test" onclick="testMessagingWebhook()">Send Test</button>
          </div>
          <div id="msg-test-result" style="margin-top:12px;display:none;">
            <div style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;">Response:</div>
            <div id="msg-test-response" style="background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:var(--radius-sm);padding:12px 16px;font-size:13px;white-space:pre-wrap;max-height:300px;overflow-y:auto;"></div>
          </div>
        </div>

        <!-- Sessions List -->
        <div class="admin-card">
          <h3>Recent Sessions</h3>
          <div id="messaging-sessions-content"><div class="admin-loader"><div class="spinner"></div></div></div>
        </div>

        <!-- Session Message Viewer Modal -->
        <div class="modal-overlay" id="wa-message-modal" style="display:none;">
          <div class="modal" style="max-width:600px;">
            <div class="modal-header">
              <div>
                <h3 id="wa-modal-title">Session Messages</h3>
                <p id="wa-modal-subtitle" style="font-size:12px;color:var(--text-muted);margin:4px 0 0;"></p>
              </div>
              <button class="modal-close" onclick="document.getElementById('wa-message-modal').style.display='none'">&#x2715;</button>
            </div>
            <div class="modal-body" id="wa-modal-body" style="padding:16px 24px;max-height:500px;overflow-y:auto;">
              <div class="admin-loader"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Message Viewer Modal -->
  <div class="modal-overlay" id="message-modal">
    <div class="modal" style="max-width:800px;">
      <div class="modal-header">
        <div>
          <h3 id="message-modal-title">Conversation Messages</h3>
          <p id="message-modal-subtitle" style="font-size:12px;color:var(--text-muted);margin:4px 0 0;"></p>
        </div>
        <button class="modal-close" onclick="closeMessageModal()">&#x2715;</button>
      </div>
      <div class="modal-body" id="message-modal-body" style="padding:16px 24px;">
        <div class="admin-loader"><div class="spinner"></div></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js" defer></script>
  <script src="/js/admin.js"></script>
</body>
</html>
