function toggleTheme(){const e=document.documentElement.getAttribute("data-theme"),t="dark"===e?"light":"dark";document.documentElement.setAttribute("data-theme",t),localStorage.setItem("askozzy_theme",t);const n=document.getElementById("theme-toggle");n&&n.setAttribute("aria-label",`Switch to ${e} mode`);const a="dark"===t?"#0f1117":"#f5f3ef";document.querySelectorAll('meta[name="theme-color"]').forEach(e=>e.setAttribute("content",a))}function _loadScript(e){let t=_loadScript._cache?.[e];return t||(_loadScript._cache||(_loadScript._cache={}),t=new Promise((t,n)=>{const a=document.createElement("script");a.src=e,a.onload=t,a.onerror=n,document.head.appendChild(a)}),_loadScript._cache[e]=t,t)}async function loadChartJs(){"undefined"==typeof Chart&&await _loadScript("https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js")}async function loadDocxJs(){"undefined"==typeof docx&&await _loadScript("https://cdn.jsdelivr.net/npm/docx@9/build/index.umd.min.js")}!function(){const e=localStorage.getItem("askozzy_theme"),t=window.matchMedia("(prefers-color-scheme: light)").matches,n=e||(t?"light":"dark");document.documentElement.setAttribute("data-theme",n),document.documentElement.classList.add("no-transition"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{document.documentElement.classList.remove("no-transition")})})}(),window.matchMedia("(prefers-color-scheme: light)").addEventListener("change",e=>{localStorage.getItem("askozzy_theme")||document.documentElement.setAttribute("data-theme",e.matches?"light":"dark")});const API="";let state={token:localStorage.getItem("askozzy_token")||null,user:JSON.parse(localStorage.getItem("askozzy_user")||"null"),conversations:[],activeConversationId:null,messages:[],isStreaming:!1,selectedModel:"@cf/openai/gpt-oss-20b",activeCategory:"All",pendingAction:null,folders:[],collapsedFolders:{},memories:[],agents:[],selectedAgent:null,currentArtifact:null,webSearchEnabled:!1,webSearchSources:[],language:"en",voiceMode:!1,spacesLoaded:!1,userType:null},_selectedPersona="gog_employee";function selectPersona(e,t){_selectedPersona=e,document.querySelectorAll(".persona-option").forEach(e=>e.classList.remove("active")),t&&t.classList.add("active");const n=document.getElementById("reg-dept-label"),a=document.getElementById("reg-dept");"student"===e?(n&&(n.textContent="School / Institution"),a&&(a.placeholder="e.g. University of Ghana")):(n&&(n.textContent="Department / MDA"),a&&(a.placeholder="e.g. Ministry of Finance"))}function selectWelcomePersona(e,t){_selectedPersona=e,document.querySelectorAll(".welcome-persona-btn").forEach(e=>e.classList.remove("active")),t&&t.classList.add("active"),document.querySelectorAll(".persona-option").forEach(t=>{t.classList.toggle("active",t.onclick&&t.outerHTML.includes(e))}),state.userType=e,localStorage.setItem("askozzy_persona",e),applyPersonaUI(),renderCategoryTabs(),renderTemplateGrid(),selectPersona(e,null)}function isStudent(){return"student"===state.userType}function getPersonaTemplates(){return isStudent()?TEMPLATES.filter(e=>e.studentOnly):TEMPLATES}function getPersonaCategories(){return isStudent()?TEMPLATE_CATEGORIES.filter(e=>e.studentOnly):TEMPLATE_CATEGORIES}function applyPersonaUI(){const e=document.getElementById("welcome-subtitle"),t=document.getElementById("sidebar-subtitle"),n=document.getElementById("welcome-persona-selector"),a=document.querySelector("#welcome-screen h2");if(isLoggedIn()&&state.user&&state.user.fullName){const e=state.user.fullName.split(" ")[0];a&&(a.textContent=`Welcome to AskOzzy, ${e}! üëã`)}else a&&(a.textContent="Welcome to AskOzzy");isStudent()?(e&&(e.textContent="Your AI study companion for academic success. Choose a template below or start a free conversation."),t&&(t.textContent="AI for Ghana Students")):(e&&(e.textContent="Your private AI assistant for GoG operations. Choose a template below or start a free conversation."),t&&(t.textContent="AI for All GoG Staff")),n&&(n.style.display=isLoggedIn()?"none":"")}const ADINKRA={gyeNyame:(e=24,t="currentColor")=>`<svg width="${e}" height="${e}" viewBox="0 0 64 64" fill="none"><path d="M32 8c-2 0-4 1.5-5 4l-3 8c-1 2.5-3 4-6 4h-4c-3 0-5 2-5 5s2 5 5 5h2c3 0 5 1.5 6 4l2 6c1 3 3 5 5 5h2c2 0 4-2 5-5l2-6c1-2.5 3-4 6-4h2c3 0 5-2 5-5s-2-5-5-5h-4c-3 0-5-1.5-6-4l-3-8c-1-2.5-3-4-5-4z" fill="${t}"/><circle cx="32" cy="29" r="6" fill="${t}" opacity="0.3"/></svg>`,sankofa:(e=24,t="currentColor")=>`<svg width="${e}" height="${e}" viewBox="0 0 64 64" fill="none"><path d="M42 12c-4 0-7 2-9 5l-4 7c-1 2-3 3-5 3-4 0-7 3-7 7s3 7 7 7c2 0 4-1 5-3l2-3v10c0 4 3 7 7 7s7-3 7-7V26c0-8-1-14-3-14z" fill="${t}"/><circle cx="42" cy="18" r="3" fill="${t}" opacity="0.5"/></svg>`,dwennimmen:(e=24,t="currentColor")=>`<svg width="${e}" height="${e}" viewBox="0 0 64 64" fill="none"><path d="M16 16c0 8 4 14 10 16v16h4V32c6-2 10-8 10-16" stroke="${t}" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M16 16c-4 4-6 10-4 16 2 5 6 8 10 8" stroke="${t}" stroke-width="3" fill="none" stroke-linecap="round"/><path d="M40 16c4 4 6 10 4 16-2 5-6 8-10 8" stroke="${t}" stroke-width="3" fill="none" stroke-linecap="round"/><circle cx="20" cy="16" r="3" fill="${t}"/><circle cx="36" cy="16" r="3" fill="${t}"/></svg>`,aya:(e=24,t="currentColor")=>`<svg width="${e}" height="${e}" viewBox="0 0 64 64" fill="none"><line x1="32" y1="8" x2="32" y2="56" stroke="${t}" stroke-width="2.5"/><path d="M32 16l-10 6 10-2m0 0l10 6-10-2m0 6l-12 7 12-2m0 0l12 7-12-2m0 6l-10 6 10-2m0 0l10 6-10-2" stroke="${t}" stroke-width="2" stroke-linecap="round"/><circle cx="32" cy="10" r="2.5" fill="${t}"/></svg>`},GUIDE_SECTION_EMOJIS={"getting-started":{emoji:"üöÄ",gradient:"linear-gradient(135deg, #ff6b35, #f7c948)"},"chat-ai":{emoji:"üí¨",gradient:"linear-gradient(135deg, #4a9eff, #6c5ce7)"},"smart-tools":{emoji:"üõ†Ô∏è",gradient:"linear-gradient(135deg, #00b894, #00cec9)"},"file-media":{emoji:"üìÅ",gradient:"linear-gradient(135deg, #e17055, #fdcb6e)"},organization:{emoji:"üìÇ",gradient:"linear-gradient(135deg, #a29bfe, #6c5ce7)"},personalization:{emoji:"‚öôÔ∏è",gradient:"linear-gradient(135deg, #fd79a8, #e84393)"},languages:{emoji:"üåç",gradient:"linear-gradient(135deg, #00b894, #55efc4)"},vision:{emoji:"üëÅÔ∏è",gradient:"linear-gradient(135deg, #0984e3, #74b9ff)"},"account-security":{emoji:"üîí",gradient:"linear-gradient(135deg, #636e72, #b2bec3)"},"citizen-bot":{emoji:"üë•",gradient:"linear-gradient(135deg, #006B3F, #00a86b)"},shortcuts:{emoji:"‚å®Ô∏è",gradient:"linear-gradient(135deg, #2d3436, #636e72)"},"install-offline":{emoji:"üì•",gradient:"linear-gradient(135deg, #0984e3, #00cec9)"},"native-app":{emoji:"üì±",gradient:"linear-gradient(135deg, #6c5ce7, #a29bfe)"}},GUIDE_TRY_IT_ACTIONS={"st-templates":{label:"Open Templates ‚Üí",action:"closeGuide();openTemplateModal();"},"st-research":{label:"Try Deep Research ‚Üí",action:"closeGuide();openDeepResearch();"},"st-analysis":{label:"Analyze Data ‚Üí",action:"closeGuide();openDataAnalysis();"},"st-workflows":{label:"Open Workflows ‚Üí",action:"closeGuide();openWorkflows();"},"st-meetings":{label:"Start Meeting ‚Üí",action:"closeGuide();openMeetingAssistant();"},"st-spaces":{label:"Open Spaces ‚Üí",action:"closeGuide();openSpaces();"},"gs-models":{label:"View Models ‚Üí",action:"closeGuide();document.getElementById('model-selector').focus();"},"as-pricing":{label:"View Plans ‚Üí",action:"closeGuide();openPricingModal();"},"ps-memory":{label:"Open Memory ‚Üí",action:"closeGuide();openMemoryModal();"},"fm-upload":{label:"Upload a File ‚Üí",action:"closeGuide();openFileUpload();"}},GUIDE_TIPS=["Press <kbd>Ctrl</kbd>+<kbd>K</kbd> to search all your conversations instantly.","Use <kbd>Shift</kbd>+<kbd>Enter</kbd> for multi-line messages without sending.","Pin your most important conversations so they always appear at the top of the sidebar.","Try Deep Research mode for comprehensive reports with citations on any topic.","Upload a CSV file and ask Ozzy to create charts and find trends in your data.","Create custom AI agents with specialized instructions for your department.","Enable Web Search to get AI responses grounded in current, real-time information.","Press <kbd>Ctrl</kbd>+<kbd>N</kbd> to instantly start a new conversation.","Use the Citizen Bot (bottom-right) for quick government service queries.","Switch between AI models to find the best one for your task ‚Äî some are faster, others more detailed.","Pull down from the top of the chat to refresh your conversations list.","Swipe from the left edge of the screen to open the sidebar on mobile.","Enable push notifications to stay updated when AskOzzy has important alerts.","Student users get up to 58% off on all paid plans ‚Äî register as a Student to save!","Your drafts are auto-saved. Close the app and your unsent message will be waiting when you return.","Install AskOzzy as an app for the best experience ‚Äî it works offline too!"],GUIDE_SECTIONS=[{id:"getting-started",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',title:"Getting Started",description:"Registration, sign-in, and model selection",features:[{id:"gs-register",title:"Create Your Account",tier:"free",description:"Register with your name, email, GoG department, and a referral code. You'll receive a personal access code and set up 2FA security.",steps:['Click "Sign In / Create Account" in the sidebar','Switch to the "Register" tab',"Choose your persona: GoG Employee or Student","Enter your full name, email, department, and referral code",'A referral code is required ‚Äî get one from a colleague or click "Generate" for a system code',"Set up 2FA by scanning the QR code with an authenticator app","Save your access code and recovery code ‚Äî shown only once!"]},{id:"gs-signin",title:"Sign In with Access Code",tier:"free",description:"Use your email and access code to sign in. No passwords needed ‚Äî simple and secure.",steps:['Click "Sign In / Create Account"',"Enter your email and access code","Enter your 6-digit 2FA code from your authenticator app",'You\'re signed in with a personalized "Welcome to AskOzzy, [Name]!" greeting',"Your conversations, preferences, and settings are all restored"]},{id:"gs-models",title:"Choose Your AI Model",tier:"free",description:"Select from multiple AI models optimized for different tasks. Higher tiers unlock more powerful models.",steps:["Look for the model selector dropdown in the header","Free tier includes GPT-OSS 20B, Gemma 3, and Llama 3.1 8B","Professional tier unlocks all 11 models including Llama 3.3 70B and DeepSeek R1","Each model has strengths ‚Äî experiment to find your favorite"]},{id:"gs-persona",title:"GoG Employee vs Student Mode",tier:"free",description:"AskOzzy adapts its interface, templates, and pricing based on whether you're a GoG employee or student.",steps:["Select your persona during registration (GoG Employee or Student)","GoG Employees see government-focused templates (memos, briefs, procurement)","Students see academic templates (essays, research, study aids)","Students get discounted subscription pricing ‚Äî up to 58% off!","Your persona is saved to your account and persists across devices"]}]},{id:"chat-ai",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',title:"Chat & AI",description:"Messaging, streaming responses, and message actions",features:[{id:"ca-send",title:"Send Messages",tier:"free",description:"Type your question or task and press Enter (or click send) to get AI-powered responses.",steps:["Type your message in the input area at the bottom","Press Enter or click the send button","The AI responds in real-time with streaming text","Use Shift+Enter for new lines within your message"]},{id:"ca-stream",title:"Streaming Responses",tier:"free",description:"Responses stream in word-by-word for a natural feel. You can stop generation anytime.",steps:["Responses appear progressively as they're generated","Click the stop button to halt generation early","Markdown formatting renders automatically (bold, code, lists)","Code blocks include syntax highlighting and copy buttons"]},{id:"ca-actions",title:"Message Actions",tier:"free",description:"Copy, regenerate, share, or take actions on any AI response.",steps:["Hover over any AI message to see action buttons","Copy ‚Äî copies the full response as rich text to clipboard","Regenerate ‚Äî asks the AI to try again with a fresh response","Share ‚Äî share a conversation excerpt using your device's native share sheet","Messages support full Markdown rendering with tables and code"]},{id:"ca-conversations",title:"Conversation Management",tier:"free",description:"Create, rename, pin, and organize your conversations.",steps:['Click "New Chat" or press Ctrl+N to start fresh',"Conversations auto-save and appear in the sidebar","Click the pencil icon to rename a conversation","Right-click or long-press for more options (delete, pin, share)"]},{id:"ca-drafts",title:"Auto-Save Drafts",tier:"free",description:"Your unsent messages are automatically saved and restored when you return to AskOzzy.",steps:["Start typing a message in the input area","Close the app or navigate away ‚Äî your draft saves automatically","When you return, AskOzzy restores your unsent message","Drafts also save when your device goes idle for 2+ minutes","Works across sessions and even after restarting the app"]}]},{id:"smart-tools",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',title:"Smart Tools",description:"Templates, research, workflows, meetings, spaces, and web search",features:[{id:"st-templates",title:"GoG Prompt Templates",tier:"free",description:"25+ pre-built templates for Government of Ghana operations ‚Äî memos, briefs, reports, and more.",steps:['Browse templates on the welcome screen or click "Templates"',"Filter by category: Writing, Analysis, HR, Finance, Legal, etc.","Click a template to auto-fill the chat input","Customize the template text before sending"]},{id:"st-research",title:"Deep Research Mode",tier:"professional",description:"AI-powered research that synthesizes information into structured reports with citations.",steps:["Click the Research tool pill below the input area","Enter your research topic or question","AI generates a comprehensive report with sections","Review findings, sources, and recommendations"]},{id:"st-analysis",title:"Data Analysis",tier:"professional",description:"Upload spreadsheets or paste data for AI-powered analysis with charts and insights.",steps:["Upload a CSV/Excel file or paste tabular data","Ask the AI to analyze trends, summarize, or visualize","Get charts, statistics, and actionable insights","Export results or continue the analysis conversation"]},{id:"st-workflows",title:"Workflow Wizard",tier:"professional",description:"Multi-step guided workflows for complex GoG processes like procurement, HR actions, and policy drafts.",steps:["Click the Workflow tool pill","Select a workflow category (procurement, HR, policy, etc.)","Follow the step-by-step wizard with guided inputs","AI generates complete documents based on your inputs","Review, edit, and export the final output"]},{id:"st-meetings",title:"Meeting Assistant",tier:"professional",description:"Generate agendas, take notes, and create minutes with AI assistance.",steps:["Click the Meeting tool pill","Choose: create agenda, take notes, or generate minutes","Enter meeting details (participants, topics, decisions)","AI structures and formats everything professionally"]},{id:"st-spaces",title:"Collaborative Spaces",tier:"professional",description:"Shared workspaces where team members can collaborate on AI-powered projects together.",steps:['Click "Spaces" in the sidebar',"Create a new space with a name and description","Invite team members by email","All members can chat, share files, and collaborate in real-time"]},{id:"st-websearch",title:"Web Search",tier:"professional",description:"Enable real-time web search to ground AI responses with current information.",steps:["Toggle the Web Search pill below the input area","Ask a question that needs up-to-date information","AI searches the web and cites sources in its response","Source links appear below the message for verification"]}]},{id:"file-media",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',title:"File & Media",description:"File upload, images, camera, voice input, and voice mode",features:[{id:"fm-upload",title:"File Upload & Analysis",tier:"free",description:"Upload documents (PDF, TXT, CSV, DOCX, PPTX) for AI analysis. Files are processed and can be queried.",steps:["Click the paperclip icon or drag files into the chat","Supported: PDF, TXT, CSV, DOCX, PPTX (up to 10MB)","The AI reads the file content and can answer questions about it","Ask for summaries, key points, specific data extraction"]},{id:"fm-images",title:"Image Upload",tier:"free",description:"Upload images for AI vision analysis ‚Äî describe, extract text, analyze content.",steps:["Click the image icon or drag an image into chat","Supported: JPG, PNG, GIF, WebP","The AI can describe, analyze, or extract text from images",'Combine with prompts like "What does this show?"']},{id:"fm-camera",title:"Camera Capture",tier:"free",description:"Take photos directly from your device camera for instant AI analysis.",steps:["Click the camera icon in the input area","Allow camera access when prompted","Frame your subject and click the capture button","The photo is sent to AI for analysis ‚Äî great for documents and receipts"]},{id:"fm-voice",title:"Voice Input",tier:"free",description:"Speak your messages instead of typing using browser speech recognition.",steps:["Click the microphone icon in the input area","Allow microphone access when prompted","Speak clearly ‚Äî your words appear as text in the input","Click the mic icon again or press Enter to send"]},{id:"fm-voicemode",title:"Voice Mode",tier:"professional",description:"Hands-free voice conversation mode with text-to-speech responses.",steps:["Click the Voice Mode toggle in the input area","Speak your question ‚Äî AI responds with both text and speech","Supports continuous conversation without touching the screen","Toggle off to return to text-only mode"]},{id:"fm-savefile",title:"Save to Device",tier:"free",description:"Save AI-generated content directly to your device using the native file picker (on supported browsers).",steps:["When the AI generates a report, document, or code snippet","Click the download/save button on the message",'On supported browsers, a native "Save As" dialog appears',"Choose where to save the file on your device","On older browsers, the file downloads to your default folder"]}]},{id:"organization",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',title:"Organization",description:"Folders, pinning, search, and sharing conversations",features:[{id:"org-folders",title:"Conversation Folders",tier:"free",description:"Organize conversations into custom folders for easy access.",steps:['Click "New Folder" in the sidebar','Name your folder (e.g., "Budget Reports", "HR Queries")',"Drag conversations into folders or use the move option","Click folder names to expand/collapse them"]},{id:"org-pin",title:"Pin Conversations",tier:"free",description:"Pin important conversations to the top of your sidebar for quick access.",steps:["Right-click or long-press a conversation",'Select "Pin" from the context menu',"Pinned conversations appear at the top of the sidebar",'Unpin by right-clicking and selecting "Unpin"']},{id:"org-search",title:"Search Conversations",tier:"free",description:"Search across all your messages and conversations instantly.",steps:["Press Ctrl+K or click the search icon","Type your search query","Results show matching messages with conversation context","Click a result to jump directly to that conversation"]},{id:"org-share",title:"Share Conversations",tier:"free",description:"Share conversations via your device's native share sheet, or generate a read-only link for colleagues.",steps:["Open the conversation you want to share","Click the share icon ‚Äî on mobile, your device's native share sheet opens","Share directly to WhatsApp, email, or any other app","Alternatively, generate a unique read-only link","Revoke sharing anytime from the share dialog"]}]},{id:"personalization",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',title:"AI Personalization",description:"Memory, custom agents, and artifacts",features:[{id:"ps-memory",title:"AI Memory",tier:"professional",description:"Teach AI about your preferences, projects, and context. It remembers across conversations.",steps:['Click "Memory" in the sidebar footer','Add memories like "I work in the Finance department"',"AI uses memories to personalize all future responses","Delete or edit memories anytime from the Memory modal"]},{id:"ps-agents",title:"Custom AI Agents",tier:"professional",description:"Create specialized AI agents with custom instructions for specific tasks or roles.",steps:['Click "Agents" in the sidebar or tool area',"Create a new agent with a name and description",'Write custom instructions (e.g., "You are a legal advisor for GoG")',"Select the agent before chatting to activate its persona","Switch between agents or use the default assistant"]},{id:"ps-artifacts",title:"Artifacts",tier:"professional",description:"AI generates rich artifacts ‚Äî documents, code, diagrams ‚Äî that render in a side panel.",steps:["Ask the AI to create a document, report, or code snippet","Artifacts appear in a dedicated panel beside the chat","Edit artifacts directly in the panel","Download or copy artifacts for use in other tools"]}]},{id:"languages",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',title:"Languages",description:"7 Ghanaian and international languages with text-to-speech",features:[{id:"lang-multi",title:"Multilingual Support",tier:"free",description:"Chat in English, Twi, Ga, Ewe, Dagbani, Hausa, or French. The interface and AI adapt to your language.",steps:["Click the language selector (globe icon) in the input area","Choose from: English, Twi, Ga, Ewe, Dagbani, Hausa, French","The AI responds in your selected language","Interface labels also translate where available"]},{id:"lang-tts",title:"Text-to-Speech",tier:"free",description:"Listen to AI responses read aloud. Useful for accessibility and hands-free use.",steps:["Click the speaker icon on any AI response","The message is read aloud using browser TTS","Works best with English; Ghanaian languages use approximation","Adjust system volume to control speech volume"]}]},{id:"vision",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',title:"Vision & Image AI",description:"4 vision modes: describe, OCR, form data extraction, receipt scanning",features:[{id:"vis-describe",title:"Image Description",tier:"free",description:"Upload an image and get a detailed AI description of its contents.",steps:["Upload or capture an image",'Select "Describe" mode (or just ask "What is this?")',"AI provides a detailed description of the image contents","Useful for accessibility, documentation, and content analysis"]},{id:"vis-ocr",title:"OCR Text Extraction",tier:"free",description:"Extract printed or handwritten text from images with AI-powered OCR.",steps:["Upload a photo of a document, sign, or handwritten text",'Select "Extract Text" mode',"AI reads and outputs all visible text from the image","Copy the extracted text for use in other documents"]},{id:"vis-form",title:"Form Data Extraction",tier:"professional",description:"Extract structured data from forms ‚Äî applications, surveys, registration documents.",steps:["Take a photo or upload a scan of a filled form",'Select "Form Data" mode',"AI identifies fields and values in a structured format","Results can be used to populate digital records"]},{id:"vis-receipt",title:"Receipt Scanning",tier:"professional",description:"Scan receipts and invoices to extract amounts, dates, vendors, and line items.",steps:["Photograph or upload a receipt/invoice",'Select "Receipt" mode',"AI extracts: vendor, date, items, amounts, total, tax","Great for expense reporting and record-keeping"]}]},{id:"account-security",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',title:"Account & Security",description:"2FA, sessions, pricing tiers, and affiliate program",features:[{id:"as-2fa",title:"Two-Factor Authentication",tier:"free",description:"Add an extra layer of security with TOTP-based 2FA using any authenticator app.",steps:['Click "2FA Security" in the sidebar footer',"Scan the QR code with Google Authenticator or similar","Enter the 6-digit code to verify setup","On future logins, you'll enter the code after your access code"]},{id:"as-sessions",title:"Session Management",tier:"free",description:"View and revoke active sessions for security. Revoke all sessions to sign out everywhere.",steps:['Click "Revoke Sessions" in the sidebar footer',"Confirm to sign out all devices except your current one","Useful if you suspect unauthorized access","You'll need to sign in again on other devices"]},{id:"as-pricing",title:"Subscription Tiers",tier:"free",description:"Choose from Free, Professional, or Enterprise plans. Students get discounted pricing on all paid tiers.",steps:["Click your tier badge in the sidebar footer","Compare features across all 3 tiers","Standard pricing: Professional GHS 60/mo, Enterprise GHS 100/mo","Student pricing: Professional GHS 25/mo, Enterprise GHS 45/mo (up to 58% off!)","Pay via Mobile Money (MoMo) or card through Paystack","Try Professional free for 3 days before committing"]},{id:"as-affiliate",title:"Referral & Affiliate Program",tier:"free",description:"Earn GHS by referring colleagues. Every new user needs a referral code to register.",steps:['Click "Earn GHS" in the sidebar footer',"Copy your unique referral link or referral code","Share with colleagues ‚Äî they'll enter your code during registration","On supported devices, use the Contact Picker to invite contacts directly","Earn commissions when your referrals subscribe to paid plans","Track your referrals, earnings, and milestones in the affiliate dashboard"]},{id:"as-notifications",title:"Push Notifications",tier:"free",description:"Enable push notifications to receive alerts about new features, subscription updates, and more.",steps:["After a few conversations, AskOzzy will ask to enable notifications",'Click "Allow" when prompted by your browser',"Manage notification preferences in the sidebar (Settings)","Toggle categories: product updates, billing alerts, tips","Notifications work even when AskOzzy is closed"]}]},{id:"citizen-bot",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',title:"Citizen Bot",description:"Public-facing widget with quick actions and multilingual support",features:[{id:"cb-widget",title:"Citizen Bot Widget",tier:"free",description:"A floating chat widget for citizens to ask government-related questions without logging in.",steps:["The Citizen Bot appears as a floating button on the bottom-right","Click to open the chat widget","Citizens can ask about government services, forms, procedures","Responses are AI-powered with GoG knowledge"]},{id:"cb-quick",title:"Quick Actions",tier:"free",description:"Pre-built quick action buttons for common citizen queries.",steps:["Open the Citizen Bot widget","Quick action buttons appear at the bottom","Tap any action to get instant, pre-formatted responses","Actions include: find forms, office hours, service requirements"]},{id:"cb-lang",title:"Multilingual Citizen Support",tier:"free",description:"Citizen Bot supports all 7 languages so citizens can interact in their preferred language.",steps:["Open the Citizen Bot widget","Select your preferred language from the language picker","Chat in Twi, Ga, Ewe, Dagbani, Hausa, French, or English","Responses come in the selected language"]}]},{id:"shortcuts",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="8" x2="6" y2="8"/><line x1="10" y1="8" x2="14" y2="8"/><line x1="18" y1="8" x2="18" y2="8"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="10" y2="16"/><line x1="14" y1="16" x2="18" y2="16"/></svg>',title:"Keyboard Shortcuts",description:"Quick keyboard shortcuts for power users",features:[]},{id:"install-offline",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',title:"Install & Offline",description:"Install as PWA, offline mode, background sync",features:[{id:"io-pwa",title:"Install as App (PWA)",tier:"free",description:'Install AskOzzy on your device for a native app-like experience. It appears as "AskOzzy" on your home screen with its own icon.',steps:['Look for the "Install" prompt in your browser or the install banner',"On Chrome: click the install icon (or Menu > Install App)","On Safari iOS: tap Share > Add to Home Screen","AskOzzy launches as a standalone app ‚Äî no browser chrome",'The app name displays as "AskOzzy" on your device']},{id:"io-offline",title:"Offline Mode & Background Sync",tier:"free",description:"Continue using AskOzzy without internet. Messages queue offline and sync automatically when connectivity returns.",steps:["Install the PWA for the best offline experience","When offline, browse your cached conversations and messages","New messages queue locally in the background","A badge shows how many messages are queued","When connectivity returns, Background Sync sends them automatically","A toast notification confirms when offline messages have synced"]}]},{id:"native-app",icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',title:"Native App Features",description:"Gestures, haptics, transitions, and device integration",features:[{id:"na-pull",title:"Pull to Refresh",tier:"free",description:"Pull down from the top of the chat area to refresh your conversations, just like a native app.",steps:["Touch and drag down from the top of the screen","A spinner appears when you pull past the threshold","Release to refresh your conversations and sync data","Haptic feedback confirms the refresh on supported devices"]},{id:"na-swipe",title:"Swipe to Open Sidebar",tier:"free",description:"Swipe from the left edge of the screen to open the sidebar on mobile devices.",steps:["Place your finger on the left edge of the screen","Swipe right to slide the sidebar open","Tap the dark backdrop or swipe left to close it","Works just like a native navigation drawer"]},{id:"na-haptics",title:"Haptic Feedback",tier:"free",description:"Feel subtle vibrations when you perform actions ‚Äî sending messages, refreshing, toggling features.",steps:["Haptic feedback activates automatically on supported devices","Light vibration on button taps and toggles","Medium vibration on pull-to-refresh and swipe gestures","Success pattern when messages send or operations complete","Works on Android and supported iOS devices"]},{id:"na-transitions",title:"View Transitions",tier:"free",description:"Smooth animated transitions between the welcome screen, chat view, and conversations.",steps:["Navigate between welcome screen and chat to see crossfade transitions","Switching conversations uses slide animations","Transitions use the View Transitions API on supported browsers","Falls back gracefully to instant switching on older browsers"]},{id:"na-wakelock",title:"Screen Wake Lock",tier:"free",description:"Your screen stays awake while AI is streaming a response, so you never miss content.",steps:["The screen wake lock activates automatically during AI streaming","Your display won't dim or lock while a response is being generated","The lock releases automatically when the response completes","Also activates during voice mode for hands-free use"]},{id:"na-mediasession",title:"Media Session (Voice Mode)",tier:"professional",description:"Control voice mode from your lock screen or notification shade using media session controls.",steps:["Enter Voice Mode to activate media session integration","Your device shows AskOzzy in the media/notification controls","Use play/pause buttons to control voice interaction","Works with Bluetooth headsets and car audio systems"]},{id:"na-idle",title:"Idle Detection",tier:"free",description:"AskOzzy detects when you're idle and auto-saves your work to prevent data loss.",steps:["After 2 minutes of inactivity, AskOzzy auto-saves your draft","Your unsent message is preserved in local storage","When you return, your draft is restored automatically","Works even if you lock your phone or switch apps"]}]}];function requireAuth(e,...t){state.token&&state.user?e(...t):(state.pendingAction=()=>e(...t),openAuthModal())}function isLoggedIn(){return!(!state.token||!state.user)}function openAuthModal(){document.getElementById("auth-modal").classList.add("active"),document.getElementById("auth-error").classList.remove("visible");const e=document.getElementById("passkey-login-btn");e&&(e.style.display=window.PublicKeyCredential?"":"none"),setTimeout(()=>{(document.getElementById("login-form").classList.contains("hidden")?document.getElementById("reg-name"):document.getElementById("login-email")).focus()},100)}function closeAuthModal(){const e=document.getElementById("totp-setup-step");e&&e.classList.add("hidden"),document.getElementById("login-form").classList.remove("hidden"),document.getElementById("register-form").classList.add("hidden");const t=document.querySelector(".auth-toggle");t&&(t.style.display="");const n=document.querySelector("#auth-modal .privacy-banner");n&&(n.style.display=""),document.getElementById("auth-modal-title").textContent="Sign in to AskOzzy",document.getElementById("auth-modal").classList.remove("active"),state.pendingAction=null}function toggleAuthForm(){const e=document.getElementById("login-form"),t=document.getElementById("register-form"),n=document.getElementById("toggle-text"),a=document.getElementById("auth-toggle-link"),i=document.getElementById("auth-modal-title");document.getElementById("auth-error").classList.remove("visible"),e.classList.contains("hidden")?(e.classList.remove("hidden"),t.classList.add("hidden"),n.textContent="Don't have an account?",a.textContent="Create one",i.textContent="Sign in to continue"):(e.classList.add("hidden"),t.classList.remove("hidden"),n.textContent="Already have an account?",a.textContent="Sign in",i.textContent="Create your account")}function showAuthError(e){const t=document.getElementById("auth-error");t.textContent=e,t.classList.add("visible")}document.addEventListener("DOMContentLoaded",()=>{renderTemplateGrid(),renderCategoryTabs(),updateSidebarFooter(),updateUsageBadge(null),checkReferralLanding();const e=new URLSearchParams(window.location.search).get("ref");if(e){const t=document.getElementById("reg-referral");t&&(t.value=e)}const t=localStorage.getItem("askozzy_persona");t&&(_selectedPersona=t,state.userType=t,applyPersonaUI(),renderTemplateGrid(),renderCategoryTabs(),document.querySelectorAll(".welcome-persona-btn").forEach(e=>{e.classList.toggle("active",e.outerHTML.includes(t))})),state.token&&state.user&&(state.userType=state.user.userType||"gog_employee",onAuthenticated())});let _pendingTOTPEmail=null;function showTOTPSetup(e,t,n,a){_pendingTOTPEmail=a,document.getElementById("auth-error").classList.remove("visible"),document.getElementById("login-form").classList.add("hidden"),document.getElementById("register-form").classList.add("hidden");const i=document.querySelector(".auth-toggle");i&&(i.style.display="none");const o=document.querySelector("#auth-modal .privacy-banner");o&&(o.style.display="none"),document.getElementById("totp-setup-step").classList.remove("hidden"),document.getElementById("totp-qr-img").src=`https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(e)}`,document.getElementById("totp-manual-secret").textContent=t,document.getElementById("recovery-code-value").textContent=n,document.getElementById("totp-setup-error").textContent="",document.getElementById("totp-setup-code").value="",document.getElementById("auth-modal-title").textContent="Set Up Authenticator"}function copyRecoveryCode(){const e=document.getElementById("recovery-code-value").textContent;navigator.clipboard.writeText(e).then(()=>{const e=document.getElementById("btn-copy-recovery");e.textContent="Copied!",setTimeout(()=>{e.textContent="Copy"},2e3)})}async function verifyTOTPSetup(){const e=document.getElementById("totp-setup-code").value.trim(),t=document.getElementById("totp-setup-error"),n=document.getElementById("btn-verify-totp-setup");if(6===e.length&&/^\d{6}$/.test(e)){n.disabled=!0,n.textContent="Verifying...",t.textContent="";try{const t=await fetch("/api/auth/register/verify-totp",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:_pendingTOTPEmail,code:e})}),n=await t.json();if(!t.ok)throw new Error(n.error||"Verification failed");state.token=n.token,state.user=n.user,state.userType=n.user.userType||"gog_employee",localStorage.setItem("askozzy_token",n.token),localStorage.setItem("askozzy_user",JSON.stringify(state.user)),document.getElementById("totp-setup-step").classList.add("hidden"),document.getElementById("login-form").classList.remove("hidden"),document.getElementById("register-form").classList.add("hidden");const a=document.querySelector(".auth-toggle");a&&(a.style.display="");const i=document.querySelector("#auth-modal .privacy-banner");i&&(i.style.display=""),document.getElementById("auth-modal-title").textContent="Sign in to AskOzzy",document.getElementById("auth-modal").classList.remove("active"),_pendingTOTPEmail=null,onAuthenticated()}catch(e){t.textContent=e.message}finally{n.disabled=!1,n.textContent="Verify & Complete Registration"}}else t.textContent="Enter a 6-digit code from your authenticator app"}async function loginWithPasskey(){const e=document.getElementById("login-email").value;if(e)try{const t=await fetch("/api/auth/webauthn/login-options",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})}),n=await t.json();if(!t.ok)throw new Error(n.error||"Failed to get passkey options");const a=base64urlToBuffer(n.challenge),i=n.allowCredentials.map(e=>({type:e.type,id:base64urlToBuffer(e.id)})),o=await navigator.credentials.get({publicKey:{challenge:a,rpId:n.rpId,allowCredentials:i,userVerification:n.userVerification,timeout:n.timeout}}),s=await fetch("/api/auth/webauthn/login-complete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,credentialId:bufferToBase64url(o.rawId),authenticatorData:bufferToBase64url(o.response.authenticatorData),clientDataJSON:bufferToBase64url(o.response.clientDataJSON),signature:bufferToBase64url(o.response.signature)})}),r=await s.json();if(!s.ok)throw new Error(r.error||"Passkey login failed");state.token=r.token,state.user=r.user,state.userType=r.user.userType||"gog_employee",localStorage.setItem("askozzy_token",r.token),localStorage.setItem("askozzy_user",JSON.stringify(state.user)),closeAuthModal(),onAuthenticated()}catch(e){if("NotAllowedError"===e.name)return;showAuthError(e.message||"Passkey login failed")}else showAuthError("Please enter your email first")}async function addPasskey(){if(isLoggedIn())try{const e=await fetch("/api/auth/webauthn/register-options",{method:"POST",headers:authHeaders()}),t=await e.json();if(!e.ok)throw new Error(t.error||"Failed to get registration options");const n=await navigator.credentials.create({publicKey:{challenge:base64urlToBuffer(t.challenge),rp:t.rp,user:{id:base64urlToBuffer(t.user.id),name:t.user.name,displayName:t.user.displayName},pubKeyCredParams:t.pubKeyCredParams,authenticatorSelection:t.authenticatorSelection,timeout:t.timeout,excludeCredentials:(t.excludeCredentials||[]).map(e=>({type:e.type,id:base64urlToBuffer(e.id)}))}}),a=await fetch("/api/auth/webauthn/register-complete",{method:"POST",headers:authHeaders(),body:JSON.stringify({credentialId:bufferToBase64url(n.rawId),attestationObject:bufferToBase64url(n.response.attestationObject),clientDataJSON:bufferToBase64url(n.response.clientDataJSON)})}),i=await a.json();if(!a.ok)throw new Error(i.error||"Failed to register passkey");alert("Passkey registered successfully! You can now sign in with your fingerprint or Face ID.")}catch(e){if("NotAllowedError"===e.name)return;alert("Failed to add passkey: "+(e.message||"Unknown error"))}}function base64urlToBuffer(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=t.length%4,a=n?t+"=".repeat(4-n):t,i=atob(a),o=new Uint8Array(i.length);for(let e=0;e<i.length;e++)o[e]=i.charCodeAt(e);return o.buffer}function bufferToBase64url(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.length;e++)n+=String.fromCharCode(t[e]);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function onAuthenticated(){if(applyPersonaUI(),renderTemplateGrid(),renderCategoryTabs(),updateSidebarFooter(),loadConversations(),loadUsageStatus(),loadFolders(),loadAnnouncements(),loadMemories(),loadAgents(),loadStreakData(),startEnhancedOnboarding(),state.pendingAction){const e=state.pendingAction;state.pendingAction=null,e()}}function autoGenerateReferralCode(){const e=document.getElementById("reg-referral"),t=document.getElementById("referral-hint"),n=document.getElementById("btn-auto-referral"),a=`OZZY-SYSTEM-${Math.random().toString(36).substring(2,6).toUpperCase()}`;e.value=a,e.readOnly=!0,e.style.opacity="0.75",t&&(t.textContent="Auto-generated code applied. You can still replace it with a colleague's code.",t.style.color="var(--flag-green, #006B3F)"),n&&(n.textContent="Clear",n.onclick=function(){e.value="",e.readOnly=!1,e.style.opacity="1",e.focus(),t&&(t.textContent='Enter a referral code from a colleague, or click "Auto-fill" if you don\'t have one.',t.style.color="var(--text-muted)"),n.textContent="Don't have one? Auto-fill",n.onclick=autoGenerateReferralCode})}async function logout(){try{await fetch("/api/auth/logout",{method:"POST",headers:authHeaders()})}catch{}state.token=null,state.user=null,state.userType=null,state.conversations=[],state.activeConversationId=null,state.messages=[],localStorage.removeItem("askozzy_token"),localStorage.removeItem("askozzy_user"),updateSidebarFooter(),updateUsageBadge(null),showWelcomeScreen(),renderConversationList();const e=document.querySelector(".limit-banner");e&&e.remove()}function authHeaders(){return{"Content-Type":"application/json",Authorization:`Bearer ${state.token}`}}function updateSidebarFooter(){const e=document.getElementById("sidebar-footer");if(isLoggedIn()){const t=state.user.fullName.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2),n=state.user.tier||"free",a={free:"Free",professional:"Professional",enterprise:"Enterprise"}[n]||"Free";e.innerHTML=`\n      <div class="user-info">\n        <div class="user-avatar">${t}</div>\n        <div>\n          <div class="user-name">${escapeHtml(state.user.fullName)}</div>\n          <div class="user-dept">${escapeHtml(state.user.department||(isStudent()?"Student":"GoG Operations"))}</div>\n        </div>\n      </div>\n      <div style="display:flex;gap:6px;">\n        <button class="sidebar-tier-btn tier-${n}" onclick="openPricingModal()">\n          ${a} Plan ${"free"===n?"‚Äî Upgrade":""}\n        </button>\n        <button class="sidebar-earn-btn" onclick="openAffiliateModal()">\n          Earn GHS\n        </button>\n      </div>\n      <div id="streak-badge-container"></div>\n      <div class="sidebar-links">\n        <button class="sidebar-link-btn" onclick="openUserDashboard()">Dashboard</button>\n        <button class="sidebar-link-btn" onclick="openProductivityDashboard()">Productivity</button>\n        <button class="sidebar-link-btn" onclick="openMemoryModal()">üß† Memory</button>\n        <button class="sidebar-link-btn" onclick="openSecuritySettings()">Security</button>\n        <button class="sidebar-link-btn" onclick="revokeAllSessions()">Revoke Sessions</button>\n        <button class="sidebar-link-btn" onclick="openGuide()">User Guide</button>\n        ${"super_admin"===state.user.role?'<a class="sidebar-link-btn" href="/admin" style="text-decoration:none;text-align:center;">Admin</a>':""}\n      </div>\n      <button class="btn-logout" onclick="logout()">Sign Out</button>`}else e.innerHTML='\n      <button class="btn-sidebar-signin" onclick="openAuthModal()">\n        Sign In / Create Account\n      </button>\n      <div class="sidebar-signin-hint">\n        Sign in to save conversations and access all features\n      </div>\n      <div class="sidebar-links" style="margin-top:8px;">\n        <button class="sidebar-link-btn" onclick="openGuide()">User Guide</button>\n      </div>';e.innerHTML+='<div class="ghana-pride-badge"><div class="ghana-pride-flag"></div><span>Made with pride in Ghana</span></div>'}async function loadConversations(){if(isLoggedIn())try{const e=await fetch("/api/conversations",{headers:authHeaders()});if(!e.ok){if(401===e.status)return logout();throw new Error("Failed to load conversations")}const t=await e.json();state.conversations=t.conversations||[],renderConversationList()}catch(e){console.error("Failed to load conversations:",e)}}function renderConversationList(){const e=document.getElementById("conversation-list");if(!isLoggedIn()||0===state.conversations.length)return void(e.innerHTML=`<div class="section-label">Recent Conversations</div><div style="padding:12px;font-size:12px;color:var(--text-muted);text-align:center;">\n        ${isLoggedIn()?"No conversations yet. Start a new one!":"Sign in to see your conversations"}\n      </div>`);const t=state.conversations.filter(e=>e.pinned),n=state.conversations.filter(e=>!e.pinned),a=state.folders||[];let i="";if(state.user&&state.user.tier&&"free"!==state.user.tier){i+='<div class="folder-section">\n      <div class="folder-header">\n        <div class="section-label">Folders</div>\n        <button class="folder-add-btn" onclick="createFolder()" title="New folder">+</button>\n      </div>',0===a.length&&(i+='<div style="padding:8px 16px;font-size:11px;color:var(--text-muted);text-align:center;">No folders yet. Click + to create one.</div>');for(const e of a){const t=state.conversations.filter(t=>t.folder_id===e.id),n=!state.collapsedFolders||!state.collapsedFolders[e.id];i+=`<div class="folder-item" onclick="toggleFolderCollapse('${e.id}')">\n        <span class="folder-icon">${n?"üìÇ":"üìÅ"}</span> ${escapeHtml(e.name)} <span style="font-size:10px;color:var(--text-muted);">(${t.length})</span>\n        <button class="folder-delete" onclick="event.stopPropagation();deleteFolder('${e.id}')" title="Delete folder">√ó</button>\n      </div>`,n&&(i+=t.map(e=>renderConvoItem(e,!0)).join(""))}i+="</div>"}t.length>0&&(i+='<div class="section-label">Pinned</div>',i+=t.map(e=>renderConvoItem(e)).join(""));i+='<div class="section-label">Recent Conversations</div>',i+=n.filter(e=>!e.folder_id).map(e=>renderConvoItem(e)).join(""),e.innerHTML=i}function renderConvoItem(e,t){const n=state.user&&state.user.tier&&"free"!==state.user.tier;return`\n    <div class="conversation-item ${e.id===state.activeConversationId?"active":""} ${e.pinned?"pinned":""}"\n         onclick="openConversation('${e.id}')" oncontextmenu="showConvoContextMenu(event,'${e.id}',${!!e.pinned},${e.folder_id?`'${e.folder_id}'`:"null"})" ${t?'style="padding-left:28px;"':""}>\n      <span class="convo-icon">${e.pinned?"üìå":"üí¨"}</span>\n      <span class="convo-title">${escapeHtml(e.title)}</span>\n      <div class="convo-actions">\n        ${n?`<button class="convo-action-btn" onclick="event.stopPropagation();showMoveToFolderMenu(event,'${e.id}')" title="Move to folder">üìÅ</button>`:""}\n        <button class="convo-action-btn" onclick="event.stopPropagation();togglePin('${e.id}')" title="${e.pinned?"Unpin":"Pin"}">${e.pinned?"üìå":"üìç"}</button>\n        <button class="convo-action-btn convo-delete" onclick="event.stopPropagation();deleteConversation('${e.id}')" title="Delete">üóë</button>\n      </div>\n    </div>`}async function createNewChat(e){const t=e?TEMPLATES.find(t=>t.id===e):null;try{const n=await fetch("/api/conversations",{method:"POST",headers:authHeaders(),body:JSON.stringify({title:t?t.title:"New Conversation",templateId:e||null,model:state.selectedModel,agentId:state.selectedAgent||null})}),a=await n.json();if(!n.ok)throw new Error(a.error||"Failed to create conversation");if(state.activeConversationId=a.id,state.messages=[],await loadConversations(),showChatScreen(),window.innerWidth<=768){document.getElementById("sidebar").classList.add("collapsed");const e=document.getElementById("sidebar-backdrop");e&&e.classList.remove("active")}t&&(document.getElementById("chat-input").value=t.prompt,autoResizeInput(),updateSendButton()),closeTemplateModal()}catch(e){console.error("Failed to create chat:",e)}}async function openConversation(e){if(state.activeConversationId=e,renderConversationList(),showChatScreen(),window.innerWidth<=768){document.getElementById("sidebar").classList.add("collapsed");const e=document.getElementById("sidebar-backdrop");e&&e.classList.remove("active")}const t=state.conversations.find(t=>t.id===e);t&&t.agent_id&&(state.selectedAgent=t.agent_id,renderAgentSelector());try{const t=await fetch(`/api/conversations/${e}/messages`,{headers:authHeaders()}),n=await t.json();state.messages=n.messages||[],renderMessages()}catch(e){console.error("Failed to load messages:",e)}}async function deleteConversation(e){if(confirm("Delete this conversation?"))try{await fetch(`/api/conversations/${e}`,{method:"DELETE",headers:authHeaders()}),state.activeConversationId===e&&(state.activeConversationId=null,state.messages=[],showWelcomeScreen()),await loadConversations()}catch(e){console.error("Failed to delete:",e)}}function showChatScreen(){document.getElementById("welcome-screen").classList.add("hidden");const e=document.getElementById("chat-screen");e.classList.remove("hidden"),e.style.display="flex",document.getElementById("chat-input").focus()}function showWelcomeScreen(){document.getElementById("welcome-screen").classList.remove("hidden");const e=document.getElementById("chat-screen");e.classList.add("hidden"),e.style.display="none"}function renderMessages(){document.getElementById("chat-messages").innerHTML=state.messages.map((e,t)=>`\n    <div class="message ${e.role}">\n      <div class="message-avatar">\n        ${"user"===e.role?getUserInitials():"G"}\n      </div>\n      <div class="message-body">\n        <div class="message-sender">${"user"===e.role?"You":"AskOzzy"}</div>\n        ${e.imageUrl?`<div class="chat-image"><img src="${e.imageUrl}" alt="Uploaded image" /></div>`:""}\n        <div class="message-content">${"user"===e.role?escapeHtml(e.content):renderMarkdownWithCitations(e.content,e.webSources)}</div>\n        ${e.webSources&&e.webSources.length>0?renderSourcesFooter(e.webSources):""}\n        <div class="msg-actions">\n          ${"assistant"===e.role?`<button class="msg-action-btn" data-speak="${t}" onclick="speakMessage(${t})" title="Listen to response"><span class="msg-action-icon">&#x1F50A;</span> Speak</button>`:""}\n          <button class="msg-action-btn" onclick="copyMessageText(${t})" title="Copy text">\n            <span class="msg-action-icon">&#x2398;</span> Copy\n          </button>\n          ${"assistant"===e.role?`\n          <button class="msg-action-btn" onclick="downloadMessageTxt(${t})" title="Download as text file">\n            <span class="msg-action-icon">&#x1F4C4;</span> .txt\n          </button>\n          <button class="msg-action-btn" onclick="downloadMessageDoc(${t})" title="Download as formatted Word document with GoG letterhead">\n            <span class="msg-action-icon">&#x1F4DD;</span> .docx\n          </button>\n          <button class="msg-action-btn" onclick="printMessage(${t})" title="Print or save as PDF">\n            <span class="msg-action-icon">&#x1F5A8;</span> Print\n          </button>\n          ${e.id?`\n          <button class="msg-rate-btn ${1===e.userRating?"rated":""}" data-rate-msg="${e.id}" data-rating="1" onclick="rateMessage('${e.id}', 1)" title="Good response">&#x1F44D;</button>\n          <button class="msg-rate-btn ${-1===e.userRating?"rated":""}" data-rate-msg="${e.id}" data-rating="-1" onclick="rateMessage('${e.id}', -1)" title="Poor response">&#x1F44E;</button>\n          <button class="msg-action-btn" onclick="regenerateMessage('${e.id}')" title="Regenerate response">\n            <span class="msg-action-icon">&#x1F504;</span> Regenerate\n          </button>\n          `:""}\n          `:""}\n        </div>\n      </div>\n    </div>`).join(""),scrollToBottom()}function renderMarkdownWithCitations(e,t){let n=renderMarkdown(e);return t&&t.length>0&&(n=n.replace(/\[(\d+)\]/g,(e,n)=>{const a=parseInt(n)-1;return a>=0&&a<t.length?`<a href="${escapeHtml(t[a].url)}" target="_blank" rel="noopener" class="citation-ref" title="${escapeHtml(t[a].title)}">[${n}]</a>`:e})),n}function renderSourcesFooter(e){return e&&0!==e.length?`<div class="sources-footer">\n    <div class="sources-label">Sources</div>\n    <div class="sources-list">\n      ${e.map((e,t)=>{const n=(()=>{try{return new URL(e.url).hostname.replace("www.","")}catch{return e.url}})();return`<a href="${escapeHtml(e.url)}" target="_blank" rel="noopener" class="source-card">\n          <img src="https://www.google.com/s2/favicons?domain=${encodeURIComponent(n)}&sz=16" alt="" class="source-favicon" />\n          <span class="source-title">${escapeHtml(e.title.substring(0,60))}</span>\n          <span class="source-domain">${escapeHtml(n)}</span>\n        </a>`}).join("")}\n    </div>\n  </div>`:""}function getUserInitials(){return state.user?state.user.fullName.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2):"U"}async function sendMessage(){const e=document.getElementById("chat-input"),t=e.value.trim();if(t&&!state.isStreaming){if(!isLoggedIn())return state.pendingAction=()=>sendMessage(),void openAuthModal();if(!state.activeConversationId)try{const e=await fetch("/api/conversations",{method:"POST",headers:authHeaders(),body:JSON.stringify({title:t.length>60?t.substring(0,57)+"...":t,model:state.selectedModel,agentId:state.selectedAgent||null})}),n=await e.json();state.activeConversationId=n.id,showChatScreen(),await loadConversations()}catch(e){return void console.error("Failed to create conversation:",e)}e.value="",autoResizeInput(),updateSendButton(),state.messages.push({role:"user",content:t}),renderMessages(),addTypingIndicator(),state.isStreaming=!0,updateSendButton();try{const e=await fetch("/api/chat",{method:"POST",headers:authHeaders(),body:JSON.stringify({conversationId:state.activeConversationId,message:t,model:state.selectedModel,agentId:state.selectedAgent,webSearch:state.webSearchEnabled||t.startsWith("@web "),language:state.language})});if(state.webSearchSources=[],!e.ok){const t=await e.json();if("LIMIT_REACHED"===t.code)return removeTypingIndicator(),showLimitReachedBanner(t),state.messages.push({role:"assistant",content:`**Daily limit reached** ‚Äî You've used all ${t.limit} messages for today on the ${"free"===state.user.tier?"Free":state.user.tier} plan.\n\nUpgrade your plan to continue chatting with more messages and access to all premium AI models.`}),renderMessages(),state.isStreaming=!1,void updateSendButton();throw new Error(t.error||"Chat request failed")}removeTypingIndicator(),state.messages.push({role:"assistant",content:""}),renderMessages();const n=e.body.getReader(),a=new TextDecoder;let i="",o="";for(;;){const{done:e,value:t}=await n.read();if(e)break;const s=a.decode(t).split("\n");for(const e of s)if(e.startsWith("event: "))o=e.slice(7).trim();else if(e.startsWith("data: ")&&!e.includes("[DONE]")){try{if("sources"===o){state.webSearchSources=JSON.parse(e.slice(6)),o="";continue}if("suggestions"===o){const t=JSON.parse(e.slice(6));Array.isArray(t)&&t.length>0&&renderFollowUpSuggestions(t),o="";continue}const t=JSON.parse(e.slice(6));let n=t.response||null;!n&&t.choices?.[0]?.delta?.content&&(n=t.choices[0].delta.content),n&&(i+=n,state.messages[state.messages.length-1].content=i,updateLastMessage(i))}catch{}o=""}}state.webSearchSources.length>0&&(state.messages[state.messages.length-1].webSources=state.webSearchSources),renderMessages(),await loadConversations(),loadUsageStatus(),checkUpgradeNudge();const s=state.messages[state.messages.length-1];if(s&&"assistant"===s.role){const e=detectArtifact(s.content);if(e){const t=document.querySelectorAll(".message.assistant"),n=t[t.length-1];if(n){const t=document.createElement("button");t.className="artifact-open-btn",t.innerHTML="üìÑ Open in Canvas",t.onclick=()=>openArtifactPanel(e),n.appendChild(t)}}i&&navigator.serviceWorker&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"CACHE_RESPONSE",prompt:t,response:i})}}catch(e){removeTypingIndicator(),console.error("Chat error:",e),state.messages.push({role:"assistant",content:`**Error:** ${e.message}. Please try again.`}),renderMessages()}finally{state.isStreaming=!1,updateSendButton(),setTimeout(loadFollowUpSuggestions,500)}}}function addTypingIndicator(){const e=document.getElementById("chat-messages"),t=document.createElement("div");t.id="typing-indicator",t.className="message assistant",t.innerHTML=`\n    <div class="message-avatar">G</div>\n    <div class="message-body">\n      <div class="message-sender">AskOzzy</div>\n      <div class="typing-adinkra">${ADINKRA.gyeNyame(28,"var(--gold)")}</div>\n    </div>`,e.appendChild(t),scrollToBottom()}function removeTypingIndicator(){const e=document.getElementById("typing-indicator");e&&e.remove()}function updateLastMessage(e){const t=document.querySelectorAll(".message.assistant"),n=t[t.length-1];if(n){const t=n.querySelector(".message-content");t&&(t.innerHTML=renderMarkdown(e),scrollToBottom())}}function scrollToBottom(){const e=document.getElementById("chat-area");e&&(e.scrollTop=e.scrollHeight)}function copyMessageText(e){const t=state.messages[e];t&&navigator.clipboard.writeText(t.content).then(()=>{const t=document.querySelectorAll(`.message:nth-child(${e+1}) .msg-action-btn`)[0];if(t){const e=t.innerHTML;t.innerHTML='<span class="msg-action-icon">&#x2713;</span> Copied!',t.classList.add("copied"),setTimeout(()=>{t.innerHTML=e,t.classList.remove("copied")},1500)}})}function _getMessageFilename(e,t){const n=state.messages[e];if(!n)return`message.${t}`;return`AskOzzy_${n.content.replace(/[^a-zA-Z0-9 ]/g,"").trim().slice(0,40).trim().replace(/\s+/g,"_")||"response"}.${t}`}function _triggerDownload(e,t){const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}function downloadMessageTxt(e){const t=state.messages[e];if(!t)return;_triggerDownload(new Blob([t.content],{type:"text/plain;charset=utf-8"}),_getMessageFilename(e,"txt"))}document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("login-email").value,n=document.getElementById("login-access-code").value,a=e.target.querySelector(".btn-auth");a.disabled=!0,a.textContent="Signing in...";try{const e=/^\d{6}$/.test(n.trim())?{email:t,totpCode:n.trim()}:{email:t,accessCode:n},a=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),i=await a.json();if(!a.ok)throw new Error(i.error||"Login failed");state.token=i.token,state.user=i.user,state.user.trialExpiresAt=i.trialExpiresAt||i.user.trialExpiresAt||null,state.userType=i.user.userType||"gog_employee",localStorage.setItem("askozzy_token",i.token),localStorage.setItem("askozzy_user",JSON.stringify(state.user)),closeAuthModal(),onAuthenticated()}catch(e){showAuthError(e.message)}finally{a.disabled=!1,a.textContent="Sign In"}}),document.getElementById("register-form").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("reg-name").value,n=document.getElementById("reg-email").value,a=document.getElementById("reg-dept").value,i=document.getElementById("reg-referral"),o=i.value.trim();if(!o)return i.focus(),void showAuthError('Referral code is required. Click "Auto-fill" if you don\'t have one from a colleague.');const s=e.target.querySelector(".btn-auth");s.disabled=!0,s.textContent="Creating account...";try{const e=await fetch("/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,fullName:t,department:a,referralCode:o,userType:_selectedPersona})}),i=await e.json();if(!e.ok)throw new Error(i.error||"Registration failed");showTOTPSetup(i.totpUri,i.totpSecret,i.recoveryCode,i.email)}catch(e){showAuthError(e.message)}finally{s.disabled=!1,s.textContent="Create Account"}}),document.getElementById("auth-modal").addEventListener("click",e=>{e.target===e.currentTarget&&closeAuthModal()});const GOG_DOCX_STYLES={default:{document:{run:{font:"Calibri",size:24},paragraph:{spacing:{line:276}}},heading1:{run:{font:"Calibri",size:36,bold:!0,color:"006B3F"},paragraph:{spacing:{before:240,after:120}}},heading2:{run:{font:"Calibri",size:32,bold:!0,color:"006B3F"},paragraph:{spacing:{before:200,after:100}}},heading3:{run:{font:"Calibri",size:28,bold:!0,color:"333333"},paragraph:{spacing:{before:160,after:80}}}}};function detectDocumentType(e){return/CABINET\s+MEMO/i.test(e)?"cabinet_memo":/MEMORANDUM|MEMO\b/i.test(e)?"memo":/BRIEFING\s+NOTE/i.test(e)?"brief":/MINUTES\s+OF|MEETING\s+MINUTES/i.test(e)?"minutes":/Dear\s+(?:Sir|Madam|Hon|Dr|Mr|Mrs|Ms)/i.test(e)?"letter":/(?:ANNUAL|QUARTERLY|PROGRESS)\s+REPORT|REPORT\s+ON/i.test(e)?"report":"general"}function parseInlineFormatting(e){const t=[],n=/(\*\*(.+?)\*\*|\*(.+?)\*|`([^`]+)`)/g;let a,i=0;for(;null!==(a=n.exec(e));)a.index>i&&t.push(new docx.TextRun({text:e.slice(i,a.index)})),a[2]?t.push(new docx.TextRun({text:a[2],bold:!0})):a[3]?t.push(new docx.TextRun({text:a[3],italics:!0})):a[4]&&t.push(new docx.TextRun({text:a[4],font:"Consolas",size:20})),i=a.index+a[0].length;return i<e.length&&t.push(new docx.TextRun({text:e.slice(i)})),0===t.length&&t.push(new docx.TextRun({text:e})),t}function buildDocxTable(e){const t=Math.max(...e.map(e=>e.split("|").filter(e=>e.trim()).length)),n=e.map((e,n)=>{let a=e.split("|").filter(e=>e.trim());for(;a.length<t;)a.push("");return new docx.TableRow({children:a.map(e=>new docx.TableCell({children:[new docx.Paragraph({children:parseInlineFormatting(e.trim())})],shading:0===n?{fill:"F0F0F0",type:docx.ShadingType.SOLID}:void 0}))})});return new docx.Table({rows:n,width:{size:100,type:docx.WidthType.PERCENTAGE}})}function markdownToDocxElements(e){const t=[],n=e.split("\n");let a=0;for(;a<n.length;){const e=n[a];if(e.trim().startsWith("```")){let e="";for(a++;a<n.length&&!n[a].trim().startsWith("```");)e+=n[a]+"\n",a++;a<n.length&&a++,t.push(new docx.Paragraph({children:[new docx.TextRun({text:e.trimEnd(),font:"Consolas",size:20})],shading:{fill:"F5F5F5",type:docx.ShadingType.SOLID},spacing:{before:120,after:120}}));continue}if(e.startsWith("### "))t.push(new docx.Paragraph({children:parseInlineFormatting(e.slice(4)),heading:docx.HeadingLevel.HEADING_3})),a++;else if(e.startsWith("## "))t.push(new docx.Paragraph({children:parseInlineFormatting(e.slice(3)),heading:docx.HeadingLevel.HEADING_2})),a++;else if(e.startsWith("# "))t.push(new docx.Paragraph({children:parseInlineFormatting(e.slice(2)),heading:docx.HeadingLevel.HEADING_1})),a++;else if("---"!==e.trim()&&"***"!==e.trim())if(/^[\-\*] /.test(e))t.push(new docx.Paragraph({children:parseInlineFormatting(e.replace(/^[\-\*] /,"")),bullet:{level:0},spacing:{after:60}})),a++;else if(/^\s{2,}[\-\*] /.test(e))t.push(new docx.Paragraph({children:parseInlineFormatting(e.replace(/^\s+[\-\*] /,"")),bullet:{level:1},spacing:{after:60}})),a++;else if(/^\d+\.\s/.test(e))t.push(new docx.Paragraph({children:parseInlineFormatting(e.replace(/^\d+\.\s/,"")),numbering:{reference:"default-numbering",level:0},spacing:{after:60}})),a++;else if(e.startsWith("> "))t.push(new docx.Paragraph({children:parseInlineFormatting(e.slice(2)),indent:{left:720},border:{left:{style:docx.BorderStyle.SINGLE,size:6,color:"006B3F"}},spacing:{before:60,after:60}})),a++;else{if(e.trim().startsWith("|")&&e.trim().endsWith("|")){const e=[];for(;a<n.length&&n[a].trim().startsWith("|")&&n[a].trim().endsWith("|");)/^\|[\s\-:|]+\|$/.test(n[a].trim())||e.push(n[a]),a++;e.length>=1&&(t.push(buildDocxTable(e)),t.push(new docx.Paragraph({children:[]})));continue}""!==e.trim()?(t.push(new docx.Paragraph({children:parseInlineFormatting(e),spacing:{after:120}})),a++):(t.push(new docx.Paragraph({children:[],spacing:{after:60}})),a++)}else t.push(new docx.Paragraph({children:[],border:{bottom:{style:docx.BorderStyle.SINGLE,size:6,color:"CCCCCC"}},spacing:{before:120,after:120}})),a++}return t}function createGoGHeader(e){const t=state.user&&state.user.department||"Government of Ghana",n=(new Date).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"}),a=[new docx.Paragraph({children:[new docx.TextRun({text:"REPUBLIC OF GHANA",bold:!0,size:28,font:"Calibri",color:"006B3F"})],alignment:docx.AlignmentType.CENTER,spacing:{after:60}}),new docx.Paragraph({children:[new docx.TextRun({text:"‚òÖ",size:48,color:"D4AF37"})],alignment:docx.AlignmentType.CENTER,spacing:{after:60}}),new docx.Paragraph({children:[new docx.TextRun({text:t.toUpperCase(),bold:!0,size:22,font:"Calibri"})],alignment:docx.AlignmentType.CENTER,spacing:{after:120}})];return["memo","cabinet_memo","letter","brief"].includes(e)&&a.push(new docx.Paragraph({children:[new docx.TextRun({text:"Date: "+n,size:20,color:"333333"})],alignment:docx.AlignmentType.RIGHT,spacing:{after:40}})),a.push(new docx.Paragraph({children:[],border:{bottom:{style:docx.BorderStyle.DOUBLE,size:6,color:"006B3F"}},spacing:{after:200}})),new docx.Header({children:a})}function createGoGFooter(){const e=(new Date).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"});return new docx.Footer({children:[new docx.Paragraph({children:[],border:{top:{style:docx.BorderStyle.SINGLE,size:4,color:"006B3F"}},spacing:{before:100}}),new docx.Paragraph({children:[new docx.TextRun({text:"Generated by AskOzzy",size:16,color:"999999",font:"Calibri"}),new docx.TextRun({text:"    |    ",size:16,color:"999999"}),new docx.TextRun({text:e,size:16,color:"999999",font:"Calibri"}),new docx.TextRun({text:"    |    Page ",size:16,color:"999999"}),new docx.TextRun({children:[docx.PageNumber.CURRENT],size:16,color:"999999"}),new docx.TextRun({text:" of ",size:16,color:"999999"}),new docx.TextRun({children:[docx.PageNumber.TOTAL_PAGES],size:16,color:"999999"})],alignment:docx.AlignmentType.CENTER})]})}function _buildGoGDocx(e,t){const n=detectDocumentType(e);return new docx.Document({creator:"AskOzzy - GoG AI Assistant",title:t||"AskOzzy Document",numbering:{config:[{reference:"default-numbering",levels:[{level:0,format:docx.LevelFormat.DECIMAL,text:"%1.",alignment:docx.AlignmentType.START,style:{paragraph:{indent:{left:720,hanging:360}}}}]}]},styles:GOG_DOCX_STYLES,sections:[{properties:{page:{margin:{top:1440,right:1080,bottom:1440,left:1080}}},headers:{default:createGoGHeader(n)},footers:{default:createGoGFooter()},children:markdownToDocxElements(e)}]})}async function downloadMessageDoc(e){const t=state.messages[e];if(!t)return;try{await loadDocxJs();const n=_buildGoGDocx(t.content,_getMessageFilename(e,"").replace(/\.$/,""));return void _triggerDownload(await docx.Packer.toBlob(n),_getMessageFilename(e,"docx"))}catch(e){console.error("DOCX generation failed, using fallback:",e)}const n=`<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">\n<head><meta charset="utf-8"><title>AskOzzy Document</title>\n<style>body{font-family:Calibri,Arial,sans-serif;font-size:12pt;line-height:1.6;color:#1a1a1a;max-width:700px;margin:40px auto;padding:0 20px}h1{font-size:18pt;color:#006B3F}h2{font-size:16pt;color:#006B3F}h3{font-size:14pt;color:#333}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ccc;padding:8px}th{background:#f0f0f0;font-weight:bold}</style></head>\n<body>${renderMarkdown(t.content)}</body></html>`;_triggerDownload(new Blob([n],{type:"application/msword"}),_getMessageFilename(e,"doc"))}function printMessage(e){const t=state.messages[e];if(!t)return;const n=window.open("","_blank");if(!n)return void alert("Please allow popups to print.");const a=state.user&&state.user.department||"",i=(new Date).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"});n.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>AskOzzy ‚Äî Print</title>\n<style>body{font-family:Georgia,'Times New Roman',serif;font-size:12pt;line-height:1.7;color:#1a1a1a;max-width:700px;margin:40px auto;padding:0 20px}h1{font-size:18pt;color:#006B3F;border-bottom:2px solid #006B3F;padding-bottom:4px}h2{font-size:16pt;color:#006B3F}h3{font-size:14pt;color:#333}pre{background:#f5f5f5;padding:12px;border:1px solid #ddd;border-radius:4px;font-family:Consolas,monospace;font-size:10pt;white-space:pre-wrap}code{font-family:Consolas,monospace;font-size:10pt;background:#f5f5f5;padding:2px 4px}blockquote{border-left:3px solid #006B3F;padding-left:12px;color:#555;font-style:italic}table{border-collapse:collapse;width:100%}th,td{border:1px solid #999;padding:8px;text-align:left}th{background:#eee;font-weight:bold}.gog-header{text-align:center;margin-bottom:24px;padding-bottom:12px;border-bottom:3px double #006B3F}.gog-header .republic{font-size:16pt;font-weight:bold;color:#006B3F;letter-spacing:2px;margin-bottom:4px}.gog-header .star{font-size:32pt;color:#D4AF37;line-height:1.2}.gog-header .dept{font-size:11pt;font-weight:bold;color:#333;text-transform:uppercase;letter-spacing:1px}.footer{margin-top:40px;padding-top:12px;border-top:1px solid #006B3F;font-size:9pt;color:#999;text-align:center}@media print{body{margin:0;padding:20px}}</style>\n</head><body>\n<div class="gog-header">\n  <div class="republic">REPUBLIC OF GHANA</div>\n  <div class="star">‚òÖ</div>\n  ${a?'<div class="dept">'+escapeHtml(a)+"</div>":""}\n  <div style="font-size:10pt;color:#666;margin-top:8px">${i}</div>\n</div>\n${renderMarkdown(t.content)}\n<div class="footer">Generated by AskOzzy &mdash; ${i}</div>\n</body></html>`),n.document.close(),setTimeout(()=>n.print(),300)}function handleInputKeydown(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendMessage())}function autoResizeInput(){const e=document.getElementById("chat-input");e.style.height="24px",e.style.height=Math.min(e.scrollHeight,200)+"px",updateSendButton()}function updateSendButton(){const e=document.getElementById("chat-input");document.getElementById("btn-send").disabled=!e.value.trim()||state.isStreaming}function onModelChange(){const e=document.getElementById("model-selector"),t=e.value;if("free"===(state.user&&state.user.tier||"free")&&!["@cf/openai/gpt-oss-20b","@cf/google/gemma-3-12b-it","@cf/meta/llama-3.1-8b-instruct-fast"].includes(t)){const t=isStudent()?25:60;return alert(`This model requires a paid plan.\n\nUpgrade to Professional (GHS ${t}/mo) or higher to access all 11 AI models.`),e.value=state.selectedModel,void openPricingModal()}state.selectedModel=t}function toggleSidebar(){const e=document.getElementById("sidebar");e.classList.toggle("collapsed");const t=document.getElementById("sidebar-backdrop");e.classList.contains("collapsed")?t&&t.classList.remove("active"):window.innerWidth<=768&&t&&t.classList.add("active")}function renderCategoryTabs(){const e=document.getElementById("category-tabs"),t=["All",...getPersonaCategories().map(e=>e.id)];e.innerHTML=t.map(e=>`<button class="category-tab ${e===state.activeCategory?"active":""}"\n              onclick="filterTemplates('${e}')">${e}</button>`).join("")}function filterTemplates(e){state.activeCategory=e,renderCategoryTabs(),renderTemplateGrid()}function renderTemplateGrid(){const e=document.getElementById("template-grid"),t=getPersonaTemplates(),n="All"===state.activeCategory?t:t.filter(e=>e.category===state.activeCategory),a="All"===state.activeCategory?'\n    <div class="template-card template-card--guide-cta" onclick="openGuide()">\n      <span class="guide-cta-sparkle">NEW</span>\n      <div class="card-icon">üá¨üá≠</div>\n      <div class="card-title">Explore User Guide</div>\n      <div class="card-desc">Discover 49+ features, shortcuts, and tips to master AskOzzy</div>\n    </div>':"";e.innerHTML=a+n.map(e=>`\n    <div class="template-card" onclick="selectTemplate('${e.id}')">\n      <div class="card-icon">${e.icon}</div>\n      <div class="card-title">${e.title}</div>\n      <div class="card-desc">${e.description}</div>\n    </div>`).join("")}function selectTemplate(e){requireAuth(createNewChat,e)}function openTemplateModal(){document.getElementById("template-modal").classList.add("active"),renderModalCategories(),renderModalTemplates("All")}function closeTemplateModal(){document.getElementById("template-modal").classList.remove("active")}function renderModalCategories(){const e=document.getElementById("modal-categories"),t=["All",...getPersonaCategories().map(e=>e.id)];e.innerHTML=t.map(e=>`<button class="category-tab ${"All"===e?"active":""}"\n              onclick="filterModalTemplates('${e}', this)">${e}</button>`).join("")}function filterModalTemplates(e,t){document.querySelectorAll("#modal-categories .category-tab").forEach(e=>e.classList.remove("active")),t&&t.classList.add("active"),renderModalTemplates(e)}function renderModalTemplates(e){const t=document.getElementById("modal-template-list"),n=getPersonaTemplates(),a="All"===e?n:n.filter(t=>t.category===e);t.innerHTML=a.map(e=>`\n    <div class="modal-template-item" onclick="selectTemplate('${e.id}')">\n      <div class="tpl-icon">${e.icon}</div>\n      <div class="tpl-info">\n        <div class="tpl-title">${e.title}</div>\n        <div class="tpl-desc">${e.description}</div>\n      </div>\n      <div class="tpl-arrow">‚Üí</div>\n    </div>`).join("")}function renderMarkdown(e){if(!e)return"";let t=e;return t=t.replace(/```(\w+)?\n([\s\S]*?)```/g,(e,t,n)=>`<pre><code class="language-${t||""}">${escapeHtml(n.trim())}</code></pre>`),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*(.+?)\*/g,"<em>$1</em>"),t=t.replace(/^### (.+)$/gm,"<h3>$1</h3>"),t=t.replace(/^## (.+)$/gm,"<h2>$1</h2>"),t=t.replace(/^# (.+)$/gm,"<h1>$1</h1>"),t=t.replace(/^[\-\*] (.+)$/gm,"<li>$1</li>"),t=t.replace(/((?:<li>.*<\/li>\n?)+)/g,"<ul>$1</ul>"),t=t.replace(/^\d+\. (.+)$/gm,"<li>$1</li>"),t=t.replace(/^> (.+)$/gm,"<blockquote>$1</blockquote>"),t=t.replace(/^---$/gm,"<hr>"),t=t.replace(/\|(.+)\|\n\|[-| ]+\|\n((?:\|.+\|\n?)*)/g,(e,t,n)=>`<table><thead><tr>${t.split("|").filter(e=>e.trim()).map(e=>`<th>${e.trim()}</th>`).join("")}</tr></thead><tbody>${n.trim().split("\n").map(e=>`<tr>${e.split("|").filter(e=>e.trim()).map(e=>`<td>${e.trim()}</td>`).join("")}</tr>`).join("")}</tbody></table>`),t=t.replace(/\n\n/g,"</p><p>"),t=t.replace(/(?<!<\/?\w+[^>]*)\n(?!<)/g,"<br>"),t.startsWith("<")||(t=`<p>${t}</p>`),t}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}window.innerWidth>768&&document.getElementById("sidebar").classList.remove("collapsed"),document.addEventListener("DOMContentLoaded",()=>{const e=document.createElement("div");e.id="sidebar-backdrop",e.className="sidebar-backdrop",e.addEventListener("click",()=>{document.getElementById("sidebar").classList.add("collapsed"),e.classList.remove("active")}),document.body.appendChild(e)}),document.getElementById("template-modal").addEventListener("click",e=>{e.target===e.currentTarget&&closeTemplateModal()});let affiliateData=null,affiliateTab="overview",affiliateTxPage=1,affiliateEarningsChart=null;async function openAffiliateModal(){const e=document.getElementById("affiliate-modal"),t=document.getElementById("affiliate-modal-body");t.innerHTML='<div style="text-align:center;padding:40px;"><div class="spinner"></div><p style="margin-top:12px;color:var(--text-muted);font-size:13px;">Loading your affiliate dashboard...</p></div>',e.classList.add("active");try{const e=await fetch("/api/affiliate/dashboard",{headers:authHeaders()}),t=await e.json();if(!e.ok)throw new Error(t.error);affiliateData=t,affiliateTab="overview",affiliateTxPage=1,renderAffiliateDashboard()}catch(e){t.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-muted);">Failed to load affiliate data. Please try again.</div>'}}function renderAffiliateDashboard(){document.getElementById("affiliate-modal-body").innerHTML=`\n    <div class="affiliate-tabs">\n      <button class="affiliate-tab ${"overview"===affiliateTab?"active":""}" onclick="switchAffiliateTab('overview')">Overview</button>\n      <button class="affiliate-tab ${"earnings"===affiliateTab?"active":""}" onclick="switchAffiliateTab('earnings')">Earnings</button>\n      <button class="affiliate-tab ${"network"===affiliateTab?"active":""}" onclick="switchAffiliateTab('network')">My Network</button>\n      <button class="affiliate-tab ${"withdraw"===affiliateTab?"active":""}" onclick="switchAffiliateTab('withdraw')">Withdraw</button>\n      <button class="affiliate-tab ${"leaderboard"===affiliateTab?"active":""}" onclick="switchAffiliateTab('leaderboard')">Leaderboard</button>\n    </div>\n    <div class="affiliate-tab-content" id="affiliate-tab-content"></div>\n  `,renderAffiliateTabContent()}function switchAffiliateTab(e){affiliateTab=e,document.querySelectorAll(".affiliate-tab").forEach(t=>{t.classList.toggle("active",t.textContent.trim().toLowerCase()===e)}),renderAffiliateTabContent()}function renderAffiliateTabContent(){const e=document.getElementById("affiliate-tab-content");if(e)switch(affiliateTab){case"overview":renderAffiliateOverview(e);break;case"earnings":renderAffiliateEarnings(e);break;case"network":renderAffiliateNetwork(e);break;case"withdraw":renderAffiliateWithdraw(e);break;case"leaderboard":renderAffiliateLeaderboard(e)}}function renderAffiliateOverview(e){const t=affiliateData,n=t.wallet||0,a=t.stats||{},i=t.referralCode||"",o=`${window.location.origin}?ref=${i}`,s=a.directReferrals||t.totalReferrals||0,r=a.payingReferrals||0,l=a.thisMonthEarnings||0,c=a.secondLevelEarnings||0,d=encodeURIComponent(`Try AskOzzy - Ghana's AI Assistant for Government! Use my code ${i} and get GHS 5 bonus. ${o}`);e.innerHTML=`\n    <div class="affiliate-overview-wrap">\n      \x3c!-- Wallet Card --\x3e\n      <div class="affiliate-wallet-card">\n        <div class="affiliate-wallet-label">Available Balance</div>\n        <div class="affiliate-wallet-amount">GHS ${("number"==typeof n?n:0).toFixed(2)}</div>\n        <div class="affiliate-wallet-sub">Earn 30% on every referral payment</div>\n      </div>\n\n      \x3c!-- Stats Grid --\x3e\n      <div class="affiliate-stats-grid">\n        <div class="affiliate-stat-card">\n          <div class="affiliate-stat-value">${s}</div>\n          <div class="affiliate-stat-label">Direct Referrals</div>\n        </div>\n        <div class="affiliate-stat-card">\n          <div class="affiliate-stat-value">${r}</div>\n          <div class="affiliate-stat-label">Paying Referrals</div>\n        </div>\n        <div class="affiliate-stat-card">\n          <div class="affiliate-stat-value">GHS ${l.toFixed(2)}</div>\n          <div class="affiliate-stat-label">This Month</div>\n        </div>\n        <div class="affiliate-stat-card">\n          <div class="affiliate-stat-value">GHS ${c.toFixed(2)}</div>\n          <div class="affiliate-stat-label">2nd Level Earnings</div>\n        </div>\n      </div>\n\n      \x3c!-- Passive Income Projector --\x3e\n      <div class="income-projector">\n        <div class="income-projector-header">\n          <div class="income-projector-icon">\n            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>\n          </div>\n          <div>\n            <div class="income-projector-title">Your Passive Income Potential</div>\n            <div class="income-projector-sub">See how much you could earn monthly</div>\n          </div>\n        </div>\n\n        <div class="income-slider-section">\n          <label class="income-slider-label">\n            If you refer <span class="income-slider-count" id="income-ref-count">10</span> paying users:\n          </label>\n          <input type="range" min="1" max="100" value="10" class="income-slider" id="income-slider" oninput="updateIncomeProjection()" />\n          <div class="income-slider-range">\n            <span>1</span><span>25</span><span>50</span><span>75</span><span>100</span>\n          </div>\n        </div>\n\n        <div class="income-breakdown" id="income-breakdown">\n          ${buildIncomeBreakdown(10)}\n        </div>\n\n        <div class="income-how-it-works">\n          <div class="income-how-item">\n            <span class="income-how-num">1</span>\n            <span>Share your link &rarr; They subscribe</span>\n          </div>\n          <div class="income-how-item">\n            <span class="income-how-num">2</span>\n            <span>You earn <strong>30%</strong> of every payment, every month</span>\n          </div>\n          <div class="income-how-item">\n            <span class="income-how-num">3</span>\n            <span>When they refer others &rarr; You earn <strong>5%</strong> too</span>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Referral Code --\x3e\n      <div class="affiliate-ref-section">\n        <div class="affiliate-ref-label">Your Referral Code</div>\n        <div class="affiliate-ref-row">\n          <input type="text" value="${escapeHtml(i)}" readonly class="affiliate-ref-code-input" />\n          <button onclick="copyToClipboard('${i}', this)" class="affiliate-copy-btn">Copy</button>\n        </div>\n      </div>\n\n      \x3c!-- Referral Link --\x3e\n      <div class="affiliate-ref-section">\n        <div class="affiliate-ref-label">Your Referral Link</div>\n        <div class="affiliate-ref-row">\n          <input type="text" value="${escapeHtml(o)}" readonly class="affiliate-ref-link-input" />\n          <button onclick="copyToClipboard('${o}', this)" class="affiliate-copy-btn">Copy</button>\n        </div>\n      </div>\n\n      \x3c!-- Share Buttons --\x3e\n      <div class="affiliate-share-row">\n        <a href="https://wa.me/?text=${d}" target="_blank" rel="noopener" class="affiliate-share-btn whatsapp">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>\n          WhatsApp\n        </a>\n        <a href="sms:?body=${d}" class="affiliate-share-btn sms">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>\n          SMS\n        </a>\n        <button onclick="copyToClipboard('${o}', this)" class="affiliate-share-btn copy-link">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>\n          Copy Link\n        </button>\n      </div>\n\n      \x3c!-- Milestones --\x3e\n      <div class="affiliate-milestones-section">\n        <div class="affiliate-milestones-title">Milestone Rewards</div>\n        ${[{target:10,reward:"GHS 30 bonus",bonus:"GHS 30 bonus",icon:"$"},{target:25,reward:"1 month Professional free",bonus:"GHS 60 bonus",icon:"P"},{target:50,reward:"Permanent 50% discount",bonus:"GHS 100 bonus",icon:"D"},{target:100,reward:"Free Enterprise for life",bonus:"GHS 200 bonus",icon:"E"}].map(e=>{const t=s>=e.target,n=Math.min(100,s/e.target*100);return`\n          <div class="affiliate-milestone ${t?"achieved":""}">\n            <div class="affiliate-milestone-header">\n              <span class="affiliate-milestone-icon">${t?'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--flag-green)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>':e.icon}</span>\n              <span class="affiliate-milestone-label">${e.target} referrals &mdash; ${e.reward}</span>\n              <span class="affiliate-milestone-bonus">${e.bonus}</span>\n            </div>\n            <div class="affiliate-milestone-bar">\n              <div class="affiliate-milestone-fill" style="width:${n}%"></div>\n            </div>\n            <div class="affiliate-milestone-count">${Math.min(s,e.target)} / ${e.target}</div>\n          </div>`}).join("")}\n      </div>\n    </div>\n  `}function buildIncomeBreakdown(e){const t=Math.round(.7*e),n=e-t,a=60*t*.3+100*n*.3,i=2*e,o=Math.round(.7*i),s=60*o*.05+100*(i-o)*.05,r=a+s,l=12*r;return`\n    <div class="income-cards-row">\n      <div class="income-card income-card-l1">\n        <div class="income-card-emoji">\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>\n        </div>\n        <div class="income-card-label">Direct (30%)</div>\n        <div class="income-card-amount">GHS ${a.toFixed(0)}</div>\n        <div class="income-card-detail">${t} Pro + ${n} Ent</div>\n      </div>\n      <div class="income-card income-card-plus">+</div>\n      <div class="income-card income-card-l2">\n        <div class="income-card-emoji">\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>\n        </div>\n        <div class="income-card-label">Level 2 (5%)</div>\n        <div class="income-card-amount">GHS ${s.toFixed(0)}</div>\n        <div class="income-card-detail">~${i} sub-referrals</div>\n      </div>\n    </div>\n\n    <div class="income-total-card">\n      <div class="income-total-row">\n        <div class="income-total-period">\n          <div class="income-total-label">Monthly</div>\n          <div class="income-total-amount monthly">GHS ${r.toFixed(0)}<span>/mo</span></div>\n        </div>\n        <div class="income-total-divider"></div>\n        <div class="income-total-period">\n          <div class="income-total-label">Yearly</div>\n          <div class="income-total-amount yearly">GHS ${l.toLocaleString()}<span>/yr</span></div>\n        </div>\n      </div>\n      <div class="income-total-note">${e>=20?"That‚Äôs a serious side income!":e>=10?"Enough to cover your own subscription and more!":"Just a few referrals to start earning!"}</div>\n    </div>\n  `}function updateIncomeProjection(){const e=document.getElementById("income-slider"),t=document.getElementById("income-ref-count"),n=document.getElementById("income-breakdown");if(!e||!t||!n)return;const a=parseInt(e.value);t.textContent=a,n.innerHTML=buildIncomeBreakdown(a)}async function renderAffiliateEarnings(e){e.innerHTML='<div style="text-align:center;padding:30px;"><div class="spinner"></div></div>';try{const[t,n]=await Promise.all([fetch(`/api/affiliate/transactions?page=${affiliateTxPage}&limit=20`,{headers:authHeaders()}),Promise.resolve(affiliateData)]),a=await t.json();if(!t.ok)throw new Error(a.error);const i=a.transactions||[],o=a.totalPages||1,s=a.monthlyEarnings||affiliateData.monthlyEarnings||[];e.innerHTML=`\n      <div class="affiliate-earnings-wrap">\n        \x3c!-- Chart --\x3e\n        <div class="affiliate-chart-card">\n          <div class="affiliate-chart-title">Monthly Earnings (Last 6 Months)</div>\n          <canvas id="affiliate-earnings-chart" height="220"></canvas>\n        </div>\n\n        \x3c!-- Transaction History --\x3e\n        <div class="affiliate-tx-section">\n          <div class="affiliate-tx-title">Transaction History</div>\n          ${0===i.length?'<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">No transactions yet. Start referring to earn!</div>':`\n          <div class="affiliate-tx-table-wrap">\n            <table class="affiliate-tx-table">\n              <thead>\n                <tr><th>Date</th><th>Type</th><th>Amount</th><th>Description</th></tr>\n              </thead>\n              <tbody>\n                ${i.map(e=>{const t={commission_l1:{label:"Direct 30%",cls:"l1"},commission_l2:{label:"Level 2 5%",cls:"l2"},bonus:{label:"Bonus",cls:"bonus"},withdrawal:{label:"Withdrawal",cls:"withdrawal"}}[e.type]||{label:e.type,cls:"l1"},n="withdrawal"===e.type;return`<tr>\n                    <td>${e.created_at?new Date(e.created_at+"Z").toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"--"}</td>\n                    <td><span class="affiliate-tx-badge ${t.cls}">${t.label}</span></td>\n                    <td class="${n?"tx-neg":"tx-pos"}">${n?"-":"+"}GHS ${Math.abs(e.amount||0).toFixed(2)}</td>\n                    <td>${escapeHtml(e.description||"")}</td>\n                  </tr>`}).join("")}\n              </tbody>\n            </table>\n          </div>\n          ${o>1?`\n          <div class="affiliate-tx-pagination">\n            <button class="affiliate-page-btn" onclick="affiliateChangeTxPage(${affiliateTxPage-1})" ${affiliateTxPage<=1?"disabled":""}>Prev</button>\n            <span class="affiliate-page-info">Page ${affiliateTxPage} of ${o}</span>\n            <button class="affiliate-page-btn" onclick="affiliateChangeTxPage(${affiliateTxPage+1})" ${affiliateTxPage>=o?"disabled":""}>Next</button>\n          </div>`:""}\n          `}\n        </div>\n      </div>\n    `,s.length>0&&renderAffiliateEarningsChart(s)}catch(t){e.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-muted);">Failed to load earnings data.</div>'}}async function renderAffiliateEarningsChart(e){const t=document.getElementById("affiliate-earnings-chart");if(!t)return;await loadChartJs(),affiliateEarningsChart&&(affiliateEarningsChart.destroy(),affiliateEarningsChart=null);const n=e.map(e=>e.month||e.label||""),a=e.map(e=>e.l1||e.direct||0),i=e.map(e=>e.l2||e.secondLevel||0),o=t.getContext("2d");affiliateEarningsChart=new Chart(o,{type:"bar",data:{labels:n,datasets:[{label:"Direct (30%)",data:a,backgroundColor:"#006B3F",borderRadius:4,barPercentage:.7,categoryPercentage:.6},{label:"Level 2 (5%)",data:i,backgroundColor:"#FCD116",borderRadius:4,barPercentage:.7,categoryPercentage:.6}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{color:getComputedStyle(document.documentElement).getPropertyValue("--text-secondary").trim(),font:{size:11}}}},scales:{x:{stacked:!0,grid:{display:!1},ticks:{color:getComputedStyle(document.documentElement).getPropertyValue("--text-muted").trim(),font:{size:11}}},y:{stacked:!0,grid:{color:getComputedStyle(document.documentElement).getPropertyValue("--border-color").trim()},ticks:{color:getComputedStyle(document.documentElement).getPropertyValue("--text-muted").trim(),font:{size:11},callback:e=>"GHS "+e}}}}})}function affiliateChangeTxPage(e){if(e<1)return;affiliateTxPage=e;const t=document.getElementById("affiliate-tab-content");t&&renderAffiliateEarnings(t)}async function renderAffiliateNetwork(e){e.innerHTML='<div style="text-align:center;padding:30px;"><div class="spinner"></div></div>';try{const t=await fetch("/api/affiliate/dashboard",{headers:authHeaders()}),n=await t.json();if(!t.ok)throw new Error(n.error);const a=n.recentReferrals||n.referrals||[],i=n.stats?(n.stats.directReferrals||0)+(n.stats.secondLevelCount||0):a.length;e.innerHTML=`\n      <div class="affiliate-network-wrap">\n        <div class="affiliate-network-header">\n          <span class="affiliate-network-size">Total Network: <strong>${i}</strong> people</span>\n        </div>\n\n        ${0===a.length?'<div style="text-align:center;padding:30px;color:var(--text-muted);font-size:13px;">No referrals yet. Share your link to grow your network!</div>':`\n        <div class="affiliate-network-tree">\n          ${a.map(e=>`\n            <div class="affiliate-network-node">\n              <div class="affiliate-network-person">\n                <div class="affiliate-network-avatar">${(e.full_name||"?").charAt(0).toUpperCase()}</div>\n                <div class="affiliate-network-info">\n                  <div class="affiliate-network-name">${escapeHtml(e.full_name||"Unknown")}</div>\n                  <div class="affiliate-network-meta">\n                    <span class="affiliate-network-tier tier-${e.tier||"free"}">${e.tier||"free"}</span>\n                    <span class="affiliate-network-status ${e.is_paying?"active":"free-status"}">${e.is_paying?"Active":"Free"}</span>\n                    <span class="affiliate-network-date">Joined ${e.joined_at?new Date(e.joined_at+"Z").toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"--"}</span>\n                  </div>\n                </div>\n              </div>\n              ${e.sub_referrals&&e.sub_referrals.length>0?`\n              <div class="affiliate-network-children">\n                ${e.sub_referrals.map(e=>`\n                  <div class="affiliate-network-child">\n                    <div class="affiliate-network-avatar small">${(e.full_name||"?").charAt(0).toUpperCase()}</div>\n                    <div class="affiliate-network-info">\n                      <div class="affiliate-network-name">${escapeHtml(e.full_name||"Unknown")}</div>\n                      <div class="affiliate-network-meta">\n                        <span class="affiliate-network-tier tier-${e.tier||"free"}">${e.tier||"free"}</span>\n                        <span class="affiliate-network-status ${e.is_paying?"active":"free-status"}">${e.is_paying?"Active":"Free"}</span>\n                      </div>\n                    </div>\n                  </div>\n                `).join("")}\n              </div>`:""}\n            </div>\n          `).join("")}\n        </div>\n        `}\n      </div>\n    `}catch(t){e.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-muted);">Failed to load network data.</div>'}}async function renderAffiliateWithdraw(e){e.innerHTML='<div style="text-align:center;padding:30px;"><div class="spinner"></div></div>';const t=affiliateData.wallet||0;try{const n=await fetch("/api/affiliate/transactions?page=1&limit=50",{headers:authHeaders()}),a=((await n.json()).transactions||[]).filter(e=>"withdrawal"===e.type);e.innerHTML=`\n      <div class="affiliate-withdraw-wrap">\n        \x3c!-- Balance Display --\x3e\n        <div class="affiliate-wallet-card" style="margin-bottom:24px;">\n          <div class="affiliate-wallet-label">Available for Withdrawal</div>\n          <div class="affiliate-wallet-amount">GHS ${t.toFixed(2)}</div>\n          <div class="affiliate-wallet-sub">Minimum withdrawal: GHS 20.00</div>\n        </div>\n\n        \x3c!-- Withdrawal Form --\x3e\n        <div class="withdraw-form">\n          <div class="withdraw-form-title">Request Withdrawal</div>\n          <div class="withdraw-form-group">\n            <label>Amount (GHS)</label>\n            <div class="withdraw-amount-row">\n              <input type="number" id="withdraw-amount" min="20" max="${t}" step="0.01" placeholder="Enter amount" class="withdraw-input" />\n              <button onclick="document.getElementById('withdraw-amount').value='${t.toFixed(2)}'" class="withdraw-all-btn">Withdraw All</button>\n            </div>\n          </div>\n          <div class="withdraw-form-group">\n            <label>MoMo Number</label>\n            <div class="withdraw-momo-row">\n              <span class="withdraw-country-code">+233</span>\n              <input type="tel" id="withdraw-momo" placeholder="24XXXXXXX" maxlength="10" class="withdraw-input momo-input" />\n            </div>\n          </div>\n          <div class="withdraw-form-group">\n            <label>Network</label>\n            <select id="withdraw-network" class="withdraw-input">\n              <option value="">Select network</option>\n              <option value="MTN">MTN Mobile Money</option>\n              <option value="Vodafone">Vodafone Cash</option>\n              <option value="AirtelTigo">AirtelTigo Money</option>\n            </select>\n          </div>\n          <div id="withdraw-error" class="withdraw-error" style="display:none;"></div>\n          <button onclick="submitWithdrawal()" class="withdraw-submit-btn" id="withdraw-submit-btn">Request Withdrawal</button>\n        </div>\n\n        \x3c!-- Withdrawal History --\x3e\n        <div class="affiliate-tx-section" style="margin-top:24px;">\n          <div class="affiliate-tx-title">Withdrawal History</div>\n          ${0===a.length?'<div style="text-align:center;padding:16px;color:var(--text-muted);font-size:13px;">No withdrawals yet.</div>':`\n          <div class="affiliate-tx-table-wrap">\n            <table class="affiliate-tx-table">\n              <thead>\n                <tr><th>Date</th><th>Amount</th><th>MoMo Number</th><th>Status</th></tr>\n              </thead>\n              <tbody>\n                ${a.map(e=>{const t=e.created_at?new Date(e.created_at+"Z").toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"--",n=e.status||"pending";return`<tr>\n                    <td>${t}</td>\n                    <td>GHS ${Math.abs(e.amount||0).toFixed(2)}</td>\n                    <td>${escapeHtml(e.momo_number||e.description||"--")}</td>\n                    <td><span class="withdraw-status-badge ${n}">${n.charAt(0).toUpperCase()+n.slice(1)}</span></td>\n                  </tr>`}).join("")}\n              </tbody>\n            </table>\n          </div>\n          `}\n        </div>\n      </div>\n    `}catch(n){e.innerHTML=`\n      <div class="affiliate-withdraw-wrap">\n        <div class="affiliate-wallet-card" style="margin-bottom:24px;">\n          <div class="affiliate-wallet-label">Available for Withdrawal</div>\n          <div class="affiliate-wallet-amount">GHS ${t.toFixed(2)}</div>\n        </div>\n        <div class="withdraw-form">\n          <div class="withdraw-form-title">Request Withdrawal</div>\n          <div class="withdraw-form-group">\n            <label>Amount (GHS)</label>\n            <div class="withdraw-amount-row">\n              <input type="number" id="withdraw-amount" min="20" max="${t}" step="0.01" placeholder="Enter amount" class="withdraw-input" />\n              <button onclick="document.getElementById('withdraw-amount').value='${t.toFixed(2)}'" class="withdraw-all-btn">Withdraw All</button>\n            </div>\n          </div>\n          <div class="withdraw-form-group">\n            <label>MoMo Number</label>\n            <div class="withdraw-momo-row">\n              <span class="withdraw-country-code">+233</span>\n              <input type="tel" id="withdraw-momo" placeholder="24XXXXXXX" maxlength="10" class="withdraw-input momo-input" />\n            </div>\n          </div>\n          <div class="withdraw-form-group">\n            <label>Network</label>\n            <select id="withdraw-network" class="withdraw-input">\n              <option value="">Select network</option>\n              <option value="MTN">MTN Mobile Money</option>\n              <option value="Vodafone">Vodafone Cash</option>\n              <option value="AirtelTigo">AirtelTigo Money</option>\n            </select>\n          </div>\n          <div id="withdraw-error" class="withdraw-error" style="display:none;"></div>\n          <button onclick="submitWithdrawal()" class="withdraw-submit-btn" id="withdraw-submit-btn">Request Withdrawal</button>\n        </div>\n      </div>\n    `}}async function submitWithdrawal(){const e=parseFloat(document.getElementById("withdraw-amount").value),t=document.getElementById("withdraw-momo").value.trim(),n=document.getElementById("withdraw-network").value,a=document.getElementById("withdraw-error"),i=document.getElementById("withdraw-submit-btn");if(a.style.display="none",!e||e<20)return a.textContent="Minimum withdrawal is GHS 20.00",void(a.style.display="block");if(e>(affiliateData.wallet||0))return a.textContent="Amount exceeds your available balance",void(a.style.display="block");if(!t||t.length<9)return a.textContent="Please enter a valid MoMo number",void(a.style.display="block");if(!n)return a.textContent="Please select a mobile money network",void(a.style.display="block");i.disabled=!0,i.textContent="Processing...";try{const a=await fetch("/api/affiliate/withdraw",{method:"POST",headers:authHeaders(),body:JSON.stringify({amount:e,momo_number:"+233"+t.replace(/^0/,""),momo_network:n})}),i=await a.json();if(!a.ok)throw new Error(i.error||"Withdrawal failed");affiliateData.wallet=(affiliateData.wallet||0)-e;const o=document.getElementById("affiliate-tab-content");o&&renderAffiliateWithdraw(o),setTimeout(()=>{const e=document.getElementById("withdraw-error");e&&(e.textContent="Withdrawal request submitted successfully! You will receive your funds within 24-48 hours.",e.style.display="block",e.style.color="var(--green-light)",e.style.background="rgba(0,168,107,0.1)",e.style.borderColor="rgba(0,168,107,0.3)")},100)}catch(e){a.textContent=e.message||"Withdrawal failed. Please try again.",a.style.display="block",i.disabled=!1,i.textContent="Request Withdrawal"}}async function renderAffiliateLeaderboard(e){e.innerHTML='<div style="text-align:center;padding:30px;"><div class="spinner"></div></div>';try{const t=await fetch("/api/affiliate/leaderboard",{headers:authHeaders()}),n=await t.json();if(!t.ok)throw new Error(n.error);const a=n.leaderboard||[],i=n.myRank||null;e.innerHTML=`\n      <div class="affiliate-leaderboard-wrap">\n        <div class="affiliate-leaderboard-title">Top Affiliates</div>\n        ${i?`\n        <div class="affiliate-leaderboard-myrank">\n          Your rank: <strong>#${i.rank}</strong> with ${i.referrals||0} referrals and GHS ${(i.earnings||0).toFixed(2)} earned\n        </div>`:""}\n        <div class="affiliate-leaderboard-list">\n          ${0===a.length?'<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">No leaderboard data yet.</div>':a.map((e,t)=>{const n=t+1;return`\n            <div class="affiliate-leaderboard-row ${1===n?"gold":2===n?"silver":3===n?"bronze":""} ${e.is_current_user||!1?"is-me":""}">\n              <div class="affiliate-leaderboard-rank">${n<=3?["&#x1F947;","&#x1F948;","&#x1F949;"][n-1]:"#"+n}</div>\n              <div class="affiliate-leaderboard-name">${escapeHtml(e.name||"Anonymous")}</div>\n              <div class="affiliate-leaderboard-stats">\n                <span>${e.referrals||0} referrals</span>\n                <span>GHS ${(e.earnings||0).toFixed(2)}</span>\n              </div>\n            </div>`}).join("")}\n        </div>\n      </div>\n    `}catch(t){e.innerHTML='<div style="text-align:center;padding:30px;color:var(--text-muted);">Failed to load leaderboard.</div>'}}function closeAffiliateModal(){document.getElementById("affiliate-modal").classList.remove("active"),affiliateEarningsChart&&(affiliateEarningsChart.destroy(),affiliateEarningsChart=null)}function copyToClipboard(e,t){navigator.clipboard.writeText(e).then(()=>{const e=t||event.target,n=e.textContent;e.textContent="Copied!",e.style.background="var(--green-light)",e.style.color="#fff",setTimeout(()=>{e.textContent=n,e.style.background="",e.style.color=""},2e3)})}async function loadUsageStatus(){if(isLoggedIn())try{const e=await fetch("/api/usage/status",{headers:authHeaders()});if(!e.ok)return;const t=await e.json();state.user.tier=t.tier,localStorage.setItem("askozzy_user",JSON.stringify(state.user)),updateUsageBadge(t)}catch{}else updateUsageBadge(null)}function updateUsageBadge(e){const t=document.getElementById("usage-badge");if(!t)return;if(!e)return void(t.style.display="none");t.style.display="flex";const n=e.tierName||"Free";if(-1===e.limit)t.textContent=`${n} ‚Äî Unlimited`,t.className="usage-badge";else{const a=e.used/e.limit*100;t.textContent=`${n} ‚Äî ${e.remaining}/${e.limit} left`,t.className="usage-badge"+(a>=90?" danger":a>=70?" warning":"")}}function showLimitReachedBanner(e){const t=document.querySelector(".limit-banner");t&&t.remove();const n=document.createElement("div");n.className="limit-banner",n.innerHTML=`\n    <span>You've reached your daily limit of ${e.limit} messages.</span>\n    <button class="btn-upgrade-inline" onclick="openPricingModal()">Upgrade Plan</button>\n  `;document.querySelector(".main-content").querySelector(".main-header").after(n),loadUsageStatus()}async function openPricingModal(){const e=document.getElementById("pricing-modal"),t=document.getElementById("pricing-modal-body");t.innerHTML='<div style="text-align:center;padding:40px;"><div class="spinner"></div></div>',e.classList.add("active");try{const e={};state.token&&(e.Authorization=`Bearer ${state.token}`);const n=await fetch("/api/pricing",{headers:e}),a=await n.json(),i=state.user&&state.user.tier||"free",o=a.isStudentPricing;t.innerHTML=`\n      ${o?'<div class="student-discount-banner"><span>üéì</span> Student pricing applied ‚Äî save up to 58%!</div>':""}\n      <div class="pricing-grid">\n        ${a.plans.map(e=>{const t=e.id===i,n=getPlanOrder(e.id)<getPlanOrder(i),a=o&&e.standardPrice>0&&e.price<e.standardPrice;return`\n          <div class="pricing-card ${e.popular&&!t?"popular":""} ${t?"current":""}">\n            <div class="pricing-name">${e.name}</div>\n            <div class="pricing-price">\n              ${0===e.price?"Free":`GHS ${e.price}`}\n              ${e.price>0?"<span>/month</span>":""}\n            </div>\n            ${a?`<div class="pricing-original-price">was GHS ${e.standardPrice}/month</div>`:""}\n            <ul class="pricing-features">\n              ${e.features.map(e=>`<li>${e}</li>`).join("")}\n            </ul>\n            ${t?'<button class="btn-pricing current-btn">Current Plan</button>':n?"":`<button class="btn-pricing ${e.popular?"primary":"secondary"}" onclick="upgradeToPlan('${e.id}', '${e.name}', ${e.price})">${0===e.price?"Get Started":"Upgrade to "+e.name}</button>`}\n          </div>`}).join("")}\n      </div>\n      <div style="text-align:center;margin-top:20px;font-size:12px;color:var(--text-muted);">\n        All prices in Ghana Cedis (GHS). Cancel anytime. Payment via Mobile Money or card.\n      </div>`;const s=state.user&&state.user.trialExpiresAt,r=s&&new Date(s)>new Date;if("free"===i&&!s){const e=t.querySelector(".pricing-grid");if(e){const t=document.createElement("div");t.className="trial-banner",t.innerHTML='\n          <div class="trial-banner-icon">üéÅ</div>\n          <div class="trial-banner-text">\n            <div class="trial-banner-title">Try Professional FREE for 3 days</div>\n            <div class="trial-banner-sub">Full access to all 11 AI models, 200 messages/day, and every premium feature. No card needed.</div>\n          </div>\n          <button class="trial-banner-btn" onclick="activateFreeTrial()">Start Free Trial</button>\n        ',e.parentNode.insertBefore(t,e)}}else if(r){const e=new Date(s),n=Math.max(0,Math.round((e-Date.now())/36e5)),a=t.querySelector(".pricing-grid");if(a){const e=document.createElement("div");e.className="trial-banner trial-active",e.innerHTML=`\n          <div class="trial-banner-icon">‚ö°</div>\n          <div class="trial-banner-text">\n            <div class="trial-banner-title">Professional Trial Active</div>\n            <div class="trial-banner-sub">${n} hours remaining ‚Äî upgrade now to keep all features</div>\n          </div>\n          <button class="trial-banner-btn" onclick="upgradeToPlan('professional','Professional',${o?25:60})">Upgrade Now</button>\n        `,a.parentNode.insertBefore(e,a)}}}catch{t.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-muted);">Failed to load pricing. Please try again.</div>'}}function getPlanOrder(e){return{free:0,professional:1,enterprise:2}[e]||0}function closePricingModal(){document.getElementById("pricing-modal").classList.remove("active")}async function upgradeToPlan(e,t,n){await initPaystackPayment(e,t,n)}function openGuide(e){let t=document.getElementById("guide-modal");t||(t=document.createElement("div"),t.className="guide-modal-fullscreen",t.id="guide-modal",t.innerHTML=buildGuideHTML(),document.body.appendChild(t),t.addEventListener("click",e=>{e.target===t&&closeGuide()}),initGuideNavigation()),t.classList.remove("closing"),t.classList.add("active"),updateGuideTierHighlights(),updateGuideProgress(),setTimeout(()=>playGuideSparkle(),200),e&&setTimeout(()=>scrollGuideToSection(e),150)}function closeGuide(){const e=document.getElementById("guide-modal");e&&e.classList.contains("active")&&(e.classList.add("closing"),setTimeout(()=>{e.classList.remove("active","closing")},200))}function buildGuideHTML(){const e=state.user&&state.user.tier||"free",t={free:"Free",professional:"Professional",enterprise:"Enterprise"}[e]||"Free",n=GUIDE_SECTIONS.map(e=>{const t=GUIDE_SECTION_EMOJIS[e.id],n=t?t.emoji:"";return`<button class="guide-nav-item" data-section="${e.id}" onclick="scrollGuideToSection('${e.id}')">\n      <span class="guide-nav-icon">${n}</span>\n      <span>${e.title}</span>\n    </button>`}).join(""),a=GUIDE_SECTIONS.map(e=>{const t=GUIDE_SECTION_EMOJIS[e.id],n=t?t.emoji+" ":"";return`<button class="guide-mobile-nav-pill" data-section="${e.id}" onclick="scrollGuideToSection('${e.id}')">${n}${e.title}</button>`}).join(""),i=GUIDE_SECTIONS.map(e=>{let t="";t="shortcuts"===e.id?buildKeyboardShortcutsTable():e.features.map(e=>{const t=`<span class="guide-tier-badge tier-${e.tier}">${e.tier.charAt(0).toUpperCase()+e.tier.slice(1)}</span>`,n=e.steps.map(e=>`<li>${escapeHtml(e)}</li>`).join(""),a=GUIDE_TRY_IT_ACTIONS[e.id],i=a?`<button class="guide-try-btn" onclick="${a.action}">${a.label}</button>`:"";return`<div class="guide-feature-card" data-feature-id="${e.id}" data-tier="${e.tier}" data-search="${(e.title+" "+e.description+" "+e.steps.join(" ")).toLowerCase()}">\n          <button class="guide-feature-head" onclick="toggleGuideFeature('${e.id}')">\n            <svg class="guide-feature-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>\n            <span class="guide-feature-title">${escapeHtml(e.title)}</span>\n            ${t}\n          </button>\n          <div class="guide-feature-body">\n            <div class="guide-feature-inner">\n              <p class="guide-feature-desc">${escapeHtml(e.description)}</p>\n              <ol class="guide-feature-steps">${n}</ol>\n              ${i}\n            </div>\n          </div>\n        </div>`}).join("");const n=GUIDE_SECTION_EMOJIS[e.id],a=n?`<div class="guide-section-icon" style="background:${n.gradient};">${n.emoji}</div>`:`<div class="guide-section-icon">${e.icon}</div>`;return`<div class="guide-section" id="guide-section-${e.id}" data-section-id="${e.id}" data-search="${(e.title+" "+e.description).toLowerCase()}">\n      <div class="guide-section-header">\n        ${a}\n        <div>\n          <h3 class="guide-section-title">${e.title}</h3>\n          <div class="guide-section-desc">${e.description}</div>\n        </div>\n      </div>\n      ${t}\n    </div>`}).join("");return`<div class="guide-container">\n    <div class="guide-header">\n      <div class="guide-logo">O</div>\n      <div class="guide-header-text">\n        <h2 class="guide-title">\n          AskOzzy User Guide\n          <span class="guide-tier-badge tier-${e}">${t} Plan</span>\n        </h2>\n        <div class="guide-subtitle">Everything you need to know ‚Äî 49+ features across 12 categories</div>\n      </div>\n      <button class="guide-close" onclick="closeGuide()" title="Close (Esc)">&#x2715;</button>\n    </div>\n    <div class="guide-search-bar">\n      <svg class="guide-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>\n      <input class="guide-search-input" type="text" placeholder="Search features, tools, shortcuts..." oninput="filterGuide()" id="guide-search-input" />\n      <span class="guide-search-count" id="guide-search-count"></span>\n      <button class="guide-search-clear" id="guide-search-clear" onclick="clearGuideSearch()">&#x2715;</button>\n    </div>\n    <div class="guide-mobile-nav" id="guide-mobile-nav">${a}</div>\n    <div class="guide-body">\n      <nav class="guide-nav" id="guide-nav">${n}</nav>\n      <div class="guide-content" id="guide-content">\n        ${`<div class="guide-tip-banner" id="guide-tip-banner">\n    <span class="guide-tip-icon">üí°</span>\n    <span class="guide-tip-text"><strong>Tip:</strong> ${getRandomTip()}</span>\n    <button class="guide-tip-dismiss" onclick="document.getElementById('guide-tip-banner').style.display='none'" title="Dismiss">‚úï</button>\n  </div>`}\n        <div class="guide-progress-bar">\n    <div class="guide-progress-track"><div class="guide-progress-fill" id="guide-progress-fill" style="width:0%"></div></div>\n    <div class="guide-progress-text" id="guide-progress-text">0 of 49 features explored (0%)</div>\n  </div>\n        ${i}\n        <div class="guide-no-results" id="guide-no-results" style="display:none;">\n          <div class="guide-no-results-icon">&#128269;</div>\n          <h3>No matching features</h3>\n          <p>Try a different search term</p>\n        </div>\n        <button class="guide-scroll-top" id="guide-scroll-top" title="Scroll to top">\n          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>\n        </button>\n      </div>\n    </div>\n  </div>`}function buildKeyboardShortcutsTable(){return`<table class="guide-shortcuts-table">\n    <thead><tr><th>Shortcut</th><th>Action</th></tr></thead>\n    <tbody>${[["Ctrl + K","Search conversations"],["Ctrl + N","New conversation"],["Ctrl + B","Toggle sidebar"],["Ctrl + Shift + D","Toggle dark/light mode"],["Ctrl + /","Open this User Guide"],["Enter","Send message"],["Shift + Enter","New line in message"],["Escape","Close any open modal/dialog"]].map(([e,t])=>`<tr><td>${e.split(" + ").map(e=>`<kbd>${e}</kbd>`).join(" + ")}</td><td>${escapeHtml(t)}</td></tr>`).join("")}</tbody>\n  </table>`}function toggleGuideFeature(e){const t=document.querySelector(`.guide-feature-card[data-feature-id="${e}"]`);if(!t)return;const n=t.classList.contains("open"),a=t.closest(".guide-section");a&&a.querySelectorAll(".guide-feature-card.open").forEach(e=>e.classList.remove("open")),n||(t.classList.add("open"),markFeatureExplored(e))}function scrollGuideToSection(e){const t=document.getElementById("guide-section-"+e),n=document.getElementById("guide-content");if(!t||!n)return;n.scrollTo({top:t.offsetTop-n.offsetTop,behavior:"smooth"}),document.querySelectorAll(".guide-nav-item").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".guide-mobile-nav-pill").forEach(e=>e.classList.remove("active"));const a=document.querySelector(`.guide-nav-item[data-section="${e}"]`),i=document.querySelector(`.guide-mobile-nav-pill[data-section="${e}"]`);a&&a.classList.add("active"),i&&(i.classList.add("active"),i.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})),setTimeout(()=>updateGuideNavIndicator(),50)}function filterGuide(){const e=document.getElementById("guide-search-input"),t=document.getElementById("guide-search-clear"),n=document.getElementById("guide-no-results"),a=document.getElementById("guide-search-count");if(!e)return;const i=e.value.trim().toLowerCase();t.classList.toggle("visible",i.length>0);const o=document.querySelectorAll(".guide-section");let s=!1,r=0;o.forEach(e=>{if("shortcuts"===e.dataset.sectionId){const t=!i||e.dataset.search.includes(i)||"keyboard shortcut ctrl".includes(i);return e.classList.toggle("hidden",!t),void(t&&(s=!0))}const t=e.querySelectorAll(".guide-feature-card");let n=!1;t.forEach(e=>{const t=!i||e.dataset.search.includes(i);e.classList.toggle("hidden",!t),t&&(n=!0,i&&r++,i.length>=2?e.classList.add("open"):e.classList.remove("open"))}),!n&&i&&e.dataset.search.includes(i)&&(n=!0,t.forEach(e=>{e.classList.remove("hidden"),r++})),e.classList.toggle("hidden",!n),n&&(s=!0)}),n&&(n.style.display=s||!i?"none":"block"),a&&(i?(a.textContent=r+" result"+(1!==r?"s":""),a.classList.add("visible")):a.classList.remove("visible"))}function clearGuideSearch(){const e=document.getElementById("guide-search-input");e&&(e.value="",filterGuide(),e.focus())}function updateGuideTierHighlights(){const e=["free","professional","enterprise"],t=state.user&&state.user.tier||"free",n=e.indexOf(t);document.querySelectorAll(".guide-feature-card").forEach(t=>{const a=t.dataset.tier,i=e.indexOf(a)>n;t.classList.toggle("locked",i);const o=t.querySelector(".guide-feature-head"),s=o.querySelector(".guide-locked-badge");if(i&&!s){const e=document.createElement("span");e.className="guide-locked-badge",e.innerHTML="üîí Unlock",e.onclick=e=>{e.stopPropagation(),closeGuide(),openPricingModal()},o.appendChild(e)}else!i&&s&&s.remove()});const a=document.querySelector(".guide-title .guide-tier-badge");if(a){const e={free:"Free",professional:"Professional",enterprise:"Enterprise"}[t]||"Free";a.className=`guide-tier-badge tier-${t}`,a.textContent=`${e} Plan`}}function initGuideNavigation(){const e=document.getElementById("guide-content");if(!e)return;const t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target.dataset.sectionId;if(!t)return;document.querySelectorAll(".guide-nav-item").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".guide-mobile-nav-pill").forEach(e=>e.classList.remove("active"));const n=document.querySelector(`.guide-nav-item[data-section="${t}"]`),a=document.querySelector(`.guide-mobile-nav-pill[data-section="${t}"]`);n&&n.classList.add("active"),a&&a.classList.add("active"),updateGuideNavIndicator()}})},{root:e,rootMargin:"-10% 0px -80% 0px",threshold:0});e.querySelectorAll(".guide-section").forEach(e=>t.observe(e));const n=document.getElementById("guide-scroll-top");n&&(e.addEventListener("scroll",()=>{n.classList.toggle("visible",e.scrollTop>300)}),n.addEventListener("click",()=>{e.scrollTo({top:0,behavior:"smooth"})}));const a=document.getElementById("guide-nav");if(a){const e=document.createElement("div");e.className="guide-nav-indicator",a.appendChild(e),setTimeout(()=>updateGuideNavIndicator(),100)}}function getExploredFeatures(){try{return JSON.parse(localStorage.getItem("ozzy_guide_explored")||"[]")}catch{return[]}}function markFeatureExplored(e){const t=getExploredFeatures();t.includes(e)||(t.push(e),localStorage.setItem("ozzy_guide_explored",JSON.stringify(t))),updateGuideProgress()}function updateGuideProgress(){const e=getExploredFeatures(),t=GUIDE_SECTIONS.reduce((e,t)=>e+t.features.length,0)||49,n=e.length,a=Math.min(Math.round(n/t*100),100),i=document.getElementById("guide-progress-fill"),o=document.getElementById("guide-progress-text");i&&(i.style.width=a+"%"),o&&(o.textContent=`${n} of ${t} features explored (${a}%)`)}function getRandomTip(){const e=Math.floor(Math.random()*GUIDE_TIPS.length);return GUIDE_TIPS[e]}function updateGuideNavIndicator(){const e=document.getElementById("guide-nav"),t=e&&e.querySelector(".guide-nav-indicator"),n=e&&e.querySelector(".guide-nav-item.active");if(!t||!n)return;const a=e.getBoundingClientRect(),i=n.getBoundingClientRect();t.style.width=i.width-24+"px",t.style.transform=`translateX(${i.left-a.left}px) translateY(${i.bottom-a.top-3}px)`}function playGuideSparkle(){if(localStorage.getItem("ozzy_guide_sparkled"))return;localStorage.setItem("ozzy_guide_sparkled","1");const e=document.querySelector(".guide-container");if(!e)return;const t=document.createElement("canvas");t.className="guide-sparkle-canvas",t.width=e.offsetWidth,t.height=e.offsetHeight,e.style.position="relative",e.appendChild(t);const n=t.getContext("2d"),a=["#CE1126","#FCD116","#006B3F","#FFD700","#FFFFFF"],i=[],o=t.width/2,s=t.height/3;for(let e=0;e<60;e++){const e=Math.random()*Math.PI*2,t=2+4*Math.random();i.push({x:o,y:s,vx:Math.cos(e)*t,vy:Math.sin(e)*t-2,r:2+4*Math.random(),color:a[Math.floor(Math.random()*a.length)],life:1,star:Math.random()>.5})}let r=0;requestAnimationFrame(function e(){n.clearRect(0,0,t.width,t.height);let a=!1;i.forEach(e=>{if(e.x+=e.vx,e.y+=e.vy,e.vy+=.1,e.life-=.015,!(e.life<=0))if(a=!0,n.globalAlpha=e.life,n.fillStyle=e.color,e.star){n.beginPath();for(let t=0;t<5;t++){const a=4*t*Math.PI/5-Math.PI/2;n[0===t?"moveTo":"lineTo"](e.x+Math.cos(a)*e.r,e.y+Math.sin(a)*e.r)}n.closePath(),n.fill()}else n.beginPath(),n.arc(e.x,e.y,e.r,0,2*Math.PI),n.fill()}),n.globalAlpha=1,r++,a&&r<90?requestAnimationFrame(e):t.remove()})}document.getElementById("affiliate-modal").addEventListener("click",e=>{e.target===e.currentTarget&&closeAffiliateModal()}),document.getElementById("pricing-modal").addEventListener("click",e=>{e.target===e.currentTarget&&closePricingModal()}),document.addEventListener("keydown",e=>(e.ctrlKey||e.metaKey)&&"k"===e.key?(e.preventDefault(),void openSearchModal()):(e.ctrlKey||e.metaKey)&&"n"===e.key?(e.preventDefault(),void requireAuth(createNewChat)):(e.ctrlKey||e.metaKey)&&"b"===e.key?(e.preventDefault(),void toggleSidebar()):(e.ctrlKey||e.metaKey)&&e.shiftKey&&"D"===e.key?(e.preventDefault(),void toggleTheme()):(e.ctrlKey||e.metaKey)&&"/"===e.key?(e.preventDefault(),void openGuide()):void("Escape"===e.key&&document.querySelectorAll(".modal-overlay.active").forEach(e=>e.classList.remove("active"))));let _recognition=null,_isListening=!1,_voiceTimerInterval=null,_voiceTimerSeconds=0;const VOICE_LANG_MAP={en:"en-GH",tw:"ak-GH",ga:"gaa",ee:"ee-GH",ha:"ha-GH",fr:"fr-FR",dag:"dag"},VOICE_LANG_FALLBACK={"en-GH":"en-US","ak-GH":"ak","ee-GH":"ee","ha-GH":"ha"},LISTENING_LABELS={en:"Listening...",tw:"Mente tie...",ga:"Enu mli...",ee:"Miele to...",ha:"Ana sauraro...",fr:"√âcoute...",dag:"Di wuhimi..."};function getRecognitionLang(){const e=state.language||"en";return VOICE_LANG_MAP[e]||"en-GH"}function initVoiceInput(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;e&&(_recognition=new e,_recognition.continuous=!1,_recognition.interimResults=!0,_recognition.lang=getRecognitionLang(),_recognition.onresult=e=>{const t=document.getElementById("chat-input");let n="";for(let t=e.resultIndex;t<e.results.length;t++)n+=e.results[t][0].transcript;e.results[e.results.length-1].isFinal&&(t.value+=(t.value?" ":"")+n),autoResizeInput(),updateSendButton()},_recognition.onend=()=>{_isListening=!1,updateVoiceUI(!1)},_recognition.onerror=e=>{if(_isListening=!1,updateVoiceUI(!1),"language-not-supported"===e.error){const e=_recognition.lang,t=VOICE_LANG_FALLBACK[e];if(t){_recognition.lang=t;try{_recognition.start(),_isListening=!0,updateVoiceUI(!0)}catch(e){}}}})}function toggleVoice(){if(_recognition)if(_isListening)_recognition.stop(),_isListening=!1,updateVoiceUI(!1);else{_recognition.lang=getRecognitionLang();try{_recognition.start(),_isListening=!0,updateVoiceUI(!0)}catch(e){_isListening=!1,updateVoiceUI(!1)}}else alert("Voice input is not supported in this browser. Try Chrome or Edge.")}function updateVoiceUI(e){const t=document.getElementById("btn-voice");t&&(t.classList.toggle("listening",e),t.title=e?"Stop listening":"Voice input");const n=document.getElementById("voice-btn-large");n&&(n.classList.toggle("recording",e),n.title=e?"Tap to stop":"Tap to speak");const a=document.getElementById("input-wrapper");a&&a.classList.toggle("recording",e);const i=document.getElementById("voice-recording-indicator");i&&i.classList.toggle("active",e);const o=document.getElementById("voice-listening-label");o&&(o.textContent=LISTENING_LABELS[state.language]||"Listening..."),e?startVoiceTimer():stopVoiceTimer()}function startVoiceTimer(){_voiceTimerSeconds=0,updateVoiceTimerDisplay(),_voiceTimerInterval=setInterval(()=>{_voiceTimerSeconds++,updateVoiceTimerDisplay()},1e3)}function stopVoiceTimer(){_voiceTimerInterval&&(clearInterval(_voiceTimerInterval),_voiceTimerInterval=null),_voiceTimerSeconds=0,updateVoiceTimerDisplay()}function updateVoiceTimerDisplay(){const e=document.getElementById("voice-timer");if(!e)return;const t=Math.floor(_voiceTimerSeconds/60),n=_voiceTimerSeconds%60;e.textContent=`${t}:${n.toString().padStart(2,"0")}`}function updateVoiceButton(){updateVoiceUI(_isListening)}function showVoiceWelcome(){if(localStorage.getItem("ozzy_voice_welcomed"))return;const e=document.createElement("div");e.className="voice-welcome-overlay",e.id="voice-welcome-overlay",e.innerHTML='\n    <div class="voice-welcome-card">\n      <div class="voice-welcome-flag"><span></span><span></span><span></span></div>\n      <h2>Welcome to AskOzzy</h2>\n      <p class="subtitle">Tap the microphone to ask your question in any Ghanaian language</p>\n      <button class="voice-welcome-mic" id="voice-welcome-mic-btn" title="Tap to speak">\n        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>\n          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>\n          <line x1="12" y1="19" x2="12" y2="23"/>\n          <line x1="8" y1="23" x2="16" y2="23"/>\n        </svg>\n      </button>\n      <div class="voice-lang-pills" id="voice-welcome-langs"></div>\n      <p class="or-type">Or type your question below</p>\n      <button class="voice-welcome-dismiss" id="voice-welcome-dismiss">Got it</button>\n    </div>\n  ',document.body.appendChild(e);const t=[{code:"en",name:"English"},{code:"tw",name:"Twi"},{code:"ga",name:"Ga"},{code:"ee",name:"Ewe"},{code:"ha",name:"Hausa"},{code:"fr",name:"Fran√ßais"},{code:"dag",name:"Dagbani"}],n=document.getElementById("voice-welcome-langs");n&&(n.innerHTML=t.map(e=>`<button class="voice-lang-pill ${e.code===(state.language||"en")?"active":""}" data-lang="${e.code}">${e.name}</button>`).join(""),n.addEventListener("click",e=>{const t=e.target.closest(".voice-lang-pill");if(!t)return;const a=t.dataset.lang;n.querySelectorAll(".voice-lang-pill").forEach(e=>e.classList.remove("active")),t.classList.add("active"),changeLanguage(a)}));const a=document.getElementById("voice-welcome-mic-btn");a&&a.addEventListener("click",()=>{dismissVoiceWelcome(),setTimeout(()=>toggleVoice(),200)});const i=document.getElementById("voice-welcome-dismiss");i&&i.addEventListener("click",dismissVoiceWelcome),e.addEventListener("click",t=>{t.target===e&&dismissVoiceWelcome()})}function dismissVoiceWelcome(){localStorage.setItem("ozzy_voice_welcomed","1");const e=document.getElementById("voice-welcome-overlay");e&&(e.style.opacity="0",e.style.transition="opacity 0.25s ease",setTimeout(()=>e.remove(),260))}async function rateMessage(e,t){if(isLoggedIn())try{await fetch(`/api/messages/${e}/rate`,{method:"POST",headers:authHeaders(),body:JSON.stringify({rating:t})});document.querySelectorAll(`[data-rate-msg="${e}"]`).forEach(e=>{const n=parseInt(e.dataset.rating);e.classList.toggle("rated",n===t)})}catch(e){console.error("Rating failed:",e)}}async function regenerateMessage(e){if(isLoggedIn()&&!state.isStreaming){state.isStreaming=!0,updateSendButton();try{const t=await fetch(`/api/messages/${e}/regenerate`,{method:"POST",headers:authHeaders(),body:JSON.stringify({model:state.selectedModel})});if(!t.ok){const e=await t.json();throw new Error(e.error||"Regeneration failed")}const n=state.messages.findIndex(t=>t.id===e);-1!==n&&(state.messages[n].content="",renderMessages());const a=t.body.getReader(),i=new TextDecoder;let o="";for(;;){const{done:e,value:t}=await a.read();if(e)break;const s=i.decode(t).split("\n");for(const e of s)if(e.startsWith("data: ")&&!e.includes("[DONE]"))try{const t=JSON.parse(e.slice(6));let a=t.response||null;!a&&t.choices?.[0]?.delta?.content&&(a=t.choices[0].delta.content),a&&(o+=a,-1!==n&&(state.messages[n].content=o,updateLastMessage(o)))}catch{}}renderMessages(),await loadConversations()}catch(e){console.error("Regenerate error:",e),alert("Failed to regenerate: "+e.message)}finally{state.isStreaming=!1,updateSendButton()}}}function openSearchModal(){if(!isLoggedIn())return void requireAuth(openSearchModal);let e=document.getElementById("search-modal");e||(e=document.createElement("div"),e.className="modal-overlay",e.id="search-modal",e.innerHTML='\n      <div class="modal" style="max-width:600px;">\n        <div class="modal-header">\n          <h3>Search Conversations</h3>\n          <button class="modal-close" onclick="closeSearchModal()">&#x2715;</button>\n        </div>\n        <div class="modal-body" style="padding:16px 24px;">\n          <input type="text" id="search-input" class="search-input" placeholder="Search messages and conversations..." oninput="debouncedSearch()" autofocus />\n          <div id="search-results" class="search-results"></div>\n        </div>\n      </div>',document.body.appendChild(e),e.addEventListener("click",t=>{t.target===e&&closeSearchModal()})),e.classList.add("active"),setTimeout(()=>document.getElementById("search-input")?.focus(),100)}function closeSearchModal(){const e=document.getElementById("search-modal");e&&e.classList.remove("active")}document.addEventListener("DOMContentLoaded",()=>{initVoiceInput(),setTimeout(showVoiceWelcome,600)});const debouncedSearch=debounce(async()=>{const e=document.getElementById("search-input")?.value||"",t=document.getElementById("search-results");if(t)if(e.length<2)t.innerHTML='<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:13px;">Type at least 2 characters to search</div>';else{t.innerHTML='<div style="text-align:center;padding:24px;"><div class="spinner"></div></div>';try{const n=await fetch(`/api/conversations/search?q=${encodeURIComponent(e)}`,{headers:authHeaders()}),a=await n.json();if(!a.results||0===a.results.length)return void(t.innerHTML='<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:13px;">No results found</div>');t.innerHTML=a.results.map(e=>`\n      <div class="search-result-item" onclick="closeSearchModal();openConversation('${e.id}')">\n        <div class="search-result-title">${escapeHtml(e.title)}</div>\n        ${e.matched_content?`<div class="search-result-preview">${escapeHtml(e.matched_content.substring(0,120))}...</div>`:""}\n        <div class="search-result-date">${formatDateShort(e.updated_at)}</div>\n      </div>\n    `).join("")}catch{t.innerHTML='<div style="text-align:center;padding:24px;color:var(--text-muted);">Search failed</div>'}}},300);function debounce(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>e.apply(this,a),t)}}function formatDateShort(e){if(!e)return"";return new Date(e).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}async function loadFolders(){if(isLoggedIn())try{const e=await fetch("/api/folders",{headers:authHeaders()}),t=await e.json();state.folders=t.folders||[]}catch{}}async function createFolder(){if(!(state.user&&state.user.tier&&"free"!==state.user.tier))return void showFolderPremiumPrompt();const e=prompt("Folder name:");if(e)try{const t=await fetch("/api/folders",{method:"POST",headers:authHeaders(),body:JSON.stringify({name:e})}),n=await t.json();if(!t.ok)return"PREMIUM_REQUIRED"===n.code?void showFolderPremiumPrompt():void alert(n.error||"Failed to create folder");await loadFolders(),renderConversationList()}catch{}}function toggleFolderCollapse(e){state.collapsedFolders||(state.collapsedFolders={}),state.collapsedFolders[e]=!state.collapsedFolders[e],renderConversationList()}function showMoveToFolderMenu(e,t){e.preventDefault(),e.stopPropagation(),closeContextMenu();const n=state.folders||[],a=state.conversations.find(e=>e.id===t);let i='<div class="context-menu" id="context-menu">';i+='<div class="context-menu-title">Move to folder</div>',a&&a.folder_id&&(i+=`<button class="context-menu-item" onclick="moveToFolder('${t}',null);closeContextMenu();">Remove from folder</button>`);for(const e of n){const n=a&&a.folder_id===e.id;i+=`<button class="context-menu-item ${n?"active":""}" onclick="moveToFolder('${t}','${e.id}');closeContextMenu();">üìÅ ${escapeHtml(e.name)}${n?" ‚úì":""}</button>`}0===n.length&&(i+='<div class="context-menu-empty">No folders yet</div>'),i+='<button class="context-menu-item context-menu-new" onclick="closeContextMenu();createFolder();">+ New Folder</button>',i+="</div>",document.body.insertAdjacentHTML("beforeend",i);const o=document.getElementById("context-menu");o.style.left=Math.min(e.clientX,window.innerWidth-200)+"px",o.style.top=Math.min(e.clientY,window.innerHeight-250)+"px",setTimeout(()=>document.addEventListener("click",closeContextMenu,{once:!0}),10)}function showConvoContextMenu(e,t,n,a){e.preventDefault(),e.stopPropagation(),closeContextMenu();const i=state.user&&state.user.tier&&"free"!==state.user.tier,o=state.folders||[];let s='<div class="context-menu" id="context-menu">';if(s+=`<button class="context-menu-item" onclick="togglePin('${t}');closeContextMenu();">${n?"üìå Unpin":"üìç Pin to top"}</button>`,i){s+='<div class="context-menu-divider"></div>',s+='<div class="context-menu-title">Move to folder</div>',a&&(s+=`<button class="context-menu-item" onclick="moveToFolder('${t}',null);closeContextMenu();">Remove from folder</button>`);for(const e of o){const n=a===e.id;s+=`<button class="context-menu-item ${n?"active":""}" onclick="moveToFolder('${t}','${e.id}');closeContextMenu();">üìÅ ${escapeHtml(e.name)}${n?" ‚úì":""}</button>`}s+='<button class="context-menu-item context-menu-new" onclick="closeContextMenu();createFolder();">+ New Folder</button>'}s+='<div class="context-menu-divider"></div>',s+=`<button class="context-menu-item context-menu-danger" onclick="deleteConversation('${t}');closeContextMenu();">üóë Delete</button>`,s+="</div>",document.body.insertAdjacentHTML("beforeend",s);const r=document.getElementById("context-menu");r.style.left=Math.min(e.clientX,window.innerWidth-200)+"px",r.style.top=Math.min(e.clientY,window.innerHeight-250)+"px",setTimeout(()=>document.addEventListener("click",closeContextMenu,{once:!0}),10)}function closeContextMenu(){const e=document.getElementById("context-menu");e&&e.remove()}async function deleteFolder(e){if(confirm("Delete this folder? Conversations will be unassigned."))try{await fetch(`/api/folders/${e}`,{method:"DELETE",headers:authHeaders()}),await loadFolders(),await loadConversations()}catch{}}async function moveToFolder(e,t){try{await fetch(`/api/conversations/${e}`,{method:"PATCH",headers:authHeaders(),body:JSON.stringify({folder_id:t||null})}),await loadConversations()}catch{}}async function togglePin(e){const t=state.conversations.find(t=>t.id===e);if(t)try{await fetch(`/api/conversations/${e}`,{method:"PATCH",headers:authHeaders(),body:JSON.stringify({pinned:!t.pinned})}),await loadConversations()}catch{}}async function loadAnnouncements(){try{const e=await fetch("/api/announcements"),t=await e.json(),n=JSON.parse(localStorage.getItem("askozzy_dismissed_announcements")||"[]"),a=(t.announcements||[]).filter(e=>!n.includes(e.id)),i=document.getElementById("announcements-area");if(!i||0===a.length)return;i.innerHTML=a.map(e=>`\n      <div class="announcement-banner announcement-${e.type}">\n        <div class="announcement-content">\n          <strong>${escapeHtml(e.title)}</strong>\n          <span>${escapeHtml(e.content)}</span>\n        </div>\n        ${e.dismissible?`<button class="announcement-dismiss" onclick="dismissAnnouncement('${e.id}')">&times;</button>`:""}\n      </div>\n    `).join("")}catch{}}function dismissAnnouncement(e){const t=JSON.parse(localStorage.getItem("askozzy_dismissed_announcements")||"[]");t.push(e),localStorage.setItem("askozzy_dismissed_announcements",JSON.stringify(t));const n=document.getElementById("announcements-area");if(n){const t=n.querySelector(`[onclick*="${e}"]`);t&&t.parentElement.remove()}}async function openUserDashboard(){if(!isLoggedIn())return void requireAuth(openUserDashboard);let e=document.getElementById("user-dashboard-modal");e||(e=document.createElement("div"),e.className="modal-overlay",e.id="user-dashboard-modal",e.innerHTML='\n      <div class="modal" style="max-width:640px;">\n        <div class="modal-header">\n          <h3>Your Usage Dashboard</h3>\n          <button class="modal-close" onclick="document.getElementById(\'user-dashboard-modal\').classList.remove(\'active\')">&#x2715;</button>\n        </div>\n        <div class="modal-body" id="user-dashboard-body" style="padding:24px;">\n          <div style="text-align:center;padding:40px;"><div class="spinner"></div></div>\n        </div>\n      </div>',document.body.appendChild(e),e.addEventListener("click",t=>{t.target===e&&e.classList.remove("active")})),e.classList.add("active");const t=document.getElementById("user-dashboard-body");try{const e=await fetch("/api/user/dashboard",{headers:authHeaders()}),n=await e.json(),a=Math.max(...(n.messagesPerDay||[]).map(e=>e.count),1);t.innerHTML=`\n      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px;">\n        <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;text-align:center;">\n          <div style="font-size:28px;font-weight:700;color:var(--gold);">${n.totalMessages}</div>\n          <div style="font-size:11px;color:var(--text-muted);">Total Messages</div>\n        </div>\n        <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;text-align:center;">\n          <div style="font-size:28px;font-weight:700;color:var(--green-light);">${n.totalConversations}</div>\n          <div style="font-size:11px;color:var(--text-muted);">Conversations</div>\n        </div>\n        <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;text-align:center;">\n          <div style="font-size:28px;font-weight:700;color:var(--text-strong);">${formatDateShort(n.memberSince)}</div>\n          <div style="font-size:11px;color:var(--text-muted);">Member Since</div>\n        </div>\n      </div>\n      <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;margin-bottom:16px;">\n        <div style="font-size:13px;font-weight:600;margin-bottom:12px;">Messages ‚Äî Last 7 Days</div>\n        ${(n.messagesPerDay||[]).map(e=>`\n          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">\n            <span style="font-size:11px;color:var(--text-muted);min-width:60px;">${e.day.slice(5)}</span>\n            <div style="flex:1;background:var(--bg-primary);border-radius:4px;height:18px;overflow:hidden;">\n              <div style="background:var(--gold);height:100%;width:${e.count/a*100}%;border-radius:4px;transition:width 0.3s;"></div>\n            </div>\n            <span style="font-size:11px;color:var(--text-secondary);min-width:24px;text-align:right;">${e.count}</span>\n          </div>\n        `).join("")}\n      </div>\n      <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;">\n        <div style="font-size:13px;font-weight:600;margin-bottom:12px;">Models Used</div>\n        ${(n.modelUsage||[]).map(e=>`\n          <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border-color);font-size:12px;">\n            <span style="color:var(--text-primary);">${e.model.split("/").pop()}</span>\n            <span style="color:var(--gold);font-weight:600;">${e.count} msgs</span>\n          </div>\n        `).join("")}\n      </div>`}catch{t.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-muted);">Failed to load dashboard</div>'}}let productivityChartInstance=null;async function openProductivityDashboard(){if(!isLoggedIn())return void requireAuth(openProductivityDashboard);let e=document.getElementById("productivity-dashboard-modal");e||(e=document.createElement("div"),e.className="modal-overlay",e.id="productivity-dashboard-modal",e.innerHTML='\n      <div class="modal" style="max-width:700px;">\n        <div class="modal-header">\n          <h3>Productivity Dashboard</h3>\n          <button class="modal-close" onclick="document.getElementById(\'productivity-dashboard-modal\').classList.remove(\'active\')">&#x2715;</button>\n        </div>\n        <div class="modal-body" id="productivity-dashboard-body" style="padding:24px;">\n          <div style="text-align:center;padding:40px;"><div class="spinner"></div></div>\n        </div>\n      </div>',document.body.appendChild(e),e.addEventListener("click",t=>{t.target===e&&e.classList.remove("active")})),e.classList.add("active");const t=document.getElementById("productivity-dashboard-body");try{const e=await fetch("/api/productivity/me",{headers:authHeaders()});if(!e.ok)throw new Error("Failed to load");const n=await e.json(),a=n.month?.messages_sent||0,i=(n.month?.documents_generated||0)+(n.month?.workflows_completed||0),o=((n.month?.estimated_minutes_saved||0)/60).toFixed(1),s=((n.allTime?.estimated_minutes_saved||0)/60).toFixed(1);t.innerHTML=`\n      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:20px;">\n        <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;text-align:center;">\n          <div style="font-size:28px;font-weight:700;color:var(--gold);">${a}</div>\n          <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Messages This Month</div>\n        </div>\n        <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;text-align:center;">\n          <div style="font-size:28px;font-weight:700;color:var(--green-light);">${i}</div>\n          <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Documents Generated</div>\n        </div>\n        <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;text-align:center;">\n          <div style="font-size:28px;font-weight:700;color:#CE1126;">${o}h</div>\n          <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Est. Hours Saved</div>\n        </div>\n        <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;text-align:center;">\n          <div style="font-size:28px;font-weight:700;color:var(--text-strong);">${n.streak}</div>\n          <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Day Streak</div>\n        </div>\n      </div>\n\n      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">\n        <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;">\n          <div style="font-size:13px;font-weight:600;margin-bottom:8px;">This Week</div>\n          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;">\n            <div><span style="color:var(--text-muted);">Messages:</span> <strong>${n.week?.messages_sent||0}</strong></div>\n            <div><span style="color:var(--text-muted);">Research:</span> <strong>${n.week?.research_reports||0}</strong></div>\n            <div><span style="color:var(--text-muted);">Analyses:</span> <strong>${n.week?.analyses_run||0}</strong></div>\n            <div><span style="color:var(--text-muted);">Workflows:</span> <strong>${n.week?.workflows_completed||0}</strong></div>\n          </div>\n        </div>\n        <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;">\n          <div style="font-size:13px;font-weight:600;margin-bottom:8px;">All Time</div>\n          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;">\n            <div><span style="color:var(--text-muted);">Total Msgs:</span> <strong>${n.allTime?.messages_sent||0}</strong></div>\n            <div><span style="color:var(--text-muted);">Hours Saved:</span> <strong>${s}h</strong></div>\n            <div><span style="color:var(--text-muted);">Top Feature:</span> <strong>${escapeHtml(n.topFeature)}</strong></div>\n            <div><span style="color:var(--text-muted);">Meetings:</span> <strong>${n.allTime?.meetings_processed||0}</strong></div>\n          </div>\n        </div>\n      </div>\n\n      <div style="background:var(--bg-tertiary);border-radius:10px;padding:16px;">\n        <div style="font-size:13px;font-weight:600;margin-bottom:12px;">Daily Activity - Last 7 Days</div>\n        <canvas id="productivity-chart-canvas" width="600" height="220"></canvas>\n      </div>`,loadChartJs().then(()=>{productivityChartInstance&&(productivityChartInstance.destroy(),productivityChartInstance=null);const e=["#CE1126","#FCD116","#006B3F","#1a1d27","#e8eaed","#00a86b"],t=n.dailyUsage||[],a=[],i=[],o=[],s=[],r=new Date;for(let e=6;e>=0;e--){const n=new Date(r);n.setDate(n.getDate()-e);const l=n.toISOString().split("T")[0];a.push(l.slice(5));const c=t.find(e=>e.stat_date===l);i.push(c?c.messages_sent:0),o.push(c?c.documents_generated+c.workflows_completed:0),s.push(c?c.research_reports+c.analyses_run:0)}setTimeout(()=>{const t=document.getElementById("productivity-chart-canvas");if(t)try{productivityChartInstance=new Chart(t,{type:"bar",data:{labels:a,datasets:[{label:"Messages",data:i,backgroundColor:e[0]+"CC",borderRadius:3},{label:"Documents",data:o,backgroundColor:e[2]+"CC",borderRadius:3},{label:"Research & Analysis",data:s,backgroundColor:e[1]+"CC",borderRadius:3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{color:"var(--text-secondary)",boxWidth:12,font:{size:11}}}},scales:{x:{ticks:{color:"var(--text-secondary)",font:{size:11}},grid:{display:!1}},y:{beginAtZero:!0,ticks:{color:"var(--text-secondary)",font:{size:11},stepSize:1},grid:{color:"rgba(128,128,128,0.1)"}}}}})}catch(e){console.error("Productivity chart error:",e)}},100)})}catch{t.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-muted);">Failed to load productivity data. Please try again.</div>'}}async function revokeAllSessions(){if(confirm("This will sign you out of ALL devices and generate a new access code. Continue?"))try{const e=await fetch("/api/user/sessions/revoke-all",{method:"POST",headers:authHeaders()}),t=await e.json();t.newAccessCode&&(alert(`All sessions revoked!\n\nYour NEW access code is:\n${t.newAccessCode}\n\nSave this code ‚Äî you'll need it to sign in again!`),logout())}catch{alert("Failed to revoke sessions")}}async function openSecuritySettings(){if(!isLoggedIn())return;let e=document.getElementById("security-modal");e||(e=document.createElement("div"),e.className="modal-overlay",e.id="security-modal",e.innerHTML='\n      <div class="modal" style="max-width:500px;">\n        <div class="modal-header">\n          <h3>Security Settings</h3>\n          <button class="modal-close" onclick="document.getElementById(\'security-modal\').classList.remove(\'active\')">&#x2715;</button>\n        </div>\n        <div class="modal-body" id="security-body" style="padding:24px;">\n          <div style="text-align:center;padding:40px;"><div class="spinner"></div></div>\n        </div>\n      </div>',document.body.appendChild(e),e.addEventListener("click",t=>{t.target===e&&e.classList.remove("active")})),e.classList.add("active"),await renderSecuritySettings()}async function renderSecuritySettings(){const e=document.getElementById("security-body");if(e){e.innerHTML='<div style="text-align:center;padding:20px;"><div class="spinner"></div></div>';try{let t=[];try{const e=await fetch("/api/auth/webauthn/credentials",{headers:authHeaders()});t=(await e.json()).credentials||[]}catch{}const n=!!window.PublicKeyCredential;e.innerHTML=`\n      <div style="margin-bottom:24px;">\n        <h4 style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:8px;">Authenticator App (TOTP)</h4>\n        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Your primary sign-in method. Use Google Authenticator, Authy, or similar apps.</p>\n        <button class="btn-auth" onclick="open2FASetup()" style="font-size:13px;padding:8px 16px;">Reconfigure Authenticator</button>\n      </div>\n\n      <div style="border-top:1px solid var(--border-color);padding-top:16px;margin-bottom:24px;">\n        <h4 style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:8px;">Passkeys</h4>\n        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Sign in with fingerprint or Face ID. Works as a backup to your authenticator.</p>\n        ${t.length>0?t.map(e=>`\n          <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:6px;">\n            <span style="font-size:12px;color:var(--text-secondary);">Passkey added ${new Date(e.created_at).toLocaleDateString()}</span>\n            <button onclick="deletePasskey('${e.id}')" style="background:none;border:none;color:var(--red);font-size:11px;cursor:pointer;">Remove</button>\n          </div>`).join(""):'<p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">No passkeys registered.</p>'}\n        ${n?'<button class="btn-auth" onclick="addPasskey()" style="font-size:13px;padding:8px 16px;">Add Passkey</button>':'<p style="font-size:11px;color:var(--text-muted);">Your browser does not support passkeys.</p>'}\n      </div>\n\n      <div style="border-top:1px solid var(--border-color);padding-top:16px;">\n        <h4 style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:8px;">Recovery Code</h4>\n        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">One-time use backup code in case you lose your authenticator.</p>\n        <button class="btn-auth" onclick="regenerateRecoveryCode()" style="font-size:13px;padding:8px 16px;background:var(--bg-tertiary);color:var(--text-primary);">Generate New Recovery Code</button>\n        <div id="new-recovery-code" style="display:none;margin-top:12px;"></div>\n      </div>`}catch(t){e.innerHTML='<p style="color:var(--red-error-text);">Failed to load security settings.</p>'}}}async function deletePasskey(e){if(confirm("Remove this passkey?"))try{await fetch(`/api/auth/webauthn/credentials/${e}`,{method:"DELETE",headers:authHeaders()}),await renderSecuritySettings()}catch{}}async function regenerateRecoveryCode(){try{const e=await fetch("/api/auth/recovery-code/regenerate",{method:"POST",headers:authHeaders()}),t=await e.json();if(!e.ok)throw new Error(t.error);const n=document.getElementById("new-recovery-code");n&&(n.style.display="block",n.innerHTML=`\n        <div class="recovery-code-display">\n          <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">NEW RECOVERY CODE</div>\n          <div class="recovery-code-value">${t.recoveryCode}</div>\n          <p style="font-size:11px;color:var(--red-error-text);margin-top:8px;font-weight:600;">Save this code! It won't be shown again.</p>\n        </div>`)}catch(e){alert("Failed to generate recovery code: "+(e.message||"Unknown error"))}}async function open2FASetup(){if(!isLoggedIn())return;let e=document.getElementById("2fa-modal");e||(e=document.createElement("div"),e.className="modal-overlay",e.id="2fa-modal",e.innerHTML='\n      <div class="modal" style="max-width:460px;">\n        <div class="modal-header">\n          <h3>Set Up Authenticator</h3>\n          <button class="modal-close" onclick="document.getElementById(\'2fa-modal\').classList.remove(\'active\')">&#x2715;</button>\n        </div>\n        <div class="modal-body" id="2fa-body" style="padding:24px;">\n          <div style="text-align:center;padding:40px;"><div class="spinner"></div></div>\n        </div>\n      </div>',document.body.appendChild(e),e.addEventListener("click",t=>{t.target===e&&e.classList.remove("active")})),e.classList.add("active");const t=document.getElementById("2fa-body");try{const e=await fetch("/api/user/2fa/setup",{method:"POST",headers:authHeaders()}),n=await e.json();t.innerHTML=`\n      <div style="text-align:center;">\n        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">\n          Scan this code with your authenticator app (Google Authenticator, Authy, etc.):\n        </p>\n        <div style="background:#fff;padding:16px;border-radius:12px;display:inline-block;margin-bottom:16px;">\n          <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(n.uri)}" alt="QR Code" width="200" height="200" />\n        </div>\n        <p style="font-size:11px;color:var(--text-muted);margin-bottom:16px;">\n          Or enter this secret manually: <code style="color:var(--gold);font-size:13px;">${n.secret}</code>\n        </p>\n        <div class="form-group">\n          <label>Enter the 6-digit code from your app:</label>\n          <input type="text" id="totp-verify-code" maxlength="6" placeholder="000000" inputmode="numeric" style="text-align:center;font-size:24px;letter-spacing:8px;" />\n        </div>\n        <button class="btn-auth" onclick="verify2FA()">Verify & Enable</button>\n        <div id="2fa-error" style="color:var(--red-error-text);font-size:12px;margin-top:8px;"></div>\n      </div>`}catch{t.innerHTML='<div style="text-align:center;padding:24px;color:var(--text-muted);">Failed to set up authenticator</div>'}}async function verify2FA(){const e=document.getElementById("totp-verify-code")?.value||"",t=document.getElementById("2fa-error");if(6===e.length)try{const t=await fetch("/api/user/2fa/verify",{method:"POST",headers:authHeaders(),body:JSON.stringify({code:e})}),n=await t.json();if(!t.ok)throw new Error(n.error);alert("Authenticator enabled successfully! You can now sign in with your 6-digit code."),document.getElementById("2fa-modal").classList.remove("active")}catch(e){t&&(t.textContent=e.message)}else t&&(t.textContent="Enter a 6-digit code")}function showOnboardingTour(){if(localStorage.getItem("askozzy_onboarding_done"))return;const e=[{target:".model-selector",text:"Choose from 11 AI models. Free plans get 3 models, paid plans unlock all 11.",position:"bottom"},{target:".btn-new-chat",text:"Start conversations here. Try a template for guided prompts!",position:"right"},{target:".theme-toggle",text:"Switch between dark and light modes.",position:"bottom"},{target:".usage-badge",text:"Track your daily usage. Click to see upgrade plans.",position:"bottom"}];function t(n){const a=document.querySelector(".onboarding-overlay");if(a&&a.remove(),n>=e.length)return void localStorage.setItem("askozzy_onboarding_done","1");const i=e[n],o=document.querySelector(i.target);if(!o)return void t(n+1);const s=o.getBoundingClientRect(),r=document.createElement("div");r.className="onboarding-overlay",r.innerHTML=`\n      <div class="onboarding-highlight" style="top:${s.top-4}px;left:${s.left-4}px;width:${s.width+8}px;height:${s.height+8}px;"></div>\n      <div class="onboarding-tooltip onboarding-${i.position}" style="top:${"bottom"===i.position?s.bottom+12:s.top}px;left:${s.left}px;">\n        <p>${i.text}</p>\n        <div style="display:flex;gap:8px;margin-top:12px;">\n          <button class="onboarding-skip" onclick="this.closest('.onboarding-overlay').remove();localStorage.setItem('askozzy_onboarding_done','1')">Skip Tour</button>\n          <button class="onboarding-next" onclick="showOnboardingStep(${n+1})">${n===e.length-1?"Finish":"Next"}</button>\n        </div>\n        <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">${n+1} of ${e.length}</div>\n      </div>`,document.body.appendChild(r)}window.showOnboardingStep=t,t(0)}async function initPaystackPayment(e,t,n){if(!isLoggedIn())return closePricingModal(),state.pendingAction=()=>openPricingModal(),void openAuthModal();try{const n=await fetch("/api/payments/initialize",{method:"POST",headers:authHeaders(),body:JSON.stringify({tier:e})}),a=await n.json();if(!n.ok)throw new Error(a.error);if(a.authorization_url)window.location.href=a.authorization_url;else if(a.simulated){state.user.tier=e,localStorage.setItem("askozzy_user",JSON.stringify(state.user)),closePricingModal(),loadUsageStatus(),updateSidebarFooter();const n=document.querySelector(".limit-banner");n&&n.remove(),alert(`Welcome to ${t}! ${a.message}`)}}catch(e){alert("Payment failed: "+e.message)}}function showUpdateBanner(){if(document.querySelector(".pwa-update-banner"))return;const e=document.createElement("div");e.className="pwa-update-banner",e.innerHTML='\n    <span>A new version of AskOzzy is available.</span>\n    <button onclick="window.location.reload()">Update Now</button>\n    <button class="dismiss" onclick="this.parentElement.remove()">Later</button>\n  ',document.body.appendChild(e)}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{setInterval(()=>e.update(),36e5),e.addEventListener("updatefound",()=>{const t=e.installing;t.addEventListener("statechange",()=>{"activated"===t.state&&navigator.serviceWorker.controller&&showUpdateBanner()})})}).catch(e=>console.log("SW registration failed:",e))});let _deferredInstallPrompt=null;function isIOSSafari(){const e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1}function isInStandaloneMode(){return window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone}function showInstallBanner(){if(sessionStorage.getItem("askozzy_install_dismissed"))return;if(isInStandaloneMode())return;if(document.querySelector(".pwa-install-banner"))return;const e=document.createElement("div");e.className="pwa-install-banner",e.innerHTML='\n    <div class="pwa-install-content">\n      <div class="pwa-install-icon">&#x26A1;</div>\n      <div class="pwa-install-text">\n        <strong>Install AskOzzy</strong>\n        <span>Add to your home screen for quick access</span>\n      </div>\n    </div>\n    <div class="pwa-install-actions">\n      <button class="pwa-install-btn" onclick="installPWA()">Install</button>\n      <button class="pwa-install-dismiss" onclick="dismissInstallBanner()">Not now</button>\n    </div>\n  ',document.body.appendChild(e)}function showIOSInstallGuide(){if(sessionStorage.getItem("askozzy_install_dismissed"))return;if(isInStandaloneMode())return;if(document.querySelector(".pwa-install-banner"))return;const e=document.createElement("div");e.className="pwa-install-banner",e.innerHTML='\n    <div class="pwa-install-content">\n      <div class="pwa-install-icon">&#x26A1;</div>\n      <div class="pwa-install-text">\n        <strong>Install AskOzzy</strong>\n        <span>Tap <strong style="font-size:16px;">&#x2191;</strong> Share then <strong>"Add to Home Screen"</strong></span>\n      </div>\n    </div>\n    <div class="pwa-install-actions">\n      <button class="pwa-install-dismiss" onclick="dismissInstallBanner()">Got it</button>\n    </div>\n  ',document.body.appendChild(e)}async function installPWA(){if(!_deferredInstallPrompt)return;_deferredInstallPrompt.prompt();const{outcome:e}=await _deferredInstallPrompt.userChoice;"accepted"===e&&(_deferredInstallPrompt=null);const t=document.querySelector(".pwa-install-banner");t&&t.remove()}function dismissInstallBanner(){sessionStorage.setItem("askozzy_install_dismissed","1");const e=document.querySelector(".pwa-install-banner");e&&e.remove()}function updateOnlineStatus(){const e=document.querySelector(".offline-indicator"),t=document.getElementById("offline-status-badge"),n=t?t.querySelector(".offline-status-text"):null;if(navigator.onLine)e&&e.remove(),t&&(t.classList.remove("offline"),t.classList.add("online"),n&&(n.textContent="Online")),navigator.serviceWorker&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"PROCESS_QUEUE"}),setTimeout(updateOfflineQueueBadge,2e3);else{if(!e){const e=document.createElement("div");e.className="offline-indicator",e.innerHTML='<span class="offline-dot"></span> Offline Mode ‚Äî templates available, other messages will be queued',document.body.appendChild(e)}t&&(t.classList.remove("online"),t.classList.add("offline"),n&&(n.textContent="Offline")),updateOfflineQueueBadge()}}function initOfflineStatusBadge(){const e=document.getElementById("offline-status-badge");e&&(navigator.onLine?(e.classList.add("online"),e.querySelector(".offline-status-text").textContent="Online"):(e.classList.add("offline"),e.querySelector(".offline-status-text").textContent="Offline"))}function updateOfflineQueueBadge(){navigator.serviceWorker&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"GET_QUEUE_STATUS"})}function renderQueueBadge(e){const t=document.getElementById("offline-queue-badge"),n=document.getElementById("offline-queue-count");t&&n&&(e>0?(t.style.display="flex",n.textContent=e):t.style.display="none")}function showSyncToast(e,t){t=t||3e3;let n=document.querySelector(".sync-toast");n||(n=document.createElement("div"),n.className="sync-toast",document.body.appendChild(n)),n.textContent=e,n.classList.add("visible"),clearTimeout(n._timer),n._timer=setTimeout(()=>n.classList.remove("visible"),t)}function hapticFeedback(e){if(navigator.vibrate)switch(e){case"light":default:navigator.vibrate(10);break;case"medium":navigator.vibrate(25);break;case"heavy":navigator.vibrate([30,10,30]);break;case"success":navigator.vibrate([10,50,20]);break;case"error":navigator.vibrate([50,30,50,30,50])}}async function updateAppBadge(e){if("setAppBadge"in navigator)try{e>0?await navigator.setAppBadge(e):await navigator.clearAppBadge()}catch{}}async function registerBackgroundSync(){if("serviceWorker"in navigator)try{const e=await navigator.serviceWorker.ready;"sync"in e&&await e.sync.register("sync-offline-queue")}catch{}}function showChatSkeleton(){const e=document.getElementById("chat-messages");if(!e||e.children.length>0)return;const t=document.createElement("div");t.className="chat-skeleton",t.innerHTML='\n    <div class="skeleton-message skeleton"><div class="skeleton-line skeleton" style="width:75%"></div><div class="skeleton-line skeleton" style="width:50%"></div><div class="skeleton-line skeleton" style="width:85%"></div></div>\n    <div class="skeleton-message skeleton" style="margin-left:auto;max-width:70%;"><div class="skeleton-line skeleton" style="width:60%"></div><div class="skeleton-line skeleton"></div></div>\n    <div class="skeleton-message skeleton"><div class="skeleton-line skeleton" style="width:90%"></div><div class="skeleton-line skeleton" style="width:40%"></div></div>\n  ',e.appendChild(t)}function removeChatSkeleton(){const e=document.querySelector(".chat-skeleton");e&&e.remove()}function showSidebarSkeleton(){const e=document.getElementById("conversations-list");e&&(e.innerHTML=Array.from({length:5},()=>'<div class="skeleton-sidebar-item skeleton"></div>').join(""))}function getConnectionQuality(){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(!e)return"unknown";if(e.saveData)return"save-data";return e.effectiveType||"unknown"}window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),_deferredInstallPrompt=e,showInstallBanner()}),window.addEventListener("appinstalled",()=>{_deferredInstallPrompt=null;const e=document.querySelector(".pwa-install-banner");e&&e.remove()}),isIOSSafari()&&!isInStandaloneMode()&&setTimeout(showIOSInstallGuide,3e3),"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{const{data:t}=e;if(t&&t.type)switch(t.type){case"QUEUE_STATUS":renderQueueBadge(t.count),updateAppBadge(t.count||0);break;case"QUEUE_UPDATED":updateOfflineQueueBadge();break;case"OFFLINE_MESSAGE_SENT":hapticFeedback("success"),showSyncToast("Queued message sent successfully"),updateOfflineQueueBadge(),updateAppBadge(0),"function"==typeof loadConversations&&loadConversations();break;case"OFFLINE_TEMPLATE_SERVED":showSyncToast("Serving offline template for: "+(t.templateId||"").replace(/-/g," "));break;case"TEMPLATES_CACHED":console.log("Offline templates cached:",t.count);break;case"SW_UPDATE_AVAILABLE":showSyncToast("Update available ‚Äî pull to refresh",5e3)}}),window.addEventListener("online",()=>{updateOnlineStatus(),hapticFeedback("success"),showSyncToast("Back online ‚Äî syncing queued messages..."),registerBackgroundSync(),updateAppBadge(0)}),window.addEventListener("offline",()=>{updateOnlineStatus(),hapticFeedback("error")}),document.addEventListener("DOMContentLoaded",()=>{initOfflineStatusBadge(),updateOnlineStatus(),navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage({type:"PRECACHE_TEMPLATES"}):navigator.serviceWorker&&navigator.serviceWorker.ready.then(()=>{navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"PRECACHE_TEMPLATES"})})}),function(){let e=0,t=0,n=!1,a=!1;const i=document.createElement("div");i.className="ptr-container",i.innerHTML='<div class="ptr-spinner"><svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.2-8.6"/><polyline points="21 3 21 9 15 9"/></svg></div>',document.body.prepend(i);const o=i.querySelector(".ptr-spinner svg");function s(){const e=document.getElementById("chat-area"),t=document.getElementById("chat-messages"),n=document.getElementById("welcome-screen");return!!(e&&e.scrollTop<=0)||(!!(t&&t.scrollTop<=0)||(!(!n||n.classList.contains("hidden"))||window.scrollY<=0))}document.addEventListener("touchstart",t=>{a||s()&&(e=t.touches[0].clientY,n=!1)},{passive:!0}),document.addEventListener("touchmove",r=>{if(a)return;if(0===e)return;t=r.touches[0].clientY;const l=t-e;if(l<10||!s())return void(n&&(n=!1,i.classList.remove("pulling"),i.style.transform="translateY(-60px)"));n=!0,i.classList.add("pulling");const c=Math.min(l/120,1),d=Math.min(.5*l,60)-60;i.style.transform=`translateY(${d}px)`;const u=180*c;o.style.transform=`rotate(${u}deg)`,l>=80&&!i.dataset.hapticFired&&(i.dataset.hapticFired="1",hapticFeedback("light"))},{passive:!0}),document.addEventListener("touchend",()=>{if(a)return;if(delete i.dataset.hapticFired,!n)return void(e=0);const s=t-e;n=!1,i.classList.remove("pulling"),s>=80?(a=!0,i.classList.add("refreshing"),i.style.transform="translateY(0)",hapticFeedback("medium"),async function(){showSyncToast("Refreshing...");try{isLoggedIn()&&(await loadConversations(),await loadUsageStatus()),navigator.serviceWorker&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"PROCESS_QUEUE"}),await new Promise(e=>setTimeout(e,600))}catch{}}().finally(()=>{a=!1,i.classList.remove("refreshing"),i.style.transform="translateY(-60px)",o.style.transform=""})):(i.style.transform="translateY(-60px)",o.style.transform=""),e=0,t=0},{passive:!0})}(),function(){let e=0,t=0,n=!1;const a=document.createElement("div");a.className="swipe-edge-indicator",document.body.appendChild(a),document.addEventListener("touchstart",i=>{const o=i.touches[0];if(o.clientX<=24){const i=document.getElementById("sidebar");i&&i.classList.contains("collapsed")&&(e=o.clientX,t=o.clientY,n=!0,a.classList.add("active"))}},{passive:!0}),document.addEventListener("touchmove",i=>{if(!n)return;const o=i.touches[0].clientX-e;if(Math.abs(i.touches[0].clientY-t)>o)return n=!1,void a.classList.remove("active");const s=Math.min(o/60,1);a.style.opacity=.6*s,a.style.width=6+4*s+"px"},{passive:!0}),document.addEventListener("touchend",t=>{if(!n)return;n=!1,a.classList.remove("active"),a.style.opacity="",a.style.width="";(t.changedTouches[0]||{}).clientX-e>=60&&(hapticFeedback("light"),toggleSidebar()),e=0},{passive:!0})}();let _wakeLock=null;async function requestWakeLock(){if("wakeLock"in navigator)try{_wakeLock=await navigator.wakeLock.request("screen"),_wakeLock.addEventListener("release",()=>{_wakeLock=null})}catch{}}function releaseWakeLock(){_wakeLock&&(_wakeLock.release(),_wakeLock=null)}!function(){const e=new URLSearchParams(window.location.search);if("share"!==e.get("action"))return;const t=[e.get("title")||"",e.get("text")||"",e.get("url")||""].filter(Boolean).join("\n");t&&(window.history.replaceState({},"","/"),document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{const e=document.getElementById("chat-input");e&&(e.value=t,e.focus(),"function"==typeof autoResizeInput&&autoResizeInput(),showSyncToast("Content shared to AskOzzy"))},500)}))}(),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".send-btn, #send-btn, [onclick*='sendMessage']");e&&e.addEventListener("pointerdown",()=>hapticFeedback("light"),{passive:!0}),document.addEventListener("pointerdown",e=>{e.target.closest(".conversation-item, .template-card, .category-tab")&&hapticFeedback("light")},{passive:!0})});const PushManager={_vapidKey:null,async init(){if(!("Notification"in window)||!("PushManager"in window)||!("serviceWorker"in navigator))return;if(parseInt(localStorage.getItem("askozzy_conv_count")||"0",10)<3)return;const e=await this.getStatus();"subscribed"!==e&&"denied"!==e&&"default"===Notification.permission&&this.showPermissionPrompt()},async subscribe(){if(!("Notification"in window)||!("PushManager"in window))return!1;try{if("granted"!==await Notification.requestPermission())return!1;const e=await navigator.serviceWorker.ready;if(!this._vapidKey)try{const e=await fetch("/api/push/vapid-public-key");if(e.ok){const t=await e.json();this._vapidKey=t.key}}catch{}if(!this._vapidKey)return!1;const t=atob(this._vapidKey.replace(/-/g,"+").replace(/_/g,"/")),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);const a=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n});return state.token&&await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+state.token},body:JSON.stringify({subscription:a.toJSON()})}),showSyncToast("Push notifications enabled"),hapticFeedback("success"),this._dismissPrompt(),!0}catch(e){return console.error("Push subscribe failed:",e),!1}},async unsubscribe(){try{const e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();return t&&(await t.unsubscribe(),state.token&&await fetch("/api/push/unsubscribe",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:"Bearer "+state.token},body:JSON.stringify({endpoint:t.endpoint})})),showSyncToast("Push notifications disabled"),!0}catch{return!1}},async getStatus(){if(!("Notification"in window))return"unsupported";if("denied"===Notification.permission)return"denied";if("default"===Notification.permission)return"prompt";try{const e=await navigator.serviceWorker.ready;return await e.pushManager.getSubscription()?"subscribed":"unsubscribed"}catch{return"error"}},async updatePreferences(e){if(state.token)try{await fetch("/api/push/preferences",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+state.token},body:JSON.stringify(e)})}catch{}},showPermissionPrompt(){if(document.getElementById("push-prompt-bar"))return;const e=document.createElement("div");e.id="push-prompt-bar",e.style.cssText="position:fixed;top:0;left:0;right:0;z-index:10000;transform:translateY(-100%);transition:transform 0.35s ease;background:var(--surface, #1a1a2e);border-bottom:1px solid var(--border, #333);padding:12px 16px;display:flex;align-items:center;gap:12px;font-size:13px;color:var(--text, #eee);",e.innerHTML='\n      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent, #ffd700)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>\n      <span style="flex:1;">Get notified when your AI tasks complete</span>\n      <button id="push-prompt-yes" style="background:var(--accent, #ffd700);color:#000;border:none;border-radius:6px;padding:6px 14px;font-size:12px;font-weight:600;cursor:pointer;">Enable</button>\n      <button id="push-prompt-no" style="background:transparent;border:1px solid var(--border, #555);color:var(--text-secondary, #aaa);border-radius:6px;padding:6px 10px;font-size:12px;cursor:pointer;">Not now</button>',document.body.appendChild(e),requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.style.transform="translateY(0)"})}),document.getElementById("push-prompt-yes").addEventListener("click",()=>PushManager.subscribe()),document.getElementById("push-prompt-no").addEventListener("click",()=>PushManager._dismissPrompt())},_dismissPrompt(){const e=document.getElementById("push-prompt-bar");e&&(e.style.transform="translateY(-100%)",setTimeout(()=>e.remove(),400))}};function viewTransition(e){document.startViewTransition?document.startViewTransition(e):e()}async function shareContent(e,t,n){if(navigator.share)try{await navigator.share({title:e,text:t,url:n}),hapticFeedback("success")}catch(e){"AbortError"!==e.name&&copyToClipboard(t||n)}else copyToClipboard(t||n)}async function shareConversationExcerpt(e){const t=state.conversations.find(function(t){return t.id===e});if(!t)return;const n=t.title||"AskOzzy Conversation";let a="";try{const t=await fetch("/api/conversations/"+e+"/messages",{headers:authHeaders()});if(t.ok){const e=(await t.json()).messages||[];a=e.slice(-3).map(function(e){return("user"===e.role?"You: ":"Ozzy: ")+e.content.substring(0,200)}).join("\n\n")}}catch{}const i=a||n;await shareContent("AskOzzy: "+n,i,"https://askozzy.ghwmelite.workers.dev")}async function shareReferralLink(){const e=state.user&&state.user.referral_code?state.user.referral_code:"",t="https://askozzy.ghwmelite.workers.dev"+(e?"?ref="+e:""),n="Try AskOzzy ‚Äî AI-powered productivity for Government of Ghana."+(e?" Use my referral code: "+e:"");await shareContent("Join AskOzzy",n,t)}async function copyRichText(e,t){if(navigator.clipboard&&"undefined"!=typeof ClipboardItem)try{var n=new ClipboardItem({"text/html":new Blob([e],{type:"text/html"}),"text/plain":new Blob([t],{type:"text/plain"})});await navigator.clipboard.write([n]),showSyncToast("Copied to clipboard"),hapticFeedback("success")}catch{fallbackCopy(t)}else fallbackCopy(t)}function fallbackCopy(e){var t=document.createElement("textarea");t.value=e,t.style.cssText="position:fixed;opacity:0;left:-9999px",document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch{}t.remove(),showSyncToast("Copied to clipboard")}async function saveFile(e,t,n){if("showSaveFilePicker"in window)try{var a=await window.showSaveFilePicker({suggestedName:t,types:n||[{description:"Text Document",accept:{"text/plain":[".txt"]}},{description:"Document",accept:{"application/octet-stream":[".docx",".pdf"]}}]}),i=await a.createWritable();return await i.write(e),await i.close(),showSyncToast("File saved successfully"),hapticFeedback("success"),!0}catch(e){if("AbortError"===e.name)return!1}return downloadFile(e,t),!0}function downloadFile(e,t){var n=e instanceof Blob?e:new Blob([e]),a=URL.createObjectURL(n),i=document.createElement("a");i.href=a,i.download=t,document.body.appendChild(i),i.click(),i.remove(),setTimeout(function(){URL.revokeObjectURL(a)},1e3)}function setMediaSession(e){if("mediaSession"in navigator)if(e)navigator.mediaSession.metadata=new MediaMetadata({title:"AskOzzy Voice",artist:"AskOzzy AI Assistant",album:"Government of Ghana",artwork:[{src:"/icons/icon-192.png",sizes:"192x192",type:"image/png"},{src:"/icons/icon-512.png",sizes:"512x512",type:"image/png"}]}),navigator.mediaSession.setActionHandler("stop",function(){"function"==typeof toggleVoice&&toggleVoice()}),navigator.mediaSession.setActionHandler("pause",function(){"function"==typeof toggleVoice&&toggleVoice()});else{navigator.mediaSession.metadata=null;try{navigator.mediaSession.setActionHandler("stop",null),navigator.mediaSession.setActionHandler("pause",null)}catch{}}}async function lockOrientation(e){if(screen.orientation&&screen.orientation.lock)try{await screen.orientation.lock(e)}catch{}}function unlockOrientation(){if(screen.orientation&&screen.orientation.unlock)try{screen.orientation.unlock()}catch{}}async function initIdleDetection(){if("IdleDetector"in window)try{if("granted"!==await IdleDetector.requestPermission())return;var e=new IdleDetector;e.addEventListener("change",function(){if("idle"===e.userState){var t=document.getElementById("chat-input");t&&t.value.trim()&&localStorage.setItem("askozzy_draft",JSON.stringify({text:t.value,conversationId:state.activeConversationId,timestamp:Date.now()}))}}),await e.start({threshold:12e4})}catch{}}async function pickContactForReferral(){if("contacts"in navigator&&"ContactsManager"in window)try{var e=await navigator.contacts.select(["name","email","tel"],{multiple:!1});if(e.length>0){var t=e[0],n=state.user&&state.user.referral_code?state.user.referral_code:"",a="Hey "+(t.name&&t.name[0]?t.name[0]:"there")+"! Try AskOzzy ‚Äî AI for Government of Ghana. Use my code: "+n+"\nhttps://askozzy.ghwmelite.workers.dev?ref="+n;t.email&&t.email[0]?window.open("mailto:"+t.email[0]+"?subject=Try AskOzzy&body="+encodeURIComponent(a)):t.tel&&t.tel[0]?window.open("sms:"+t.tel[0]+"?body="+encodeURIComponent(a)):await shareContent("Join AskOzzy",a,"https://askozzy.ghwmelite.workers.dev?ref="+n),hapticFeedback("success")}}catch{shareReferralLink()}else shareReferralLink()}function showPaymentSuccess(e){const t=document.createElement("div");t.className="payment-success-banner",t.innerHTML=`\n    <div style="display:flex;align-items:center;gap:12px;padding:16px 24px;background:linear-gradient(135deg, var(--green), var(--green-light));color:white;border-radius:12px;margin:12px;font-size:14px;font-weight:600;animation:slideDown 0.3s ease;">\n      <span style="font-size:24px;">&#x2705;</span>\n      <span>Successfully upgraded to ${e}! All premium features are now unlocked.</span>\n      <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:white;font-size:18px;cursor:pointer;margin-left:auto;">&#x2715;</button>\n    </div>`,document.querySelector(".main-content").prepend(t),setTimeout(()=>t.remove(),8e3)}function showFolderPremiumPrompt(){const e=isStudent()?25:60;confirm(`Folders are a premium feature!\n\nUpgrade to Professional (GHS ${e}/mo) or higher to organize your conversations into folders.\n\nWould you like to view plans?`)&&openPricingModal()}async function pinConversation(e,t){try{await fetch(`/api/conversations/${e}`,{method:"PATCH",headers:authHeaders(),body:JSON.stringify({pinned:t})}),await loadConversations()}catch{alert("Failed to update conversation")}}function toggleWebSearch(){state.webSearchEnabled=!state.webSearchEnabled;const e=document.getElementById("btn-web-search");e&&(e.classList.toggle("active",state.webSearchEnabled),e.title=state.webSearchEnabled?"Web search ON ‚Äî click to disable":"Search the web")}function changeLanguage(e){state.language=e;const t=document.getElementById("lang-selector");t&&(t.textContent={en:"EN",fr:"FR",ha:"HA",tw:"TW",ga:"GA",ee:"EW",dag:"DG"}[e]||"EN");const n=document.getElementById("chat-input");if(n&&"en"!==e){const t={tw:"Bisa Ozzy biribiara... (Twi)",ha:"Tambayi Ozzy komai... (Hausa)",ga:"Bi Ozzy nu... (Ga)",ee:"Bia Ozzy nu... (Ewe)",fr:"Demandez √† Ozzy... (Fran√ßais)",dag:"Bui Ozzy soli... (Dagbani)"};n.placeholder=t[e]||"Ask Ozzy anything..."}else n&&(n.placeholder="Ask Ozzy anything... (Shift+Enter for new line)");_recognition&&(_recognition.lang=getRecognitionLang())}function openLanguageMenu(){let e=document.getElementById("lang-menu");if(e)return void e.classList.toggle("active");e=document.createElement("div"),e.id="lang-menu",e.className="lang-menu active",e.innerHTML=[{code:"en",name:"English",flag:"üá¨üáß"},{code:"tw",name:"Twi (Akan)",flag:"üá¨üá≠"},{code:"ga",name:"Ga",flag:"üá¨üá≠"},{code:"ee",name:"Ewe",flag:"üá¨üá≠"},{code:"ha",name:"Hausa",flag:"üá¨üá≠"},{code:"fr",name:"Fran√ßais",flag:"üá´üá∑"},{code:"dag",name:"Dagbani",flag:"üá¨üá≠"}].map(e=>`<button class="lang-option ${state.language===e.code?"active":""}" onclick="changeLanguage('${e.code}'); document.getElementById('lang-menu').classList.remove('active');">\n      <span>${e.flag}</span> ${e.name}\n    </button>`).join("");const t=document.getElementById("lang-selector");t&&t.parentElement.appendChild(e),setTimeout(()=>{document.addEventListener("click",function t(n){e.contains(n.target)||"lang-selector"===n.target.id||(e.classList.remove("active"),document.removeEventListener("click",t))})},10)}async function translateMessage(e,t){if(!state.token||"en"===t)return e;try{const n=await fetch("/api/translate",{method:"POST",headers:authHeaders(),body:JSON.stringify({text:e,sourceLang:"en",targetLang:t})});return(await n.json()).translated||e}catch{return e}}function speakMessage(e){const t=state.messages[e];if(!t||"assistant"!==t.role)return;if(window.speechSynthesis.speaking)return void window.speechSynthesis.cancel();const n=t.content.replace(/\*\*|__|`{1,3}|#{1,6}\s|>\s|\[.*?\]\(.*?\)/g,"").replace(/<[^>]*>/g,""),a=new SpeechSynthesisUtterance(n.substring(0,5e3));a.lang={en:"en-GB",fr:"fr-FR",ha:"ha",tw:"ak",ga:"gaa",ee:"ee",dag:"dag"}[state.language]||"en-GB",a.rate=.95,a.pitch=1;const i=document.querySelector(`[data-speak="${e}"]`);i&&i.classList.add("speaking"),a.onend=()=>{i&&i.classList.remove("speaking"),state.voiceMode&&setTimeout(()=>toggleVoice(),300)},window.speechSynthesis.speak(a)}function toggleVoiceMode(){state.voiceMode=!state.voiceMode;const e=document.getElementById("btn-voice-mode");e&&e.classList.toggle("active",state.voiceMode),state.voiceMode&&toggleVoice()}function openImageUpload(){requireAuth(()=>{const e=document.createElement("input");e.type="file",e.accept="image/jpeg,image/png,image/gif,image/webp",e.onchange=e=>{const t=Array.from(e.target.files)[0];t&&handleImageFile(t)},e.click()})}function openCamera(){requireAuth(async()=>{try{showCameraPreview(await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}))}catch(e){alert("Camera access denied. Please allow camera access and try again.")}})}function showCameraPreview(e){let t=document.getElementById("camera-overlay");t||(t=document.createElement("div"),t.id="camera-overlay",t.className="camera-overlay",t.innerHTML='\n      <div class="camera-container">\n        <video id="camera-video" autoplay playsinline></video>\n        <div class="camera-controls">\n          <button class="camera-btn cancel" onclick="closeCamera()">&#x2715;</button>\n          <button class="camera-btn capture" onclick="capturePhoto()">&#x1F4F7;</button>\n          <button class="camera-btn switch" onclick="switchCamera()">&#x1F504;</button>\n        </div>\n      </div>',document.body.appendChild(t)),t.classList.add("active");document.getElementById("camera-video").srcObject=e,t._stream=e}function closeCamera(){const e=document.getElementById("camera-overlay");if(e){const t=document.getElementById("camera-video");t&&t.srcObject&&(t.srcObject.getTracks().forEach(e=>e.stop()),t.srcObject=null),e._stream&&e._stream.getTracks().forEach(e=>e.stop()),e.classList.remove("active")}}async function switchCamera(){closeCamera();try{showCameraPreview(await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}))}catch{}}function capturePhoto(){const e=document.getElementById("camera-video");if(!e)return;const t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight,t.getContext("2d").drawImage(e,0,0),t.toBlob(e=>{closeCamera();handleImageFile(new File([e],"photo.jpg",{type:"image/jpeg"}))},"image/jpeg",.85)}function handleImageFile(e){e.size>5242880?alert("Image must be under 5MB"):showImagePreview(e)}function showImagePreview(e){const t=new FileReader;t.onload=t=>{let n=document.getElementById("image-preview");if(!n){n=document.createElement("div"),n.id="image-preview",n.className="image-preview";const e=document.querySelector(".input-wrapper");e&&e.insertBefore(n,e.firstChild)}n.innerHTML=`\n      <div class="image-preview-inner">\n        <img src="${t.target.result}" alt="Preview" />\n        <div class="image-preview-actions">\n          <select id="vision-mode" class="vision-mode-select">\n            <option value="describe">Describe</option>\n            <option value="ocr">Extract Text (OCR)</option>\n            <option value="form">Extract Form Data</option>\n            <option value="receipt">Process Receipt</option>\n          </select>\n          <button onclick="sendImageMessage()" class="btn-send-image">Analyse</button>\n          <button onclick="clearImagePreview()" class="btn-clear-image">&#x2715;</button>\n        </div>\n      </div>`,n.classList.add("active"),n._file=e},t.readAsDataURL(e)}function clearImagePreview(){const e=document.getElementById("image-preview");e&&(e.classList.remove("active"),e._file=null,e.innerHTML="")}async function sendImageMessage(){const e=document.getElementById("image-preview"),t=e?._file;if(!t)return;const n=document.getElementById("vision-mode")?.value||"describe",a=document.getElementById("chat-input"),i=a.value.trim();if(clearImagePreview(),a.value="",showChatScreen(),!state.activeConversationId)try{const e=await fetch("/api/conversations",{method:"POST",headers:authHeaders(),body:JSON.stringify({title:"Image Analysis",model:state.selectedModel})}),t=await e.json();state.activeConversationId=t.id,await loadConversations()}catch{return void alert("Failed to create conversation")}const o=URL.createObjectURL(t);state.messages.push({role:"user",content:`[Image: ${t.name}] ${i||n}`,imageUrl:o}),renderMessages(),addTypingIndicator(),state.isStreaming=!0,updateSendButton();try{const e=new FormData;e.append("image",t),e.append("conversationId",state.activeConversationId),e.append("mode",n),i&&e.append("prompt",i),e.append("model",state.selectedModel);const a=await fetch("/api/chat/image",{method:"POST",headers:{Authorization:`Bearer ${state.token}`},body:e});if(removeTypingIndicator(),!a.ok){const e=await a.json();if("TIER_REQUIRED"===e.code)return state.messages.push({role:"assistant",content:"**Image understanding requires a Professional plan or above.** Upgrade to unlock image analysis, OCR, and document scanning."}),void renderMessages();throw new Error(e.error||"Image analysis failed")}const o=await a.json();state.messages.push({role:"assistant",content:o.response}),renderMessages(),await loadConversations()}catch(e){removeTypingIndicator(),state.messages.push({role:"assistant",content:`**Error:** ${e.message}`}),renderMessages()}finally{state.isStreaming=!1,updateSendButton()}}function openDeepResearch(){requireAuth(()=>{const e=document.getElementById("chat-input"),t=e.value.trim();if(!t)return e.placeholder="Type your research question, then click Deep Research...",void e.focus();startResearch(t)})}async function startResearch(e){if(state.isStreaming)return;if(!state.activeConversationId)try{const t=await fetch("/api/conversations",{method:"POST",headers:authHeaders(),body:JSON.stringify({title:"Research: "+(e.length>50?e.substring(0,47)+"...":e),model:state.selectedModel})}),n=await t.json();state.activeConversationId=n.id,showChatScreen(),await loadConversations()}catch(e){return void alert("Failed to create conversation")}document.getElementById("chat-input").value="",autoResizeInput(),updateSendButton(),state.messages.push({role:"user",content:e}),renderMessages();const t="research-card-"+Date.now(),n=document.getElementById("chat-messages"),a=document.createElement("div");a.id=t,a.className="message assistant",a.innerHTML=`\n    <div class="message-avatar">G</div>\n    <div class="message-body">\n      <div class="message-sender">AskOzzy Deep Research</div>\n      <div class="research-card">\n        <div class="research-progress">\n          <div class="research-progress-bar" id="${t}-bar" style="width:0%"></div>\n        </div>\n        <div class="research-step" id="${t}-step">Initialising research...</div>\n        <div class="research-sources" id="${t}-sources">\n          <div class="sources-label">Sources found:</div>\n        </div>\n      </div>\n    </div>`,n.appendChild(a),scrollToBottom(),state.isStreaming=!0,updateSendButton();try{const n=await fetch("/api/research",{method:"POST",headers:authHeaders(),body:JSON.stringify({query:e,conversationId:state.activeConversationId})});if(!n.ok){const e=await n.json();if("TIER_REQUIRED"===e.code)return void(a.querySelector(".research-card").innerHTML='\n          <div style="text-align:center;padding:20px;">\n            <div style="font-size:32px;margin-bottom:12px;">&#x1F512;</div>\n            <h4>Professional Plan Required</h4>\n            <p style="color:var(--text-secondary);margin:8px 0 16px;">Deep Research is available on Professional and Enterprise plans.</p>\n            <button class="btn-auth" onclick="openPricingModal()" style="padding:10px 24px;">View Plans</button>\n          </div>');throw new Error(e.error||"Research failed")}const i=n.body.getReader(),o=new TextDecoder;let s="",r=[],l="";for(;;){const{done:e,value:n}=await i.read();if(e)break;const c=o.decode(n).split("\n");for(const e of c)if(e.startsWith("event: "))s=e.slice(7).trim();else if(e.startsWith("data: ")){try{const n=JSON.parse(e.slice(6));if("research:step"===s){const e=n.step/n.total*100,a=document.getElementById(`${t}-bar`),i=document.getElementById(`${t}-step`);a&&(a.style.width=e+"%"),i&&(i.textContent=`Step ${n.step}/${n.total}: ${n.description}`),scrollToBottom()}if("research:source"===s){r.push(n);const e=document.getElementById(`${t}-sources`);if(e){const t=document.createElement("a");t.href=n.url,t.target="_blank",t.rel="noopener",t.className="source-card";const a=(()=>{try{return new URL(n.url).hostname.replace("www.","")}catch{return""}})();t.innerHTML=`<img src="https://www.google.com/s2/favicons?domain=${encodeURIComponent(a)}&sz=16" alt="" class="source-favicon" /><span class="source-title">${escapeHtml(n.title.substring(0,50))}</span>`,e.appendChild(t),scrollToBottom()}}if("research:complete"===s){l=n.report,state.messages.push({role:"assistant",content:l,webSources:n.sources||r,isResearch:!0}),a.remove(),renderMessages();openArtifactPanel({type:"document",title:"Research Report",content:l})}"research:error"===s&&(a.querySelector(".research-card").innerHTML=`<div style="color:var(--red-error-text);padding:16px;">Research failed: ${escapeHtml(n.error)}</div>`)}catch{}s=""}}await loadConversations()}catch(e){const n=document.getElementById(t);n&&(n.querySelector(".research-card").innerHTML=`<div style="color:var(--red-error-text);padding:16px;">Error: ${escapeHtml(e.message)}</div>`)}finally{state.isStreaming=!1,updateSendButton()}}function openDataAnalysis(){requireAuth(()=>{const e=document.createElement("input");e.type="file",e.accept=".csv,.xlsx",e.onchange=async e=>{const t=Array.from(e.target.files)[0];t&&(t.size>10485760?alert("File size must be under 10MB"):await analyzeData(t))},e.click()})}function parseCSV(e){const t=[];let n=!1;const a=e.split("\n");for(const e of a){const a=[];let i="";for(let t=0;t<e.length;t++){const o=e[t];'"'===o?n&&'"'===e[t+1]?(i+='"',t++):n=!n:","!==o||n?i+=o:(a.push(i.trim()),i="")}a.push(i.trim()),a.some(e=>e)&&t.push(a)}return t}async function analyzeData(e,t){if(showChatScreen(),!state.activeConversationId)try{const t=await fetch("/api/conversations",{method:"POST",headers:authHeaders(),body:JSON.stringify({title:"Analysis: "+e.name,model:state.selectedModel})}),n=await t.json();state.activeConversationId=n.id,await loadConversations()}catch{return void alert("Failed to create conversation")}state.messages.push({role:"user",content:`Analyze data: ${e.name}${t?"\n"+t:""}`}),renderMessages(),addTypingIndicator(),state.isStreaming=!0,updateSendButton();try{const n=new FormData;n.append("file",e),t&&n.append("prompt",t);const a=await fetch("/api/analyze",{method:"POST",headers:{Authorization:`Bearer ${state.token}`},body:n});if(removeTypingIndicator(),!a.ok){const e=await a.json();if("TIER_REQUIRED"===e.code)return state.messages.push({role:"assistant",content:"**Data Analysis requires a Professional plan or above.** Upgrade to unlock data analysis, chart generation, and insights.\n\n[View Plans](#)"}),void renderMessages();throw new Error(e.error||"Analysis failed")}const i=await a.json();let o=`**Data Analysis: ${e.name}**\n\n`;o+=`**Summary:** ${i.summary}\n\n`,i.insights&&i.insights.length>0&&(o+="**Key Insights:**\n",i.insights.forEach((e,t)=>{o+=`${t+1}. ${e}\n`})),o+=`\n*${i.rawData?.totalRows||0} rows analysed. Open the analysis panel for charts and data table.*`,state.messages.push({role:"assistant",content:o}),renderMessages(),openAnalysisPanel(i,e.name)}catch(e){removeTypingIndicator(),state.messages.push({role:"assistant",content:`**Error:** ${e.message}`}),renderMessages()}finally{state.isStreaming=!1,updateSendButton()}}function openAnalysisPanel(e,t){let n=document.getElementById("artifact-panel");n||(n=document.createElement("div"),n.id="artifact-panel",n.className="artifact-panel",n.innerHTML='\n      <div class="artifact-header">\n        <div class="artifact-title-area">\n          <span class="artifact-type-icon"></span>\n          <span class="artifact-title"></span>\n        </div>\n        <div class="artifact-actions">\n          <button onclick="copyArtifact()" title="Copy">&#x1F4CB;</button>\n          <button onclick="downloadArtifact()" title="Download">&#x1F4BE;</button>\n          <button onclick="closeArtifactPanel()" title="Close">&#x2715;</button>\n        </div>\n      </div>\n      <div class="artifact-content" id="artifact-content"></div>\n    ',document.querySelector(".main-content").appendChild(n)),n.querySelector(".artifact-type-icon").textContent="&#x1F4CA;",n.querySelector(".artifact-title").textContent="Data Analysis: "+(t||"");const a=n.querySelector("#artifact-content");let i='<div class="analysis-tabs">\n    <button class="analysis-tab active" onclick="switchAnalysisTab(\'summary\', this)">Summary</button>\n    <button class="analysis-tab" onclick="switchAnalysisTab(\'charts\', this)">Charts</button>\n    <button class="analysis-tab" onclick="switchAnalysisTab(\'data\', this)">Data Table</button>\n  </div>';i+=`<div class="analysis-tab-content" id="analysis-tab-summary">\n    <div class="analysis-summary"><p>${escapeHtml(e.summary||"")}</p></div>\n    <h4>Key Insights</h4>\n    <ul class="analysis-insights">\n      ${(e.insights||[]).map(e=>`<li>${escapeHtml(e)}</li>`).join("")}\n    </ul>\n    <button class="btn-template-picker" onclick="downloadAnalysisReport()" style="margin-top:16px;">&#x1F4E5; Download Report</button>\n  </div>`,i+=`<div class="analysis-tab-content hidden" id="analysis-tab-charts">\n    ${(e.chartConfigs||[]).map((e,t)=>`\n      <div class="chart-container">\n        <h4>${escapeHtml(e.title||"Chart "+(t+1))}</h4>\n        <canvas id="analysis-chart-${t}" width="400" height="250"></canvas>\n      </div>\n    `).join("")||'<p style="color:var(--text-muted);padding:20px;">No chart suggestions available for this dataset.</p>'}\n  </div>`,i+='<div class="analysis-tab-content hidden" id="analysis-tab-data">',e.rawData&&e.rawData.headers&&(i+=`<div class="data-table-wrapper"><table class="data-table">\n      <thead><tr>${e.rawData.headers.map(e=>`<th>${escapeHtml(e)}</th>`).join("")}</tr></thead>\n      <tbody>${(e.rawData.rows||[]).slice(0,100).map(e=>`<tr>${e.map(e=>`<td>${escapeHtml(String(e))}</td>`).join("")}</tr>`).join("")}</tbody>\n    </table></div>`,e.rawData.totalRows>100&&(i+=`<p style="color:var(--text-muted);font-size:12px;padding:8px;">Showing first 100 of ${e.rawData.totalRows} rows</p>`)),i+="</div>",a.innerHTML=i,state.currentArtifact={type:"analysis",title:"Data Analysis: "+t,content:JSON.stringify(e,null,2),analysisData:e},n.classList.add("open"),document.querySelector(".main-content").classList.add("has-artifact"),e.chartConfigs&&loadChartJs().then(()=>{const t=["#CE1126","#FCD116","#006B3F","#1a1d27","#e8eaed","#00a86b","#b89a10","#ff6b7a"];setTimeout(()=>{e.chartConfigs.forEach((e,n)=>{const a=document.getElementById(`analysis-chart-${n}`);if(a)try{const n=(e.datasets||[]).map((n,a)=>({...n,backgroundColor:"pie"===e.type||"doughnut"===e.type?t.slice(0,(n.data||[]).length):t[a%t.length]+"CC",borderColor:"line"===e.type?t[a%t.length]:void 0,borderWidth:"line"===e.type?2:1}));new Chart(a,{type:e.type||"bar",data:{labels:e.labels||[],datasets:n},options:{responsive:!0,plugins:{legend:{labels:{color:"var(--text-primary)"}}},scales:"pie"===e.type||"doughnut"===e.type?{}:{x:{ticks:{color:"var(--text-secondary)"}},y:{ticks:{color:"var(--text-secondary)"}}}}})}catch(e){console.error("Chart render error:",e)}})},100)})}function switchAnalysisTab(e,t){document.querySelectorAll(".analysis-tab-content").forEach(e=>e.classList.add("hidden")),document.querySelectorAll(".analysis-tab").forEach(e=>e.classList.remove("active"));const n=document.getElementById("analysis-tab-"+e);n&&n.classList.remove("hidden"),t&&t.classList.add("active")}function downloadAnalysisReport(){if(!state.currentArtifact?.analysisData)return;const e=state.currentArtifact.analysisData;let t="DATA ANALYSIS REPORT\n"+"=".repeat(50)+"\n\n";t+="SUMMARY\n"+e.summary+"\n\n",t+="KEY INSIGHTS\n",(e.insights||[]).forEach((e,n)=>{t+=`${n+1}. ${e}\n`});const n=new Blob([t],{type:"text/plain"}),a=URL.createObjectURL(n),i=document.createElement("a");i.href=a,i.download="analysis-report.txt",i.click(),URL.revokeObjectURL(a)}function openFileUpload(){if(!isLoggedIn())return void requireAuth(openFileUpload);const e=document.createElement("input");e.type="file",e.accept=".txt,.md,.csv,.json,.html,.htm",e.onchange=async e=>{const t=e.target.files[0];if(t)if(t.size>2097152)alert("File size must be under 2MB");else try{const e=await t.text();document.getElementById("chat-input").value=`[Uploaded file: ${t.name}]\n\n${e.substring(0,1e4)}${e.length>1e4?"\n\n... (truncated)":""}\n\nPlease analyze this document and provide a summary.`,autoResizeInput(),updateSendButton(),showChatScreen()}catch{alert("Failed to read file")}},e.click()}async function shareConversation(e){if(isLoggedIn())try{const t=await fetch(`/api/conversations/${e}/share`,{method:"POST",headers:authHeaders()}),n=await t.json();if(!t.ok)return void alert(n.error||"Failed to share");showShareModal(`${window.location.origin}/?shared=${n.shareToken}`,n.shareToken,e)}catch{alert("Failed to share conversation")}}function showShareModal(e,t,n){let a=document.getElementById("share-modal");a||(a=document.createElement("div"),a.className="modal-overlay",a.id="share-modal",a.addEventListener("click",e=>{e.target===a&&a.classList.remove("active")}),document.body.appendChild(a)),a.innerHTML=`\n    <div class="modal" style="max-width:500px;">\n      <div class="modal-header">\n        <h3>Share Conversation</h3>\n        <button class="modal-close" onclick="document.getElementById('share-modal').classList.remove('active')">&#x2715;</button>\n      </div>\n      <div class="modal-body" style="padding:24px;">\n        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Anyone with this link can view (read-only) this conversation.</p>\n        <div style="display:flex;gap:8px;margin-bottom:16px;">\n          <input type="text" value="${e}" readonly id="share-url-input" style="flex:1;padding:10px 14px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:13px;" />\n          <button onclick="navigator.clipboard.writeText('${e}');this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',2000)" style="background:var(--gold);color:var(--text-on-accent);border:none;border-radius:8px;padding:10px 16px;font-weight:600;cursor:pointer;">Copy</button>\n        </div>\n        <button onclick="revokeShare('${n}')" style="background:none;border:1px solid var(--red-error-text);color:var(--red-error-text);border-radius:8px;padding:8px 16px;font-size:12px;cursor:pointer;">Revoke Sharing</button>\n      </div>\n    </div>`,a.classList.add("active")}async function revokeShare(e){try{await fetch(`/api/conversations/${e}/share`,{method:"DELETE",headers:authHeaders()}),document.getElementById("share-modal")?.classList.remove("active"),alert("Share link revoked")}catch{alert("Failed to revoke share")}}async function loadSharedConversation(e){try{const t=await fetch(`/api/shared/${e}`),n=await t.json();if(!t.ok)return void alert(n.error||"Shared conversation not found");let a=document.getElementById("shared-view-modal");a||(a=document.createElement("div"),a.className="modal-overlay active",a.id="shared-view-modal",a.addEventListener("click",e=>{e.target===a&&a.classList.remove("active")}),document.body.appendChild(a)),a.innerHTML=`\n      <div class="modal" style="max-width:800px;max-height:85vh;">\n        <div class="modal-header">\n          <div>\n            <h3>${escapeHtml(n.title)}</h3>\n            <p style="font-size:12px;color:var(--text-muted);margin:4px 0 0;">Shared by ${escapeHtml(n.authorName)} (${escapeHtml(n.authorDept||"GoG")})</p>\n          </div>\n          <button class="modal-close" onclick="document.getElementById('shared-view-modal').classList.remove('active')">&#x2715;</button>\n        </div>\n        <div class="modal-body" style="padding:16px 24px;overflow-y:auto;max-height:65vh;">\n          ${n.messages.map(e=>`\n            <div class="message ${e.role}" style="margin-bottom:16px;">\n              <div class="message-avatar">${"user"===e.role?"U":"G"}</div>\n              <div class="message-body">\n                <div class="message-sender">${"user"===e.role?"User":"AskOzzy"}</div>\n                <div class="message-content">${"user"===e.role?escapeHtml(e.content):renderMarkdown(e.content)}</div>\n              </div>\n            </div>\n          `).join("")}\n        </div>\n      </div>`,a.classList.add("active")}catch{alert("Failed to load shared conversation")}}async function loadFollowUpSuggestions(){if(isLoggedIn()&&state.activeConversationId&&!(state.messages.length<2))try{const e=await fetch(`/api/chat/suggestions/${state.activeConversationId}`,{headers:authHeaders()}),t=await e.json();t.suggestions&&t.suggestions.length>0&&renderSuggestionPills(t.suggestions)}catch{}}function renderSuggestionPills(e){const t=document.getElementById("suggestion-pills");t&&t.remove();const n=document.createElement("div");n.id="suggestion-pills",n.className="suggestion-pills",n.innerHTML=e.map(e=>`<button class="suggestion-pill" onclick="useSuggestion(this, '${escapeHtml(e).replace(/'/g,"\\'")}')">${escapeHtml(e)}</button>`).join("");const a=document.querySelector(".input-area");a&&a.prepend(n)}function useSuggestion(e,t){const n=document.getElementById("chat-input");n.value=t,autoResizeInput(),updateSendButton(),n.focus();const a=document.getElementById("suggestion-pills");a&&a.remove()}async function loadMemories(){if(isLoggedIn())try{const e=await fetch("/api/memories",{headers:authHeaders()}),t=await e.json();state.memories=t.memories||[]}catch{}}function openMemoryModal(){let e='<div class="memory-list">';const t=state.memories||[];0===t.length&&(e+='<div style="text-align:center;padding:20px;color:var(--text-muted);">No memories yet. As you chat, Ozzy will learn about you ‚Äî or add details manually below.</div>');for(const n of t)e+=`<div class="memory-item" id="memory-${n.id}">\n      <div class="memory-content">\n        <span class="memory-key">${escapeHtml(n.key)}</span>\n        <span class="memory-value">${escapeHtml(n.value)}</span>\n      </div>\n      <button class="memory-delete" onclick="deleteMemory('${n.id}')" title="Remove">√ó</button>\n    </div>`;e+="</div>",e+='<div class="memory-add">\n    <input type="text" id="memory-new-key" placeholder="e.g., Department" style="flex:1;" />\n    <input type="text" id="memory-new-value" placeholder="e.g., Ministry of Finance" style="flex:2;" />\n    <button onclick="addMemory()">Add</button>\n  </div>',e+=`<div style="font-size:11px;color:var(--text-muted);margin-top:12px;text-align:center;">${t.length} / 20 memory slots used</div>`;let n=document.getElementById("memory-modal");n||(n=document.createElement("div"),n.id="memory-modal",n.className="modal-overlay",n.innerHTML='<div class="modal" style="max-width:560px;">\n      <div class="modal-header">\n        <div>\n          <h3>üß† Ozzy\'s Memory</h3>\n          <p style="font-size:12px;color:var(--text-muted);margin:4px 0 0;">What Ozzy knows about you ‚Äî used to personalize responses</p>\n        </div>\n        <button class="modal-close" onclick="closeMemoryModal()">‚úï</button>\n      </div>\n      <div class="modal-body" id="memory-modal-body" style="padding:16px;"></div>\n    </div>',document.body.appendChild(n)),document.getElementById("memory-modal-body").innerHTML=e,n.classList.add("active")}function closeMemoryModal(){const e=document.getElementById("memory-modal");e&&e.classList.remove("active")}async function addMemory(){const e=document.getElementById("memory-new-key"),t=document.getElementById("memory-new-value"),n=e.value.trim(),a=t.value.trim();if(n&&a)try{await fetch("/api/memories",{method:"POST",headers:authHeaders(),body:JSON.stringify({key:n,value:a})}),e.value="",t.value="",await loadMemories(),openMemoryModal()}catch{}}async function deleteMemory(e){try{await fetch(`/api/memories/${e}`,{method:"DELETE",headers:authHeaders()}),await loadMemories();const t=document.getElementById("memory-"+e);t&&t.remove()}catch{}}function detectArtifact(e){const t=e.match(/```(\w+)?\n([\s\S]{100,}?)```/);if(t)return{type:"code",title:t[1]?`${t[1]} Code`:"Code",content:t[2]};if([/(?:MEMORANDUM|MEMO|OFFICE\s+OF|MINISTRY\s+OF|REPUBLIC\s+OF|GOVERNMENT\s+OF)/i,/(?:Dear\s+(?:Sir|Madam|Hon|Dr|Mr|Mrs|Ms))/i,/(?:RE:|REF:|SUBJECT:)/i].some(t=>t.test(e))&&e.length>300){const t=e.match(/(?:RE:|SUBJECT:|MEMORANDUM|MEMO)[:\s]*([^\n]+)/i);return{type:"document",title:t?t[1].trim().slice(0,60):"Document",content:e}}return e.split("\n").filter(e=>e.includes("|")&&e.trim().startsWith("|")).length>=3?{type:"table",title:"Data Table",content:e}:null}function openArtifactPanel(e){let t=document.getElementById("artifact-panel");t||(t=document.createElement("div"),t.id="artifact-panel",t.className="artifact-panel",t.innerHTML='\n      <div class="artifact-header">\n        <div class="artifact-title-area">\n          <span class="artifact-type-icon"></span>\n          <span class="artifact-title"></span>\n        </div>\n        <div class="artifact-actions">\n          <button onclick="copyArtifact()" title="Copy">üìã</button>\n          <button onclick="downloadArtifact()" title="Download">üíæ</button>\n          <button onclick="closeArtifactPanel()" title="Close">‚úï</button>\n        </div>\n      </div>\n      <div class="artifact-content" id="artifact-content"></div>\n    ',document.querySelector(".main-content").appendChild(t));t.querySelector(".artifact-type-icon").textContent={document:"üìÑ",code:"üíª",table:"üìä",list:"üìã"}[e.type]||"üìÑ",t.querySelector(".artifact-title").textContent=e.title;const n=t.querySelector("#artifact-content");"code"===e.type?n.innerHTML=`<pre class="artifact-code"><code>${escapeHtml(e.content)}</code></pre>`:"table"===e.type?n.innerHTML=renderMarkdownTable(e.content):n.innerHTML=`<div class="artifact-document" contenteditable="true">${renderMarkdown(e.content)}</div>`,state.currentArtifact=e,t.classList.add("open"),document.querySelector(".main-content").classList.add("has-artifact")}function renderMarkdownTable(e){const t=e.split("\n").filter(e=>e.trim().startsWith("|"));if(t.length<2)return"<pre>"+escapeHtml(e)+"</pre>";let n='<table class="artifact-table">';return t.forEach((e,t)=>{if(e.includes("---"))return;const a=e.split("|").filter(e=>e.trim()),i=0===t?"th":"td";n+="<tr>"+a.map(e=>`<${i}>${escapeHtml(e.trim())}</${i}>`).join("")+"</tr>"}),n+="</table>",n}function closeArtifactPanel(){const e=document.getElementById("artifact-panel");e&&e.classList.remove("open"),document.querySelector(".main-content").classList.remove("has-artifact"),state.currentArtifact=null}function copyArtifact(){state.currentArtifact&&navigator.clipboard.writeText(state.currentArtifact.content).then(()=>{const e=document.querySelector(".artifact-actions button");e&&(e.textContent="‚úì",setTimeout(()=>e.textContent="üìã",1500))})}async function downloadArtifact(){if(!state.currentArtifact)return;const e=state.currentArtifact;if("document"===e.type)try{await loadDocxJs();const t=_buildGoGDocx(e.content,e.title||"Document"),n=await docx.Packer.toBlob(t);return void _triggerDownload(n,(e.title||"document").replace(/[^a-zA-Z0-9-_ ]/g,"")+".docx")}catch(e){console.error("DOCX artifact generation failed:",e)}const t="code"===e.type?".txt":"table"===e.type?".csv":".md";let n=e.content;if("table"===e.type){const e=n.split("\n").filter(e=>e.includes("|")&&!e.includes("---"));n=e.map(e=>e.split("|").filter(e=>e.trim()).map(e=>'"'+e.trim()+'"').join(",")).join("\n")}const a=new Blob([n],{type:"text/plain"}),i=URL.createObjectURL(a),o=document.createElement("a");o.href=i,o.download=(e.title||"artifact").replace(/[^a-zA-Z0-9-_ ]/g,"")+t,o.click(),URL.revokeObjectURL(i)}async function loadAgents(){try{const e=await fetch(`/api/agents?user_type=${state.userType||"gog_employee"}`),t=await e.json();state.agents=t.agents||[],renderAgentSelector()}catch{}}function renderAgentSelector(){const e=state.agents||[];if(0===e.length)return;let t=document.getElementById("agent-selector-btn");if(!t){t=document.createElement("button"),t.id="agent-selector-btn",t.className="agent-selector-btn",t.onclick=openAgentModal;const e=document.getElementById("model-selector");e&&e.parentNode.insertBefore(t,e.nextSibling)}const n=state.selectedAgent;if(n){const a=e.find(e=>e.id===n);t.innerHTML=`<span>${a?a.icon:"ü§ñ"}</span> ${a?a.name:"Agent"}`,t.classList.add("active")}else t.innerHTML="ü§ñ Agents",t.classList.remove("active")}function openAgentModal(){const e=state.agents||[];let t=document.getElementById("agent-modal");t||(t=document.createElement("div"),t.id="agent-modal",t.className="modal-overlay",t.innerHTML='<div class="modal" style="max-width:640px;">\n      <div class="modal-header">\n        <h3>ü§ñ Choose an AI Agent</h3>\n        <button class="modal-close" onclick="closeAgentModal()">‚úï</button>\n      </div>\n      <div class="modal-body" id="agent-modal-body" style="padding:16px;"></div>\n    </div>',document.body.appendChild(t));let n='<p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Agents are specialized AI assistants trained for specific government departments and tasks.</p>';n+=`<div class="agent-card ${state.selectedAgent?"":"active"}" onclick="selectAgent(null)">\n    <div class="agent-icon">‚ö°</div>\n    <div class="agent-info">\n      <div class="agent-name">General Ozzy</div>\n      <div class="agent-desc">Default AI assistant ‚Äî knows everything, no department focus</div>\n    </div>\n  </div>`;for(const t of e)n+=`<div class="agent-card ${state.selectedAgent===t.id?"active":""}" onclick="selectAgent('${t.id}')">\n      <div class="agent-icon">${t.icon||"ü§ñ"}</div>\n      <div class="agent-info">\n        <div class="agent-name">${escapeHtml(t.name)}</div>\n        <div class="agent-desc">${escapeHtml(t.description||t.department||"")}</div>\n      </div>\n    </div>`;document.getElementById("agent-modal-body").innerHTML=n,t.classList.add("active")}function closeAgentModal(){const e=document.getElementById("agent-modal");e&&e.classList.remove("active")}function selectAgent(e){state.selectedAgent=e,renderAgentSelector(),closeAgentModal()}async function openWorkflows(){requireAuth(async()=>{let e=document.getElementById("workflow-modal");e||(e=document.createElement("div"),e.id="workflow-modal",e.className="modal-overlay",e.addEventListener("click",t=>{t.target===e&&e.classList.remove("active")}),document.body.appendChild(e)),e.innerHTML='<div class="modal" style="max-width:700px;">\n      <div class="modal-header">\n        <h3>&#x2699;&#xFE0F; Workflow Automation</h3>\n        <button class="modal-close" onclick="document.getElementById(\'workflow-modal\').classList.remove(\'active\')">&#x2715;</button>\n      </div>\n      <div class="modal-body" id="workflow-modal-body" style="padding:20px;">\n        <div style="text-align:center;padding:20px;color:var(--text-muted);">Loading...</div>\n      </div>\n    </div>',e.classList.add("active");try{const[e,t]=await Promise.all([fetch("/api/workflows/templates",{headers:authHeaders()}),fetch("/api/workflows",{headers:authHeaders()})]),{templates:n}=await e.json(),{workflows:a}=await t.json();let i='<h4 style="margin:0 0 12px;font-size:14px;color:var(--text-primary);">Start New Workflow</h4>';i+='<div class="workflow-templates">';for(const e of n)i+=`<button class="workflow-template-card" onclick="startWorkflow('${e.id}', '${escapeHtml(e.name)}')">\n          <div class="wf-name">${escapeHtml(e.name)}</div>\n          <div class="wf-desc">${escapeHtml(e.description)}</div>\n          <div class="wf-steps">${e.steps.length} steps</div>\n        </button>`;if(i+="</div>",a.length>0){i+='<h4 style="margin:20px 0 12px;font-size:14px;color:var(--text-primary);">Recent Workflows</h4>',i+='<div class="workflow-list">';for(const e of a.slice(0,10)){const t="completed"===e.status?"&#x2705;":"in_progress"===e.status?"&#x1F504;":"&#x1F4DD;";i+=`<div class="workflow-item" onclick="openWorkflowDetail('${e.id}')">\n            <span>${t}</span>\n            <span class="wf-item-name">${escapeHtml(e.name)}</span>\n            <span class="wf-item-status">${e.status}</span>\n          </div>`}i+="</div>"}document.getElementById("workflow-modal-body").innerHTML=i}catch{document.getElementById("workflow-modal-body").innerHTML='<p style="color:var(--red-error-text);">Failed to load workflows.</p>'}})}async function startWorkflow(e,t){try{const n=await fetch("/api/workflows",{method:"POST",headers:authHeaders(),body:JSON.stringify({templateId:e,name:t})}),a=await n.json();if(!n.ok)throw new Error(a.error);openWorkflowWizard(a.id,a.steps,a.name,0)}catch(e){alert(e.message||"Failed to start workflow")}}async function openWorkflowDetail(e){try{const t=await fetch("/api/workflows/"+e,{headers:authHeaders()}),{workflow:n}=await t.json(),a=JSON.parse(n.steps||"[]");if("completed"===n.status&&n.output){openArtifactPanel({type:"document",title:n.name,content:n.output}),document.getElementById("workflow-modal").classList.remove("active")}else openWorkflowWizard(e,a,n.name,n.current_step)}catch{alert("Failed to load workflow")}}function openWorkflowWizard(e,t,n,a){renderWorkflowStep(document.getElementById("workflow-modal-body"),e,t,n,a)}function renderWorkflowStep(e,t,n,a,i){const o=n[i];if(!o)return;let s=`<div class="workflow-wizard">\n    <div class="wf-progress"><div class="wf-progress-bar" style="width:${(i/n.length*100).toFixed(0)}%"></div></div>\n    <div class="wf-step-indicator">Step ${i+1} of ${n.length}: <strong>${escapeHtml(o.name)}</strong></div>\n    <div class="wf-step-dots">${n.map((e,t)=>`<span class="wf-dot ${t<i?"done":t===i?"current":""}">${t+1}</span>`).join("")}</div>\n    <textarea id="wf-step-input" class="wf-input" rows="6" placeholder="Enter details for: ${escapeHtml(o.name)}...">${escapeHtml(o.input||"")}</textarea>\n    <div id="wf-hint" class="wf-hint"></div>\n    <div class="wf-actions">\n      ${i>0?`<button class="btn-template-picker" onclick="renderWorkflowStep(document.getElementById('workflow-modal-body'), '${t}', ${JSON.stringify(n).replace(/'/g,"\\'")},'${escapeHtml(a)}', ${i-1})">&#x2190; Back</button>`:"<div></div>"}\n      <button class="btn-auth" id="wf-next-btn" onclick="submitWorkflowStep('${t}', ${i}, '${escapeHtml(a)}')" style="min-width:120px;">\n        ${i===n.length-1?"Generate &#x2192;":"Next &#x2192;"}\n      </button>\n    </div>\n  </div>`;e.innerHTML=s}async function submitWorkflowStep(e,t,n){const a=document.getElementById("wf-step-input").value.trim();if(!a)return void alert("Please fill in this step before continuing.");const i=document.getElementById("wf-next-btn");i.disabled=!0,i.textContent="Processing...";try{const i=await fetch("/api/workflows/"+e+"/step",{method:"POST",headers:authHeaders(),body:JSON.stringify({stepIndex:t,input:a})}),o=await i.json();if(!i.ok)throw new Error(o.error);if(o.completed){document.getElementById("workflow-modal").classList.remove("active");openArtifactPanel({type:"document",title:n,content:o.output})}else{const a=await fetch("/api/workflows/"+e,{headers:authHeaders()}),{workflow:i}=await a.json(),s=JSON.parse(i.steps||"[]");if(renderWorkflowStep(document.getElementById("workflow-modal-body"),e,s,n,t+1),o.nextHint){const e=document.getElementById("wf-hint");e&&(e.innerHTML="<strong>Tip:</strong> "+escapeHtml(o.nextHint))}}}catch(e){alert(e.message||"Step submission failed"),i.disabled=!1,i.textContent="Next &#x2192;"}}function openMeetingAssistant(){requireAuth(async()=>{let e=document.getElementById("meeting-modal");e||(e=document.createElement("div"),e.id="meeting-modal",e.className="modal-overlay",e.addEventListener("click",t=>{t.target===e&&e.classList.remove("active")}),document.body.appendChild(e)),e.innerHTML='<div class="modal" style="max-width:700px;">\n      <div class="modal-header">\n        <h3>&#x1F3A4; Meeting Assistant</h3>\n        <button class="modal-close" onclick="document.getElementById(\'meeting-modal\').classList.remove(\'active\')">&#x2715;</button>\n      </div>\n      <div class="modal-body" id="meeting-modal-body" style="padding:20px;"></div>\n    </div>';let t='<div class="meeting-upload-area" id="meeting-upload-area">\n      <div style="text-align:center;padding:30px 20px;border:2px dashed var(--border-color);border-radius:var(--radius);cursor:pointer;" onclick="document.getElementById(\'meeting-audio-input\').click()">\n        <div style="font-size:40px;margin-bottom:8px;">&#x1F399;&#xFE0F;</div>\n        <p style="font-size:14px;color:var(--text-primary);font-weight:600;">Upload Meeting Recording</p>\n        <p style="font-size:12px;color:var(--text-muted);">MP3, WAV, M4A, OGG ‚Äî Max 25MB</p>\n        <input type="file" id="meeting-audio-input" accept="audio/*" style="display:none;" onchange="uploadMeetingAudio(this.files[0])" />\n      </div>\n    </div>';t+='<div id="meeting-list-area" style="margin-top:20px;"></div>',document.getElementById("meeting-modal-body").innerHTML='<div class="meeting-upload-area" id="meeting-upload-area">\n      <div style="text-align:center;padding:30px 20px;border:2px dashed var(--border-color);border-radius:var(--radius);cursor:pointer;" onclick="document.getElementById(\'meeting-audio-input\').click()">\n        <div style="font-size:40px;margin-bottom:8px;">&#x1F399;&#xFE0F;</div>\n        <p style="font-size:14px;color:var(--text-primary);font-weight:600;">Upload Meeting Recording</p>\n        <p style="font-size:12px;color:var(--text-muted);">MP3, WAV, M4A, OGG ‚Äî Max 25MB</p>\n        <input type="file" id="meeting-audio-input" accept="audio/*" style="display:none;" onchange="uploadMeetingAudio(this.files[0])" />\n      </div>\n    </div><div id="meeting-list-area" style="margin-top:20px;"></div>',e.classList.add("active");try{const e=await fetch("/api/meetings",{headers:authHeaders()}),{meetings:t}=await e.json();if(t.length>0){let e='<h4 style="font-size:14px;margin:0 0 12px;">Previous Meetings</h4>';for(const n of t){const t="completed"===n.status?"&#x2705;":"transcribed"===n.status?"&#x1F4DD;":"&#x23F3;";e+=`<div class="meeting-item" onclick="openMeetingDetail('${n.id}')">\n            <span>${t}</span>\n            <span class="meeting-item-title">${escapeHtml(n.title)}</span>\n            <span class="meeting-item-date">${new Date(n.created_at).toLocaleDateString()}</span>\n          </div>`}document.getElementById("meeting-list-area").innerHTML=e}}catch{}})}async function uploadMeetingAudio(e){if(!e)return;if(e.size>26214400)return void alert("Audio file must be under 25MB");const t=document.getElementById("meeting-upload-area");t.innerHTML='<div style="text-align:center;padding:30px;"><div class="typing-indicator"><span></span><span></span><span></span></div><p style="margin-top:12px;color:var(--text-muted);">Transcribing audio... This may take a moment.</p></div>';const n=prompt("Meeting title:",e.name.replace(/\.[^.]+$/,""))||e.name;try{const a=new FormData;a.append("audio",e),a.append("title",n);const i=await fetch("/api/meetings/upload",{method:"POST",headers:{Authorization:"Bearer "+state.token},body:a});if(!i.ok){const e=await i.json();if("TIER_REQUIRED"===e.code)return void(t.innerHTML='<div style="text-align:center;padding:20px;"><p style="color:var(--text-secondary);">Meeting Assistant requires a Professional plan.</p><button class="btn-auth" onclick="openPricingModal()" style="margin-top:12px;">View Plans</button></div>');throw new Error(e.error)}const o=await i.json();t.innerHTML=`<div style="padding:16px;background:var(--bg-tertiary);border-radius:var(--radius);margin-bottom:12px;">\n      <h4 style="margin:0 0 8px;">&#x2705; Transcription Complete</h4>\n      <div style="max-height:200px;overflow-y:auto;font-size:13px;color:var(--text-secondary);line-height:1.6;padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">${escapeHtml(o.transcript.substring(0,2e3))}${o.transcript.length>2e3?"...":""}</div>\n      <button class="btn-auth" onclick="generateMinutes('${o.meetingId}')" style="margin-top:12px;width:100%;">Generate Meeting Minutes</button>\n    </div>`}catch(e){t.innerHTML=`<div style="color:var(--red-error-text);padding:20px;text-align:center;">${escapeHtml(e.message)}</div>`}}async function generateMinutes(e){const t=document.getElementById("meeting-upload-area");t.innerHTML='<div style="text-align:center;padding:30px;"><div class="typing-indicator"><span></span><span></span><span></span></div><p style="margin-top:12px;color:var(--text-muted);">Generating minutes and extracting action items...</p></div>';try{const t=await fetch("/api/meetings/"+e+"/minutes",{method:"POST",headers:authHeaders()}),n=await t.json();if(!t.ok)throw new Error(n.error);document.getElementById("meeting-modal").classList.remove("active");if(openArtifactPanel({type:"document",title:"Meeting Minutes",content:n.minutes}),n.actionItems&&n.actionItems.length>0){let e="**Meeting Minutes Generated**\n\n**Action Items:**\n";n.actionItems.forEach((t,n)=>{e+=`${n+1}. ${t.action} ‚Äî *${t.assignee||"TBD"}* (${t.deadline||"TBD"})\n`}),state.activeConversationId&&(state.messages.push({role:"assistant",content:e}),renderMessages())}}catch(e){t.innerHTML=`<div style="color:var(--red-error-text);padding:20px;">${escapeHtml(e.message)}</div>`}}async function openMeetingDetail(e){try{const t=await fetch("/api/meetings/"+e,{headers:authHeaders()}),{meeting:n}=await t.json();if(n.minutes){document.getElementById("meeting-modal").classList.remove("active");openArtifactPanel({type:"document",title:n.title+" ‚Äî Minutes",content:n.minutes})}else n.transcript&&(document.getElementById("meeting-upload-area").innerHTML=`\n        <div style="padding:16px;background:var(--bg-tertiary);border-radius:var(--radius);">\n          <h4 style="margin:0 0 8px;">${escapeHtml(n.title)}</h4>\n          <div style="max-height:200px;overflow-y:auto;font-size:13px;color:var(--text-secondary);line-height:1.6;padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">${escapeHtml(n.transcript.substring(0,2e3))}</div>\n          <button class="btn-auth" onclick="generateMinutes('${e}')" style="margin-top:12px;width:100%;">Generate Meeting Minutes</button>\n        </div>`)}catch{alert("Failed to load meeting")}}async function openSpaces(){requireAuth(async()=>{let e=document.getElementById("spaces-modal");e||(e=document.createElement("div"),e.id="spaces-modal",e.className="modal-overlay",e.addEventListener("click",t=>{t.target===e&&e.classList.remove("active")}),document.body.appendChild(e)),e.innerHTML='<div class="modal" style="max-width:700px;">\n      <div class="modal-header">\n        <div><h3>&#x1F465; Collaborative Spaces</h3><p style="font-size:12px;color:var(--text-muted);margin:2px 0 0;">Share conversations and collaborate across departments</p></div>\n        <button class="modal-close" onclick="document.getElementById(\'spaces-modal\').classList.remove(\'active\')">&#x2715;</button>\n      </div>\n      <div class="modal-body" id="spaces-modal-body" style="padding:20px;">\n        <div style="text-align:center;padding:20px;color:var(--text-muted);">Loading...</div>\n      </div>\n    </div>',e.classList.add("active");try{const e=await fetch("/api/spaces",{headers:authHeaders()}),{spaces:t}=await e.json();let n='<button class="btn-auth" onclick="createSpaceForm()" style="margin-bottom:16px;">+ Create New Space</button>';if(n+='<div id="create-space-area"></div>',0===t.length)n+='<div style="text-align:center;padding:30px;color:var(--text-muted);"><p>No spaces yet. Create one to start collaborating!</p></div>';else{n+='<div class="spaces-list">';for(const e of t)n+=`<div class="space-card" onclick="openSpaceDetail('${e.id}')">\n            <div class="space-card-header">\n              <span class="space-name">${escapeHtml(e.name)}</span>\n              <span class="space-role">${e.role}</span>\n            </div>\n            <div class="space-card-meta">${e.member_count} members &middot; ${e.conversation_count} conversations</div>\n            ${e.description?`<div class="space-desc">${escapeHtml(e.description)}</div>`:""}\n          </div>`;n+="</div>"}document.getElementById("spaces-modal-body").innerHTML=n}catch{document.getElementById("spaces-modal-body").innerHTML='<p style="color:var(--red-error-text);">Failed to load spaces.</p>'}})}function createSpaceForm(){document.getElementById("create-space-area").innerHTML='<div style="padding:16px;background:var(--bg-tertiary);border-radius:var(--radius);margin-bottom:16px;">\n    <div class="form-group"><label>Space Name</label><input type="text" id="new-space-name" placeholder="e.g. Budget Committee 2025" /></div>\n    <div class="form-group"><label>Description</label><input type="text" id="new-space-desc" placeholder="Brief description (optional)" /></div>\n    <div style="display:flex;gap:8px;"><button class="btn-auth" onclick="createSpace()">Create</button><button class="btn-template-picker" onclick="document.getElementById(\'create-space-area\').innerHTML=\'\'">Cancel</button></div>\n  </div>'}async function createSpace(){const e=document.getElementById("new-space-name").value.trim(),t=document.getElementById("new-space-desc").value.trim();if(e)try{const n=await fetch("/api/spaces",{method:"POST",headers:authHeaders(),body:JSON.stringify({name:e,description:t})}),a=await n.json();if(!n.ok){if("TIER_REQUIRED"===a.code)return void openPricingModal();throw new Error(a.error)}openSpaces()}catch(e){alert(e.message||"Failed to create space")}else alert("Space name is required")}async function openSpaceDetail(e){try{const t=await fetch("/api/spaces/"+e,{headers:authHeaders()}),n=await t.json();if(!t.ok)throw new Error(n.error);const a=document.getElementById("spaces-modal-body");let i='<button class="btn-template-picker" onclick="openSpaces()" style="margin-bottom:16px;">&#x2190; Back to Spaces</button>';i+=`<h3 style="margin:0 0 4px;">${escapeHtml(n.space.name)}</h3>`,n.space.description&&(i+=`<p style="font-size:13px;color:var(--text-muted);margin:0 0 16px;">${escapeHtml(n.space.description)}</p>`),i+=`<h4 style="font-size:14px;margin:16px 0 8px;">Members (${n.members.length})</h4>`,i+='<div class="space-members">';for(const e of n.members)i+=`<div class="space-member"><span class="member-name">${escapeHtml(e.full_name)}</span><span class="member-role">${e.role}</span>${e.department?`<span class="member-dept">${escapeHtml(e.department)}</span>`:""}</div>`;if(i+="</div>","admin"===n.userRole&&(i+=`<div style="margin-top:12px;display:flex;gap:8px;"><input type="email" id="invite-email" placeholder="Email to invite" style="flex:1;padding:8px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);font-size:13px;" /><button class="btn-auth" onclick="inviteToSpace('${e}')">Invite</button></div>`),i+=`<h4 style="font-size:14px;margin:20px 0 8px;">Shared Conversations (${n.conversations.length})</h4>`,0===n.conversations.length)i+='<p style="font-size:13px;color:var(--text-muted);">No conversations shared yet. Use the Share button in chat to add one.</p>';else for(const e of n.conversations)i+=`<div class="space-conversation" onclick="loadConversation('${e.conversation_id}'); document.getElementById('spaces-modal').classList.remove('active');">\n          <span>${escapeHtml(e.title||"Untitled")}</span>\n          <span class="space-conv-meta">by ${escapeHtml(e.shared_by_name)} &middot; ${new Date(e.shared_at).toLocaleDateString()}</span>\n        </div>`;state.activeConversationId&&(i+=`<button class="btn-template-picker" onclick="shareToSpace('${e}')" style="margin-top:12px;">&#x1F517; Share Current Conversation</button>`),a.innerHTML=i}catch(e){alert(e.message||"Failed to load space")}}async function inviteToSpace(e){const t=document.getElementById("invite-email").value.trim();if(t)try{const n=await fetch("/api/spaces/"+e+"/invite",{method:"POST",headers:authHeaders(),body:JSON.stringify({email:t,role:"member"})}),a=await n.json();if(!n.ok)throw new Error(a.error);document.getElementById("invite-email").value="",openSpaceDetail(e)}catch(e){alert(e.message)}}async function shareToSpace(e){if(state.activeConversationId)try{const t=await fetch("/api/spaces/"+e+"/share-conversation",{method:"POST",headers:authHeaders(),body:JSON.stringify({conversationId:state.activeConversationId})}),n=await t.json();if(!t.ok)throw new Error(n.error);alert("Conversation shared to space!"),openSpaceDetail(e)}catch(e){alert(e.message)}}async function checkUpgradeNudge(){if(state.user&&"free"===state.user.tier)try{const e=await fetch("/api/usage/nudge",{headers:authHeaders()}),t=await e.json();t.nudge?showUpgradeNudge(t.nudge):hideUpgradeNudge()}catch{}}function showUpgradeNudge(e){let t=document.getElementById("upgrade-nudge");if(!t){t=document.createElement("div"),t.id="upgrade-nudge",t.className="upgrade-nudge";const e=document.querySelector(".input-area");e&&e.parentNode.insertBefore(t,e)}const n=Math.round(e.used/e.limit*100);t.innerHTML=`\n    <div class="nudge-progress">\n      <div class="nudge-bar" style="width:${n}%"></div>\n    </div>\n    <div class="nudge-content">\n      <span class="nudge-icon">‚ö°</span>\n      <span class="nudge-text">${escapeHtml(e.message)}</span>\n      <button class="nudge-upgrade-btn" onclick="openPricingModal()">Upgrade</button>\n      <button class="nudge-dismiss" onclick="hideUpgradeNudge()">√ó</button>\n    </div>\n  `,t.classList.add("visible")}function hideUpgradeNudge(){const e=document.getElementById("upgrade-nudge");e&&e.classList.remove("visible")}async function checkReferralLanding(){const e=new URLSearchParams(window.location.search).get("ref");if(e&&!state.user&&!sessionStorage.getItem("ref_landing_shown"))try{const t=await fetch(`/api/referral/info?code=${encodeURIComponent(e)}`),n=await t.json();if(!n.valid)return;sessionStorage.setItem("ref_landing_shown","1"),showReferralLanding(n,e)}catch{}}function showReferralLanding(e,t){const n=document.createElement("div");n.className="referral-landing-overlay",n.id="referral-landing";const a=(e.referrerName||"").split(" ")[0]||"A colleague";n.innerHTML=`\n    <div class="referral-landing-card">\n      <div class="referral-landing-flag">\n        <div class="referral-flag-stripe" style="background:#CE1126;"></div>\n        <div class="referral-flag-stripe" style="background:#FCD116;"></div>\n        <div class="referral-flag-stripe" style="background:#006B3F;"></div>\n      </div>\n      <div class="referral-landing-body">\n        <div class="referral-landing-badge">INVITED BY ${escapeHtml(a.toUpperCase())}</div>\n        <h1 class="referral-landing-title">Welcome to <span>AskOzzy</span></h1>\n        <p class="referral-landing-subtitle">Ghana's AI-Powered Productivity Platform for Government</p>\n\n        <div class="referral-landing-features">\n          <div class="referral-feature-item">\n            <span class="referral-feature-icon">ü§ñ</span>\n            <span>11 AI Models for every task</span>\n          </div>\n          <div class="referral-feature-item">\n            <span class="referral-feature-icon">üìù</span>\n            <span>Generate memos, briefs & reports</span>\n          </div>\n          <div class="referral-feature-item">\n            <span class="referral-feature-icon">üîç</span>\n            <span>Deep Research with citations</span>\n          </div>\n          <div class="referral-feature-item">\n            <span class="referral-feature-icon">üìä</span>\n            <span>Data analysis with charts</span>\n          </div>\n          <div class="referral-feature-item">\n            <span class="referral-feature-icon">üó£Ô∏è</span>\n            <span>Voice input in Twi, Ga, Ewe & more</span>\n          </div>\n          <div class="referral-feature-item">\n            <span class="referral-feature-icon">üá¨üá≠</span>\n            <span>Built in Ghana, for Ghana</span>\n          </div>\n        </div>\n\n        <div class="referral-landing-cta">\n          <button class="referral-cta-btn" onclick="closeReferralLanding()">\n            Get Started Free\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>\n          </button>\n          <div class="referral-cta-sub">Free forever ‚Ä¢ No credit card needed</div>\n        </div>\n\n        <div class="referral-landing-referrer">\n          <div class="referral-referrer-avatar">${escapeHtml(a.charAt(0))}</div>\n          <div>\n            <div class="referral-referrer-name">${escapeHtml(e.referrerName||a)}</div>\n            <div class="referral-referrer-dept">${e.referrerDepartment?escapeHtml(e.referrerDepartment):"Government of Ghana"}</div>\n          </div>\n        </div>\n      </div>\n    </div>\n  `,document.body.appendChild(n),requestAnimationFrame(()=>n.classList.add("active"))}function closeReferralLanding(){const e=document.getElementById("referral-landing");e&&(e.classList.remove("active"),setTimeout(()=>e.remove(),300))}async function activateFreeTrial(){try{const e=await fetch("/api/trial/activate",{method:"POST",headers:authHeaders()}),t=await e.json();if(!e.ok)return void alert(t.error||"Could not activate trial");state.user.trialExpiresAt=t.expiresAt,state.user.tier="professional",localStorage.setItem("askozzy_user",JSON.stringify(state.user)),closePricingModal(),showTrialActivatedToast(),updateSidebarFooter(),loadUsageStatus()}catch{alert("Failed to activate trial. Please try again.")}}function showTrialActivatedToast(){const e=document.createElement("div");e.className="trial-toast",e.innerHTML='\n    <div class="trial-toast-icon">üéâ</div>\n    <div>\n      <div class="trial-toast-title">Professional Trial Activated!</div>\n      <div class="trial-toast-sub">You have 3 days of full access. Enjoy all 11 AI models and premium features.</div>\n    </div>\n  ',document.body.appendChild(e),requestAnimationFrame(()=>e.classList.add("visible")),setTimeout(()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300)},5e3)}function getOnboardingSteps(){const e=isStudent();return[{target:".sidebar",title:"Your Sidebar",text:"All your conversations, folders, and tools live here. Click the + button to start a new chat.",position:"right"},{target:"#chat-input",title:e?"Ask Ozzy Anything":"Chat with AI",text:e?"Ask study questions, get essay help, or review for exams. Ozzy is your personal tutor.":"Type your question or paste a document. Ozzy understands memos, reports, and complex queries.",position:"top"},{target:"#model-selector",title:"Choose Your AI Model",text:"Switch between 11 AI models. Each has different strengths ‚Äî try a few to find your favorite.",position:"top"},{target:".template-grid",title:e?"Study Templates":"GoG Templates",text:e?"40+ templates for essays, exam prep, study plans, research, and more. Click any to start.":"25+ ready-made templates for memos, procurement, HR, and more. Click any to start.",position:"bottom"},{target:"#voice-btn-large",title:"Voice Input",text:"Tap to speak in English, Twi, Ga, Ewe, or Hausa. Ozzy understands your language.",position:"top"},{target:".input-tools",title:"Smart Tools",text:"Research, Data Analysis, Web Search, Workflows ‚Äî powerful tools at your fingertips.",position:"top"}]}function startEnhancedOnboarding(){localStorage.getItem("ozzy_onboarding_v2_done")||localStorage.getItem("askozzy_onboarding_done")||state.user&&setTimeout(()=>showEnhancedOnboardingStep(0,getOnboardingSteps()),1200)}function showEnhancedOnboardingStep(e,t){t||(t=getOnboardingSteps());const n=document.getElementById("onboarding-overlay-v2");if(n&&n.remove(),e>=t.length)return void localStorage.setItem("ozzy_onboarding_v2_done","1");const a=t[e],i=document.querySelector(a.target),o=document.createElement("div");if(o.className="onboarding-overlay-v2",o.id="onboarding-overlay-v2",i){const e=i.getBoundingClientRect(),t=document.createElement("div");t.className="onboarding-spotlight-v2",t.style.cssText=`top:${e.top-6}px;left:${e.left-6}px;width:${e.width+12}px;height:${e.height+12}px;`,o.appendChild(t)}const s=document.createElement("div");if(s.className=`onboarding-tooltip-v2 position-${a.position}`,i){const e=i.getBoundingClientRect();switch(a.position){case"right":s.style.top=Math.max(10,e.top+e.height/2-60)+"px",s.style.left=Math.min(e.right+16,window.innerWidth-300)+"px";break;case"left":s.style.top=Math.max(10,e.top+e.height/2-60)+"px",s.style.left=Math.max(10,e.left-296)+"px";break;case"top":s.style.top=Math.max(10,e.top-180)+"px",s.style.left=Math.max(10,Math.min(e.left+e.width/2-140,window.innerWidth-300))+"px";break;case"bottom":s.style.top=e.bottom+16+"px",s.style.left=Math.max(10,Math.min(e.left+e.width/2-140,window.innerWidth-300))+"px"}}else s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)";s.innerHTML=`\n    <div class="onboarding-step-count-v2">${e+1} of ${t.length}</div>\n    <div class="onboarding-title-v2">${a.title}</div>\n    <div class="onboarding-text-v2">${a.text}</div>\n    <div class="onboarding-actions-v2">\n      <button class="onboarding-skip-v2" onclick="skipEnhancedOnboarding()">Skip tour</button>\n      <button class="onboarding-next-v2" onclick="showEnhancedOnboardingStep(${e+1}, getOnboardingSteps())">\n        ${e===t.length-1?"Finish":"Next"}\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>\n      </button>\n    </div>\n    <div class="onboarding-dots-v2">\n      ${t.map((t,n)=>`<span class="onboarding-dot-v2 ${n===e?"active":""} ${n<e?"done":""}"></span>`).join("")}\n    </div>\n  `,o.appendChild(s),document.body.appendChild(o),o.addEventListener("click",n=>{n.target===o&&showEnhancedOnboardingStep(e+1,t)})}function skipEnhancedOnboarding(){localStorage.setItem("ozzy_onboarding_v2_done","1");const e=document.getElementById("onboarding-overlay-v2");e&&e.remove()}async function loadStreakData(){if(state.user)try{const e=await fetch("/api/streaks",{headers:authHeaders()});if(!e.ok)return;const t=await e.json();state.streakData=t,renderStreakBadge()}catch{}}function renderStreakBadge(){const e=state.streakData;if(!e)return;let t=document.getElementById("streak-badge");const n=document.getElementById("streak-badge-container");if(!t&&n&&(t=document.createElement("button"),t.id="streak-badge",t.className="streak-badge",t.onclick=openStreakModal,n.appendChild(t)),!t)return;const a=e.currentStreak||0,i=a>=3?"üî•":"‚ú®";t.innerHTML=`<span class="streak-fire">${i}</span><span class="streak-count">${a}</span>`,t.title=`${a}-day streak! Click to view achievements`,a>=7?t.classList.add("hot"):t.classList.remove("hot")}function openStreakModal(){const e=state.streakData;if(!e)return;const t=[{id:"streak_3",icon:"üî•",name:"3-Day Streak",desc:"Use AskOzzy 3 days in a row"},{id:"streak_7",icon:"üí™",name:"7-Day Streak",desc:"A full week of productivity"},{id:"streak_14",icon:"‚ö°",name:"14-Day Streak",desc:"Two weeks strong!"},{id:"streak_30",icon:"üèÜ",name:"30-Day Streak",desc:"An entire month ‚Äî you're a champion"},{id:"messages_10",icon:"üí¨",name:"Getting Started",desc:"Send 10 messages"},{id:"messages_50",icon:"üìù",name:"Active User",desc:"Send 50 messages"},{id:"messages_100",icon:"üß†",name:"Power User",desc:"Send 100 messages"},{id:"messages_500",icon:"üåü",name:"AskOzzy Expert",desc:"Send 500 messages"},{id:"referral_1",icon:"ü§ù",name:"First Referral",desc:"Refer your first colleague"},{id:"referral_5",icon:"üì¢",name:"Influencer",desc:"Refer 5 colleagues"},{id:"referral_10",icon:"üèÖ",name:"Ambassador",desc:"Refer 10 colleagues"}],n=e.badges||[];let a=document.getElementById("streak-modal");a||(a=document.createElement("div"),a.className="modal-overlay",a.id="streak-modal",a.addEventListener("click",e=>{e.target===a&&a.classList.remove("active")}),document.body.appendChild(a)),a.innerHTML=`\n    <div class="modal streak-modal-box">\n      <div class="modal-header">\n        <h3>Achievements & Streaks</h3>\n        <button class="modal-close" onclick="document.getElementById('streak-modal').classList.remove('active')">‚úï</button>\n      </div>\n      <div class="modal-body" style="padding:24px;">\n        \x3c!-- Streak Card --\x3e\n        <div class="streak-hero">\n          <div class="streak-hero-fire">${e.currentStreak>=3?"üî•":"‚ú®"}</div>\n          <div class="streak-hero-count">${e.currentStreak||0}</div>\n          <div class="streak-hero-label">Day Streak</div>\n          <div class="streak-hero-sub">Longest: ${e.longestStreak||0} days ‚Ä¢ ${e.totalConversations||0} total conversations</div>\n        </div>\n\n        \x3c!-- Badges Grid --\x3e\n        <div class="streak-badges-title">Badges (${n.length}/${t.length})</div>\n        <div class="streak-badges-grid">\n          ${t.map(e=>{const t=n.includes(e.id);return`<div class="streak-badge-card ${t?"earned":"locked"}">\n              <div class="streak-badge-icon">${t?e.icon:"üîí"}</div>\n              <div class="streak-badge-name">${e.name}</div>\n              <div class="streak-badge-desc">${e.desc}</div>\n            </div>`}).join("")}\n        </div>\n      </div>\n    </div>\n  `,a.classList.add("active")}function renderFollowUpSuggestions(e){const t=document.querySelector(".followup-suggestions");t&&t.remove();const n=document.createElement("div");n.className="followup-suggestions",n.innerHTML=`\n    <div class="followup-label">Follow up:</div>\n    <div class="followup-chips">\n      ${e.map(e=>`<button class="followup-chip" onclick="sendFollowUp(this)">${escapeHtml(e)}</button>`).join("")}\n    </div>\n  `;const a=document.getElementById("chat-messages");a&&(a.appendChild(n),scrollToBottom())}function sendFollowUp(e){const t=e.textContent,n=e.closest(".followup-suggestions");n&&n.remove();const a=document.getElementById("chat-input");a&&(a.value=t,autoResizeInput(),updateSendButton(),sendMessage())}function openCitizenBot(){const e=document.querySelector(".citizen-bot-fab");let t=document.getElementById("citizen-bot");if(t){const n=t.classList.toggle("active");return void(e&&e.classList.toggle("open",n))}t=document.createElement("div"),t.id="citizen-bot",t.className="citizen-bot active",t.innerHTML='\n    <div class="citizen-header">\n      <div class="citizen-title">\n        <div class="citizen-logo">\n          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>\n        </div>\n        <div>\n          <strong>Ozzy Citizen</strong>\n          <div class="citizen-subtitle">\n            <span class="citizen-status-dot"></span> Online &middot; Government Services\n          </div>\n        </div>\n      </div>\n      <div class="citizen-header-actions">\n        <select id="citizen-lang" class="citizen-lang-chip" onchange="citizenState.language = this.value">\n          <option value="en">EN</option>\n          <option value="tw">Twi</option>\n          <option value="ha">Hausa</option>\n          <option value="ee">Ewe</option>\n          <option value="ga">Ga</option>\n          <option value="dag">Dagbani</option>\n          <option value="fr">FR</option>\n        </select>\n        <button class="citizen-close" onclick="document.getElementById(\'citizen-bot\').classList.remove(\'active\')" aria-label="Close">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>\n        </button>\n      </div>\n    </div>\n    <div class="citizen-messages" id="citizen-messages">\n      <div class="citizen-msg bot">\n        <div class="citizen-avatar">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>\n        </div>\n        <div class="citizen-msg-content">\n          <div class="citizen-msg-bubble">Hello! I\'m <strong>Ozzy</strong>, your digital assistant for government services.</div>\n          <div class="citizen-quick-actions">\n            <button onclick="document.getElementById(\'citizen-input\').value=\'How do I get a passport?\';sendCitizenMessage()">Passports</button>\n            <button onclick="document.getElementById(\'citizen-input\').value=\'How do I check my SSNIT pension?\';sendCitizenMessage()">Pensions</button>\n            <button onclick="document.getElementById(\'citizen-input\').value=\'How do I file my taxes?\';sendCitizenMessage()">Taxes</button>\n            <button onclick="document.getElementById(\'citizen-input\').value=\'How do I get a Ghana Card?\';sendCitizenMessage()">Ghana Card</button>\n          </div>\n        </div>\n      </div>\n    </div>\n    <div class="citizen-input-area">\n      <input type="text" id="citizen-input" placeholder="Type your question..." onkeydown="if(event.key===\'Enter\')sendCitizenMessage()" />\n      <button class="citizen-send-btn" onclick="sendCitizenMessage()" aria-label="Send">\n        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>\n      </button>\n    </div>\n    <div class="citizen-footer">Powered by AskOzzy AI</div>',document.body.appendChild(t),document.querySelector(".citizen-bot-fab")?.classList.add("open")}!function(){if(!document.startViewTransition)return;const e=window.showChatScreen;"function"==typeof e&&(window.showChatScreen=function(){document.startViewTransition(()=>e.apply(this,arguments))});const t=window.showWelcomeScreen;"function"==typeof t&&(window.showWelcomeScreen=function(){document.startViewTransition(()=>t.apply(this,arguments))});const n=window.openConversation;"function"==typeof n&&(window.openConversation=function(){document.startViewTransition(()=>n.apply(this,arguments))})}(),document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("chat-input");e&&e.addEventListener("paste",function(e){var t=e.clipboardData&&e.clipboardData.items;if(t)for(var n=0;n<t.length;n++)if(0===t[n].type.indexOf("image/")){e.preventDefault();var a=t[n].getAsFile();a&&"function"==typeof handleImageFile&&handleImageFile(a);break}})}),document.addEventListener("DOMContentLoaded",function(){var e=localStorage.getItem("askozzy_draft");if(e)try{var t=JSON.parse(e),n=t.text,a=t.timestamp;if(Date.now()-a>864e5)return void localStorage.removeItem("askozzy_draft");var i=document.getElementById("chat-input");i&&!i.value&&(i.value=n,"function"==typeof autoResizeInput&&autoResizeInput(),showSyncToast("Draft restored"))}catch{localStorage.removeItem("askozzy_draft")}}),document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){PushManager.init()},5e3),initIdleDetection();var e="askozzy_conv_count",t=parseInt(localStorage.getItem(e)||"0",10);state.conversations&&state.conversations.length>t&&localStorage.setItem(e,String(state.conversations.length)),navigator.serviceWorker&&navigator.serviceWorker.addEventListener("message",function(e){e.data&&"NAVIGATE"===e.data.type&&(window.location.href=e.data.url)})}),function(){const e=new URLSearchParams(window.location.search),t=e.get("ref");t&&(localStorage.setItem("askozzy_pending_ref",t),window.history.replaceState({},"",window.location.pathname));const n=openAuthModal;openAuthModal=function(){n();const e=localStorage.getItem("askozzy_pending_ref");if(e){const t=document.getElementById("reg-referral");t&&(t.value=e)}};"new-chat"===e.get("action")&&(window.history.replaceState({},"",window.location.pathname),document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>requireAuth(createNewChat),500)}))}(),"success"===new URLSearchParams(window.location.search).get("payment")&&(window.history.replaceState({},"","/"),setTimeout(()=>{isLoggedIn()&&(loadUsageStatus(),showPaymentSuccess("your new plan"))},500)),function(){const e=new URLSearchParams(window.location.search).get("shared");e&&(window.history.replaceState({},"","/"),loadSharedConversation(e))}();const citizenState={sessionId:null,language:"en"};async function sendCitizenMessage(){const e=document.getElementById("citizen-input"),t=e.value.trim();if(!t)return;e.value="";const n=document.getElementById("citizen-messages"),a=document.createElement("div");a.className="citizen-msg user",a.innerHTML=`<div class="citizen-msg-content"><div class="citizen-msg-bubble">${escapeHtml(t)}</div></div>`,n.appendChild(a),n.scrollTop=n.scrollHeight;const i=document.createElement("div");i.className="citizen-msg bot",i.innerHTML='<div class="citizen-avatar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div><div class="citizen-msg-content"><div class="citizen-msg-bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>',n.appendChild(i),n.scrollTop=n.scrollHeight;try{const e=await fetch("/api/citizen/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:citizenState.sessionId,message:t,language:citizenState.language})}),a=await e.json();if(!e.ok)throw new Error(a.error);citizenState.sessionId=a.sessionId,i.remove();const o=document.createElement("div");o.className="citizen-msg bot",o.innerHTML=`<div class="citizen-avatar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div><div class="citizen-msg-content"><div class="citizen-msg-bubble">${renderMarkdown(a.response)}</div></div>`,n.appendChild(o),n.scrollTop=n.scrollHeight}catch(e){i.remove();const t=document.createElement("div");t.className="citizen-msg bot",t.innerHTML='<div class="citizen-avatar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div><div class="citizen-msg-content"><div class="citizen-msg-bubble" style="color:var(--red-error-text);">Sorry, I\'m temporarily unavailable. Please try again.</div></div>',n.appendChild(t)}}